# =======================================================
# ESPHome Configuration for WaveShare P4 Panel Box
# THEME: Modern Quad-Dashboard (Integer Math Fix)
# RESOLUTION: 720x720
# =======================================================
substitutions:
  # Set rotation: "0", "90", "180", or "270"
  display_rotation: "180"

esphome:
  name: waveshare-p4-box
  friendly_name: WaveShare P4 Box
  name_add_mac_suffix: false

esp32:
  board: esp32-p4-evboard
  flash_size: 32MB
  framework:
    type: esp-idf
    version: recommended
    advanced:
      enable_idf_experimental_features: true
  cpu_frequency: 360MHz

logger:
  level: debug
  logs:
    lvgl: info
  hardware_uart: UART0

web_server:
  port: 80
  version: 3

psram:
  speed: 200MHz

esp_ldo:
  - channel: 3
    voltage: 2.5V

button:
  - platform: restart
    name: "WaveShare P4 Box"

# =======================================================
# Connectivity
# =======================================================
esp32_hosted:
  active_high: true
  variant: ESP32C6
  reset_pin: GPIO54
  cmd_pin: GPIO19
  clk_pin: GPIO18
  d0_pin: GPIO14
  d1_pin: GPIO15
  d2_pin: GPIO16
  d3_pin: GPIO17

wifi:
  # Global WiFi Settings
  power_save_mode: NONE
  fast_connect: True
  networks:
    - ssid: "IoT"
      password: "kkkkkkkk"


# =======================================================
# Display & Touch
# =======================================================
display:
  - platform: mipi_dsi
    model: WAVESHARE-P4-86-PANEL
    id: my_display
    rotation: ${display_rotation}

i2c:
  sda: GPIO7
  scl: GPIO8
  scan: true
  frequency: 400kHz
  id: i2c_bus

touchscreen:
  - platform: gt911
    id: touchscreen_
    on_touch:
      - lambda: |-
          // Initialize start position on new touch
          if (id(g_touch_start_x) == -1) {
            id(g_touch_start_x) = touch.x;
          } 
          // If tracking a touch (and not yet locked by a successful swipe)
          else if (id(g_touch_start_x) >= 0) {
            int delta = touch.x - id(g_touch_start_x);
            int threshold = 80; // Swipe threshold in pixels

            // SWIPE LEFT (Move to Next Page)
            if (delta < -threshold) {
               if (id(g_current_page) < 2) {
                  id(g_current_page) += 1;
               } else {
                  id(g_current_page) = 0; // Loop back to start
               }

               if (id(g_current_page) == 0) {
                  lv_scr_load_anim(id(main_page)->obj, LV_SCR_LOAD_ANIM_MOVE_LEFT, 300, 0, false);
               } else if (id(g_current_page) == 1) {
                  lv_scr_load_anim(id(nina2_page)->obj, LV_SCR_LOAD_ANIM_MOVE_LEFT, 300, 0, false);
               } else {
                  lv_scr_load_anim(id(nina3_page)->obj, LV_SCR_LOAD_ANIM_MOVE_LEFT, 300, 0, false);
               }
               
               id(g_touch_start_x) = -2; // Lock until release
            }
            // SWIPE RIGHT (Move to Previous Page)
            else if (delta > threshold) {
               if (id(g_current_page) > 0) {
                  id(g_current_page) -= 1;
               } else {
                  id(g_current_page) = 2; // Loop to end
               }

               if (id(g_current_page) == 0) {
                  lv_scr_load_anim(id(main_page)->obj, LV_SCR_LOAD_ANIM_MOVE_RIGHT, 300, 0, false);
               } else if (id(g_current_page) == 1) {
                  lv_scr_load_anim(id(nina2_page)->obj, LV_SCR_LOAD_ANIM_MOVE_RIGHT, 300, 0, false);
               } else {
                  lv_scr_load_anim(id(nina3_page)->obj, LV_SCR_LOAD_ANIM_MOVE_RIGHT, 300, 0, false);
               }

               id(g_touch_start_x) = -2; // Lock until release
            }
          }

# =======================================================
# Globals for Color Storage & Navigation
# =======================================================
globals:
  # Navigation Globals
  - id: g_touch_start_x
    type: int
    initial_value: '-1'
  - id: g_current_page
    type: int
    initial_value: '0'

  # CPU Colors
  - id: g_cpu_c1_r
    type: float
    restore_value: true
    initial_value: '0'
  - id: g_cpu_c1_g
    type: float
    restore_value: true
    initial_value: '255'
  - id: g_cpu_c1_b
    type: float
    restore_value: true
    initial_value: '0'
  - id: g_cpu_c2_r
    type: float
    restore_value: true
    initial_value: '255'
  - id: g_cpu_c2_g
    type: float
    restore_value: true
    initial_value: '0'
  - id: g_cpu_c2_b
    type: float
    restore_value: true
    initial_value: '0'

  # Fan Colors
  - id: g_fan_c1_r
    type: float
    restore_value: true
    initial_value: '173'
  - id: g_fan_c1_g
    type: float
    restore_value: true
    initial_value: '216'
  - id: g_fan_c1_b
    type: float
    restore_value: true
    initial_value: '230'
  - id: g_fan_c2_r
    type: float
    restore_value: true
    initial_value: '29'
  - id: g_fan_c2_g
    type: float
    restore_value: true
    initial_value: '78'
  - id: g_fan_c2_b
    type: float
    restore_value: true
    initial_value: '216'

  # Env Colors
  - id: g_env_c1_r
    type: float
    restore_value: true
    initial_value: '0'
  - id: g_env_c1_g
    type: float
    restore_value: true
    initial_value: '255'
  - id: g_env_c1_b
    type: float
    restore_value: true
    initial_value: '255'
  - id: g_env_c2_r
    type: float
    restore_value: true
    initial_value: '255'
  - id: g_env_c2_g
    type: float
    restore_value: true
    initial_value: '165'
  - id: g_env_c2_b
    type: float
    restore_value: true
    initial_value: '0'

  # Power Colors
  - id: g_pwr_c1_r
    type: float
    restore_value: true
    initial_value: '255'
  - id: g_pwr_c1_g
    type: float
    restore_value: true
    initial_value: '255'
  - id: g_pwr_c1_b
    type: float
    restore_value: true
    initial_value: '0'
  - id: g_pwr_c2_r
    type: float
    restore_value: true
    initial_value: '220'
  - id: g_pwr_c2_g
    type: float
    restore_value: true
    initial_value: '20'
  - id: g_pwr_c2_b
    type: float
    restore_value: true
    initial_value: '60'

  # SQM Colors
  - id: g_sqm_c1_r
    type: float
    restore_value: true
    initial_value: '255'
  - id: g_sqm_c1_g
    type: float
    restore_value: true
    initial_value: '0'
  - id: g_sqm_c1_b
    type: float
    restore_value: true
    initial_value: '0'
  - id: g_sqm_c2_r
    type: float
    restore_value: true
    initial_value: '0'
  - id: g_sqm_c2_g
    type: float
    restore_value: true
    initial_value: '255'
  - id: g_sqm_c2_b
    type: float
    restore_value: true
    initial_value: '0'

# =======================================================
# Outputs
# =======================================================
output:
  - platform: ledc
    id: backlight_
    pin: GPIO26
    frequency: 100Hz
    inverted: true
    min_power: 0.1
    max_power: 0.8

  # CPU Start Color
  - platform: template
    id: cpu_c1_r
    type: float
    write_action:
      - globals.set:
          id: g_cpu_c1_r
          value: !lambda 'return state * 255;'
  - platform: template
    id: cpu_c1_g
    type: float
    write_action:
      - globals.set:
          id: g_cpu_c1_g
          value: !lambda 'return state * 255;'
  - platform: template
    id: cpu_c1_b
    type: float
    write_action:
      - globals.set:
          id: g_cpu_c1_b
          value: !lambda 'return state * 255;'

  # CPU End Color
  - platform: template
    id: cpu_c2_r
    type: float
    write_action:
      - globals.set:
          id: g_cpu_c2_r
          value: !lambda 'return state * 255;'
  - platform: template
    id: cpu_c2_g
    type: float
    write_action:
      - globals.set:
          id: g_cpu_c2_g
          value: !lambda 'return state * 255;'
  - platform: template
    id: cpu_c2_b
    type: float
    write_action:
      - globals.set:
          id: g_cpu_c2_b
          value: !lambda 'return state * 255;'

  # Fan Start Color
  - platform: template
    id: fan_c1_r
    type: float
    write_action:
      - globals.set:
          id: g_fan_c1_r
          value: !lambda 'return state * 255;'
  - platform: template
    id: fan_c1_g
    type: float
    write_action:
      - globals.set:
          id: g_fan_c1_g
          value: !lambda 'return state * 255;'
  - platform: template
    id: fan_c1_b
    type: float
    write_action:
      - globals.set:
          id: g_fan_c1_b
          value: !lambda 'return state * 255;'

  # Fan End Color
  - platform: template
    id: fan_c2_r
    type: float
    write_action:
      - globals.set:
          id: g_fan_c2_r
          value: !lambda 'return state * 255;'
  - platform: template
    id: fan_c2_g
    type: float
    write_action:
      - globals.set:
          id: g_fan_c2_g
          value: !lambda 'return state * 255;'
  - platform: template
    id: fan_c2_b
    type: float
    write_action:
      - globals.set:
          id: g_fan_c2_b
          value: !lambda 'return state * 255;'

  # Env Start Color
  - platform: template
    id: env_c1_r
    type: float
    write_action:
      - globals.set:
          id: g_env_c1_r
          value: !lambda 'return state * 255;'
  - platform: template
    id: env_c1_g
    type: float
    write_action:
      - globals.set:
          id: g_env_c1_g
          value: !lambda 'return state * 255;'
  - platform: template
    id: env_c1_b
    type: float
    write_action:
      - globals.set:
          id: g_env_c1_b
          value: !lambda 'return state * 255;'

  # Env End Color
  - platform: template
    id: env_c2_r
    type: float
    write_action:
      - globals.set:
          id: g_env_c2_r
          value: !lambda 'return state * 255;'
  - platform: template
    id: env_c2_g
    type: float
    write_action:
      - globals.set:
          id: g_env_c2_g
          value: !lambda 'return state * 255;'
  - platform: template
    id: env_c2_b
    type: float
    write_action:
      - globals.set:
          id: g_env_c2_b
          value: !lambda 'return state * 255;'

  # Power Start Color
  - platform: template
    id: pwr_c1_r
    type: float
    write_action:
      - globals.set:
          id: g_pwr_c1_r
          value: !lambda 'return state * 255;'
  - platform: template
    id: pwr_c1_g
    type: float
    write_action:
      - globals.set:
          id: g_pwr_c1_g
          value: !lambda 'return state * 255;'
  - platform: template
    id: pwr_c1_b
    type: float
    write_action:
      - globals.set:
          id: g_pwr_c1_b
          value: !lambda 'return state * 255;'

  # Power End Color
  - platform: template
    id: pwr_c2_r
    type: float
    write_action:
      - globals.set:
          id: g_pwr_c2_r
          value: !lambda 'return state * 255;'
  - platform: template
    id: pwr_c2_g
    type: float
    write_action:
      - globals.set:
          id: g_pwr_c2_g
          value: !lambda 'return state * 255;'
  - platform: template
    id: pwr_c2_b
    type: float
    write_action:
      - globals.set:
          id: g_pwr_c2_b
          value: !lambda 'return state * 255;'

  # SQM Start Color
  - platform: template
    id: sqm_c1_r
    type: float
    write_action:
      - globals.set:
          id: g_sqm_c1_r
          value: !lambda 'return state * 255;'
  - platform: template
    id: sqm_c1_g
    type: float
    write_action:
      - globals.set:
          id: g_sqm_c1_g
          value: !lambda 'return state * 255;'
  - platform: template
    id: sqm_c1_b
    type: float
    write_action:
      - globals.set:
          id: g_sqm_c1_b
          value: !lambda 'return state * 255;'

  # SQM End Color
  - platform: template
    id: sqm_c2_r
    type: float
    write_action:
      - globals.set:
          id: g_sqm_c2_r
          value: !lambda 'return state * 255;'
  - platform: template
    id: sqm_c2_g
    type: float
    write_action:
      - globals.set:
          id: g_sqm_c2_g
          value: !lambda 'return state * 255;'
  - platform: template
    id: sqm_c2_b
    type: float
    write_action:
      - globals.set:
          id: g_sqm_c2_b
          value: !lambda 'return state * 255;'

# =======================================================
# Lights
# =======================================================
light:
  - platform: monochromatic
    name: "backlight"
    output: backlight_
    id: backlight_light
    restore_mode: ALWAYS_ON

  # Color picker lights for gradient configuration
  - platform: rgb
    name: "CPU Start Color"
    red: cpu_c1_r
    green: cpu_c1_g
    blue: cpu_c1_b
    restore_mode: RESTORE_DEFAULT_ON

  - platform: rgb
    name: "CPU End Color"
    red: cpu_c2_r
    green: cpu_c2_g
    blue: cpu_c2_b
    restore_mode: RESTORE_DEFAULT_ON

  - platform: rgb
    name: "Fan Start Color"
    red: fan_c1_r
    green: fan_c1_g
    blue: fan_c1_b
    restore_mode: RESTORE_DEFAULT_ON

  - platform: rgb
    name: "Fan End Color"
    red: fan_c2_r
    green: fan_c2_g
    blue: fan_c2_b
    restore_mode: RESTORE_DEFAULT_ON

  - platform: rgb
    name: "Env Start Color"
    red: env_c1_r
    green: env_c1_g
    blue: env_c1_b
    restore_mode: RESTORE_DEFAULT_ON

  - platform: rgb
    name: "Env End Color"
    red: env_c2_r
    green: env_c2_g
    blue: env_c2_b
    restore_mode: RESTORE_DEFAULT_ON

  - platform: rgb
    name: "Power Start Color"
    red: pwr_c1_r
    green: pwr_c1_g
    blue: pwr_c1_b
    restore_mode: RESTORE_DEFAULT_ON

  - platform: rgb
    name: "Power End Color"
    red: pwr_c2_r
    green: pwr_c2_g
    blue: pwr_c2_b
    restore_mode: RESTORE_DEFAULT_ON

  - platform: rgb
    name: "SQM Start Color"
    red: sqm_c1_r
    green: sqm_c1_g
    blue: sqm_c1_b
    restore_mode: RESTORE_DEFAULT_ON

  - platform: rgb
    name: "SQM End Color"
    red: sqm_c2_r
    green: sqm_c2_g
    blue: sqm_c2_b
    restore_mode: RESTORE_DEFAULT_ON

api:
  # encryption:
  #   key: !secret waveshare_api

ota:
  - platform: esphome
  #   password: !secret waveshare_ota

# =======================================================
# LVGL Font Configuration
# =======================================================
font:
  # Standard Text (Subtitles, Units)
  - file:
      type: gfonts
      family: Roboto
      weight: 400
    id: font_roboto_28
    size: 28
    bpp: 8
    glyphs: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.-°%/:_ #()\""

  # Card Headers
  - file:
      type: gfonts
      family: Roboto Condensed
      weight: 700
    id: font_header_40
    size: 40
    bpp: 8
    glyphs: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.- \""

  # Hero Values (Resized to 90 to fit Quadrants)
  - file:
      type: gfonts
      family: Roboto
      weight: 700
    id: font_roboto_hero
    size: 90
    bpp: 8
    # Added 'C' and 'W' for units
    glyphs: "0123456789.-°% finCWS"

# =======================================================
# CONFIGURABLE SETTINGS (Web UI)
# =======================================================
number:
  # --- CPU TEMP SETTINGS ---
  - platform: template
    name: "Set CPU Min Value"
    id: set_cpu_min
    optimistic: true
    min_value: 0
    max_value: 100
    initial_value: 20
    step: 1
    restore_value: true
  - platform: template
    name: "Set CPU Max Value"
    id: set_cpu_max
    optimistic: true
    min_value: 0
    max_value: 150
    initial_value: 80
    step: 1
    restore_value: true

  # --- FAN SETTINGS ---
  - platform: template
    name: "Set Fan Min Value"
    id: set_fan_min
    optimistic: true
    min_value: 0
    max_value: 1000
    initial_value: 0
    step: 100
    restore_value: true
  - platform: template
    name: "Set Fan Max Value"
    id: set_fan_max
    optimistic: true
    min_value: 0
    max_value: 8000
    initial_value: 5500
    step: 100
    restore_value: true

  # --- ENCLOSURE/AMBIENT SETTINGS ---
  - platform: template
    name: "Set Env Min Value"
    id: set_env_min
    optimistic: true
    min_value: -40
    max_value: 50
    initial_value: -10
    step: 1
    restore_value: true
  - platform: template
    name: "Set Env Max Value"
    id: set_env_max
    optimistic: true
    min_value: 0
    max_value: 100
    initial_value: 40
    step: 1
    restore_value: true

  # --- POWER SETTINGS ---
  - platform: template
    name: "Set Power Min Value"
    id: set_pwr_min
    optimistic: true
    min_value: 0
    max_value: 10
    initial_value: 0
    step: 0.1
    restore_value: true
  - platform: template
    name: "Set Power Max Value"
    id: set_pwr_max
    optimistic: true
    min_value: 1
    max_value: 100
    initial_value: 15
    step: 1
    restore_value: true

  # --- SQM SETTINGS ---
  - platform: template
    name: "Set SQM Min Value"
    id: set_sqm_min
    optimistic: true
    min_value: 0
    max_value: 23
    initial_value: 16
    step: 0.1
    restore_value: true
  - platform: template
    name: "Set SQM Max Value"
    id: set_sqm_max
    optimistic: true
    min_value: 0
    max_value: 24
    initial_value: 22
    step: 0.1
    restore_value: true

switch:
  - platform: template
    name: "Match Text Color"
    id: match_text_color
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    on_turn_on:
      - lambda: |-
          // 1. CPU
          if (!isnan(id(ha_cpu_temp).state)) {
             float x = id(ha_cpu_temp).state;
             float min = id(set_cpu_min).state;
             float max = id(set_cpu_max).state;
             if (max <= min) max = min + 1;
             float ratio = (x - min) / (max - min);
             if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
             int r = (int)(id(g_cpu_c1_r) + ratio * (id(g_cpu_c2_r) - id(g_cpu_c1_r)));
             int g = (int)(id(g_cpu_c1_g) + ratio * (id(g_cpu_c2_g) - id(g_cpu_c1_g)));
             int b = (int)(id(g_cpu_c1_b) + ratio * (id(g_cpu_c2_b) - id(g_cpu_c1_b)));
             lv_obj_set_style_text_color(id(lbl_cpu_temp_val), lv_color_make(r, g, b), LV_PART_MAIN);
          }
          
          // 2. SQM
          if (!isnan(id(ha_sqm).state)) {
             float x = id(ha_sqm).state;
             float min = id(set_sqm_min).state;
             float max = id(set_sqm_max).state;
             if (max <= min) max = min + 0.1;
             float ratio = (x - min) / (max - min);
             if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
             int r = (int)(id(g_sqm_c1_r) + ratio * (id(g_sqm_c2_r) - id(g_sqm_c1_r)));
             int g = (int)(id(g_sqm_c1_g) + ratio * (id(g_sqm_c2_g) - id(g_sqm_c1_g)));
             int b = (int)(id(g_sqm_c1_b) + ratio * (id(g_sqm_c2_b) - id(g_sqm_c1_b)));
             lv_obj_set_style_text_color(id(lbl_sqm_val), lv_color_make(r, g, b), LV_PART_MAIN);
          }
          
          // 3. Ambient
          if (!isnan(id(ha_enclosure_temp).state)) {
             float x = id(ha_enclosure_temp).state;
             float min = id(set_env_min).state;
             float max = id(set_env_max).state;
             if (max <= min) max = min + 1;
             float ratio = (x - min) / (max - min);
             if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
             int r = (int)(id(g_env_c1_r) + ratio * (id(g_env_c2_r) - id(g_env_c1_r)));
             int g = (int)(id(g_env_c1_g) + ratio * (id(g_env_c2_g) - id(g_env_c1_g)));
             int b = (int)(id(g_env_c1_b) + ratio * (id(g_env_c2_b) - id(g_env_c1_b)));
             lv_obj_set_style_text_color(id(lbl_enclosure_temp_val), lv_color_make(r, g, b), LV_PART_MAIN);
          }

          // 4. Power
          if (!isnan(id(ha_power).state)) {
             float x = id(ha_power).state;
             float min = id(set_pwr_min).state;
             float max = id(set_pwr_max).state;
             if (max <= min) max = min + 1;
             float ratio = (x - min) / (max - min);
             if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
             int r = (int)(id(g_pwr_c1_r) + ratio * (id(g_pwr_c2_r) - id(g_pwr_c1_r)));
             int g = (int)(id(g_pwr_c1_g) + ratio * (id(g_pwr_c2_g) - id(g_pwr_c1_g)));
             int b = (int)(id(g_pwr_c1_b) + ratio * (id(g_pwr_c2_b) - id(g_pwr_c1_b)));
             lv_obj_set_style_text_color(id(lbl_power_val), lv_color_make(r, g, b), LV_PART_MAIN);
          }

    on_turn_off:
      - lambda: |-
          lv_color_t white = lv_color_hex(0xFFFFFF);
          lv_obj_set_style_text_color(id(lbl_cpu_temp_val), white, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_sqm_val), white, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_enclosure_temp_val), white, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_power_val), white, LV_PART_MAIN);

select:
  - platform: template
    name: "Theme Selection"
    id: theme_selector
    optimistic: true
    initial_option: "Modern Slate"
    restore_value: true
    options:
      - "Modern Slate"
      - "Midnight Black"
      - "Deep Ocean"
      - "Forest Night"
      - "Cyber Neon"
      - "Crimson Dark"
      - "Solar Flare"
      - "Royal Purple"
    set_action:
      - lambda: |-
          lv_color_t bg_c, card_c;
          std::string val = x;

          // Default: Modern Slate (Updated to Darker Theme)
          bg_c = lv_color_hex(0x050505);
          card_c = lv_color_hex(0x111111);

          if (val == "Midnight Black") {
             // Total Blackout
             bg_c = lv_color_hex(0x000000);
             card_c = lv_color_hex(0x000000);
          } else if (val == "Deep Ocean") {
             // Dark Blue Theme
             bg_c = lv_color_hex(0x0f172a); // Slate 900
             card_c = lv_color_hex(0x1e3a8a); // Blue 900
          } else if (val == "Forest Night") {
             // Dark Green Theme
             bg_c = lv_color_hex(0x022c22); // Green 950
             card_c = lv_color_hex(0x064e3b); // Green 900
          } else if (val == "Cyber Neon") {
             // Dark Pink/Purple Theme
             bg_c = lv_color_hex(0x2e022d);
             card_c = lv_color_hex(0x4a044e);
          } else if (val == "Crimson Dark") {
             // Dark Red Theme
             bg_c = lv_color_hex(0x450a0a);
             card_c = lv_color_hex(0x7f1d1d);
          } else if (val == "Solar Flare") {
             // Dark Orange Theme
             bg_c = lv_color_hex(0x431407);
             card_c = lv_color_hex(0x7c2d12);
          } else if (val == "Royal Purple") {
             // Deep Purple Theme
             bg_c = lv_color_hex(0x3b0764);
             card_c = lv_color_hex(0x581c87);
          }

          // Helper lambda to set background color safely
          auto apply_bg = [](lv_obj_t *obj, lv_color_t color) {
              if (obj != nullptr) {
                  lv_obj_set_style_bg_color(obj, color, LV_PART_MAIN);
              }
          };

          // Apply to Main Container
          apply_bg(id(main_container), bg_c);
          
          // Apply to Cards
          apply_bg(id(card_thermal), card_c);
          apply_bg(id(card_system), card_c);
          apply_bg(id(card_ambient), card_c);
          apply_bg(id(card_power), card_c);

  - platform: template
    name: "Page Selection"
    id: page_selector
    optimistic: true
    initial_option: "Main Dashboard"
    icon: "mdi:layers-search"
    options:
      - "Main Dashboard"
      - "NINA Instance 2"
      - "NINA Instance 3"
    set_action:
      - lambda: |-
          if (x == "Main Dashboard") {
             id(g_current_page) = 0;
             lv_scr_load_anim(id(main_page)->obj, LV_SCR_LOAD_ANIM_FADE_ON, 400, 0, false);
          } else if (x == "NINA Instance 2") {
             id(g_current_page) = 1;
             lv_scr_load_anim(id(nina2_page)->obj, LV_SCR_LOAD_ANIM_FADE_ON, 400, 0, false);
          } else if (x == "NINA Instance 3") {
             id(g_current_page) = 2;
             lv_scr_load_anim(id(nina3_page)->obj, LV_SCR_LOAD_ANIM_FADE_ON, 400, 0, false);
          }

# =======================================================
# Home Assistant Sensors
# =======================================================
sensor:
  # --- THERMAL PAGE (Top Left) ---
  - platform: homeassistant
    id: ha_cpu_temp
    entity_id: sensor.allskypi5_cpu_temp
    on_value:
      - lambda: |-
          // 1. Settings & Gradient
          float min = id(set_cpu_min).state;
          float max = id(set_cpu_max).state;
          if (max <= min) max = min + 1;
          
          float ratio = (x - min) / (max - min);
          if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
          
          lv_bar_set_value(id(bar_cpu_temp), (int32_t)(ratio * 100), LV_ANIM_OFF);
          
          int r = (int)(id(g_cpu_c1_r) + ratio * (id(g_cpu_c2_r) - id(g_cpu_c1_r)));
          int g = (int)(id(g_cpu_c1_g) + ratio * (id(g_cpu_c2_g) - id(g_cpu_c1_g)));
          int b = (int)(id(g_cpu_c1_b) + ratio * (id(g_cpu_c2_b) - id(g_cpu_c1_b)));
          lv_color_t c = lv_color_make(r, g, b);
          lv_obj_set_style_bg_color(id(bar_cpu_temp), c, LV_PART_INDICATOR);
          
          if (id(match_text_color).state) {
            lv_obj_set_style_text_color(id(lbl_cpu_temp_val), c, LV_PART_MAIN);
          } else {
            lv_obj_set_style_text_color(id(lbl_cpu_temp_val), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
          }

          // 2. Manual Float Formatting
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          
          // Added %2d padding and "C" unit
          lv_label_set_text_fmt(id(lbl_cpu_temp_val), "%s%2d.%d°C", (x < 0 ? "-" : ""), val_int, val_dec);

  - platform: homeassistant
    id: ha_ssd_temp
    entity_id: sensor.allskypi5_disk_ssd_temp
    on_value:
      - lambda: |-
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_ssd_temp_val), "SSD: %s%2d.%d°C", (x < 0 ? "-" : ""), val_int, val_dec);

  - platform: homeassistant
    id: ha_sqm
    entity_id: sensor.sqm_reader_tsl2591_sqm
    on_value:
      - lambda: |-
          // 1. Settings & Gradient
          float min = id(set_sqm_min).state;
          float max = id(set_sqm_max).state;
          if (max <= min) max = min + 0.1;
          
          float ratio = (x - min) / (max - min);
          if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
          
          int r = (int)(id(g_sqm_c1_r) + ratio * (id(g_sqm_c2_r) - id(g_sqm_c1_r)));
          int g = (int)(id(g_sqm_c1_g) + ratio * (id(g_sqm_c2_g) - id(g_sqm_c1_g)));
          int b = (int)(id(g_sqm_c1_b) + ratio * (id(g_sqm_c2_b) - id(g_sqm_c1_b)));
          lv_color_t c = lv_color_make(r, g, b);
          
          if (id(match_text_color).state) {
            lv_obj_set_style_text_color(id(lbl_sqm_val), c, LV_PART_MAIN);
          } else {
            lv_obj_set_style_text_color(id(lbl_sqm_val), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
          }

          // Manual formatting to bypass %f issues
          // Calculate integer and 2 decimal places
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 100.0 + 0.5); // *100 for 2 decimals
          
          // Handle overflow (e.g., .995 -> 1.00)
          if (val_dec >= 100) { val_int++; val_dec = 0; }
          
          // Use integer formatting (%d) which is always supported
          lv_label_set_text_fmt(id(lbl_sqm_val), "%d.%02d", val_int, val_dec);

  - platform: homeassistant
    id: ha_starcount
    entity_id: sensor.allskypi5_as_starcount
    on_value:
      - lambda: |-
          // Display as integer
          lv_label_set_text_fmt(id(lbl_star_count), "Stars: %d", (int)x);

  # --- ENVIRONMENT PAGE (Bottom Left) ---
  - platform: homeassistant
    id: ha_enclosure_temp
    entity_id: sensor.allskypi5_as_dewcontrolambient
    on_value:
      - lambda: |-
          float min = id(set_env_min).state;
          float max = id(set_env_max).state;
          if (max <= min) max = min + 1;
          
          float ratio = (x - min) / (max - min);
          if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
          
          lv_bar_set_value(id(bar_enclosure), (int32_t)(ratio * 100), LV_ANIM_OFF);
          
          int r = (int)(id(g_env_c1_r) + ratio * (id(g_env_c2_r) - id(g_env_c1_r)));
          int g = (int)(id(g_env_c1_g) + ratio * (id(g_env_c2_g) - id(g_env_c1_g)));
          int b = (int)(id(g_env_c1_b) + ratio * (id(g_env_c2_b) - id(g_env_c1_b)));
          lv_color_t c = lv_color_make(r, g, b);
          lv_obj_set_style_bg_color(id(bar_enclosure), c, LV_PART_INDICATOR);
          
          if (id(match_text_color).state) {
            lv_obj_set_style_text_color(id(lbl_enclosure_temp_val), c, LV_PART_MAIN);
          } else {
            lv_obj_set_style_text_color(id(lbl_enclosure_temp_val), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
          }

          // Added %2d padding and "C" unit
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_enclosure_temp_val), "%s%2d.%d°C", (x < 0 ? "-" : ""), val_int, val_dec);

  - platform: homeassistant
    id: ha_enclosure_humidity
    entity_id: sensor.allskypi5_as_dewcontrolhumidity
    on_value:
      - lambda: |-
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_humidity_val), "HUM: %2d.%d%%", val_int, val_dec);

  - platform: homeassistant
    id: ha_dew_point
    entity_id: sensor.allskypi5_as_dewcontroldew
    on_value:
      - lambda: |-
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_dew_val), "DEW: %s%2d.%d°C", (x < 0 ? "-" : ""), val_int, val_dec);

  # --- POWER PAGE (Bottom Right) ---
  - platform: homeassistant
    id: ha_power
    entity_id: sensor.sqm_reader_ina260_power
    on_value:
      - lambda: |-
          float min = id(set_pwr_min).state;
          float max = id(set_pwr_max).state;
          if (max <= min) max = min + 1;
          
          float ratio = (x - min) / (max - min);
          if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
          
          lv_bar_set_value(id(bar_power), (int32_t)(ratio * 100), LV_ANIM_OFF);
          
          int r = (int)(id(g_pwr_c1_r) + ratio * (id(g_pwr_c2_r) - id(g_pwr_c1_r)));
          int g = (int)(id(g_pwr_c1_g) + ratio * (id(g_pwr_c2_g) - id(g_pwr_c1_g)));
          int b = (int)(id(g_pwr_c1_b) + ratio * (id(g_pwr_c2_b) - id(g_pwr_c1_b)));
          lv_color_t c = lv_color_make(r, g, b);
          lv_obj_set_style_bg_color(id(bar_power), c, LV_PART_INDICATOR);
          
          if (id(match_text_color).state) {
            lv_obj_set_style_text_color(id(lbl_power_val), c, LV_PART_MAIN);
          } else {
            lv_obj_set_style_text_color(id(lbl_power_val), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
          }

          // Added %2d padding and "W" unit
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_power_val), "%2d.%d W", val_int, val_dec);

  - platform: homeassistant
    id: ha_voltage
    entity_id: sensor.sqm_reader_ina260_voltage
    on_value:
      - lambda: |-
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_voltage_val), "%2d.%dV", val_int, val_dec);

  - platform: homeassistant
    id: ha_current
    entity_id: sensor.sqm_reader_ina260_current
    on_value:
      - lambda: |-
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_current_val), "%2d.%dA", val_int, val_dec);

  # --- NINA2 SENSORS ---
  - platform: homeassistant
    id: nina2_camera_temp
    entity_id: sensor.nina2_camera_temperature
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_cam_temp), "%s%2d.%d°C", (x < 0 ? "-" : ""), val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina2_cam_temp), "--");
          }

  - platform: homeassistant
    id: nina2_exposure_num
    entity_id: sensor.nina2_exposure_number
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina2_exp_num), "%d", (int)x);
          } else {
            lv_label_set_text(id(lbl_nina2_exp_num), "--");
          }

  - platform: homeassistant
    id: nina2_exposure_time
    entity_id: sensor.nina2_exposure_time
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_exp_time), "%d.%dS", val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina2_exp_time), "--");
          }

  - platform: homeassistant
    id: nina2_detected_stars
    entity_id: sensor.nina2_star_detectedstars
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina2_stars), "%d", (int)x);
          } else {
            lv_label_set_text(id(lbl_nina2_stars), "--");
          }

  - platform: homeassistant
    id: nina2_hfr
    entity_id: sensor.nina2_star_hfr
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 100.0 + 0.5);
            if (val_dec >= 100) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_hfr), "%d.%02d", val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina2_hfr), "--");
          }

  - platform: homeassistant
    id: nina2_saturated_pixels
    entity_id: sensor.nina2_target_max_saturated_pixels
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina2_sat_px), "%d Px", (int)x);
          } else {
            lv_label_set_text(id(lbl_nina2_sat_px), "--");
          }

  - platform: homeassistant
    id: nina2_total_rms
    entity_id: sensor.nina2_total_rms
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_rms), "%d.%d\"", val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina2_rms), "--");
          }

  - platform: homeassistant
    id: nina2_ra_rms
    entity_id: sensor.nina_instance_2_nina2_ra_rms
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_ra_rms), "RA: %d.%d\"", val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina2_ra_rms), "RA: --");
          }

  - platform: homeassistant
    id: nina2_dec_rms
    entity_id: sensor.nina_instance_2_nina2_dec_rms
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_dec_rms), "DEC: %d.%d\"", val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina2_dec_rms), "DEC: --");
          }

  # --- NINA3 SENSORS ---
  - platform: homeassistant
    id: nina3_camera_temp
    entity_id: sensor.nina3_camera_temperature
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_cam_temp), "%s%2d.%d°C", (x < 0 ? "-" : ""), val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina3_cam_temp), "--");
          }

  - platform: homeassistant
    id: nina3_exposure_num
    entity_id: sensor.nina3_exposure_number
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina3_exp_num), "%d", (int)x);
          } else {
            lv_label_set_text(id(lbl_nina3_exp_num), "--");
          }

  - platform: homeassistant
    id: nina3_exposure_time
    entity_id: sensor.nina3_exposure_time
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_exp_time), "%d.%dS", val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina3_exp_time), "--");
          }

  - platform: homeassistant
    id: nina3_detected_stars
    entity_id: sensor.nina3_star_detectedstars
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina3_stars), "%d", (int)x);
          } else {
            lv_label_set_text(id(lbl_nina3_stars), "--");
          }

  - platform: homeassistant
    id: nina3_hfr
    entity_id: sensor.nina3_star_hfr
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 100.0 + 0.5);
            if (val_dec >= 100) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_hfr), "%d.%02d", val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina3_hfr), "--");
          }

  - platform: homeassistant
    id: nina3_saturated_pixels
    entity_id: sensor.nina3_target_max_saturated_pixels
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina3_sat_px), "%d Px", (int)x);
          } else {
            lv_label_set_text(id(lbl_nina3_sat_px), "--");
          }

  - platform: homeassistant
    id: nina3_total_rms
    entity_id: sensor.nina3_total_rms
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_rms), "%d.%d\"", val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina3_rms), "--");
          }

  - platform: homeassistant
    id: nina3_ra_rms
    entity_id: sensor.nina_instance_3_nina3_ra_rms
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_ra_rms), "RA: %d.%d\"", val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina3_ra_rms), "RA: --");
          }

  - platform: homeassistant
    id: nina3_dec_rms
    entity_id: sensor.nina_instance_3_nina3_dec_rms
    on_value:
      - lambda: |-
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_dec_rms), "DEC: %d.%d\"", val_int, val_dec);
          } else {
            lv_label_set_text(id(lbl_nina3_dec_rms), "DEC: --");
          }

# Binary Sensor for Touch Release
binary_sensor:
  - platform: touchscreen
    id: touch_active
    touchscreen_id: touchscreen_
    x_min: 0
    x_max: 720
    y_min: 0
    y_max: 720
    on_release:
      - globals.set:
          id: g_touch_start_x
          value: '-1'

# Binary/Text sensors for status indicators
text_sensor:
  - platform: homeassistant
    id: ha_cloud_status
    entity_id: sensor.allskypi5_cloud_detector_status
    on_value:
      - lambda: |-
          lv_label_set_text(id(lbl_cloud_status), x.c_str());

  # NINA2 Text Sensors
  - platform: homeassistant
    id: nina2_filter
    entity_id: sensor.nina2_filter_wheel_filter
    on_value:
      - lambda: |-
          lv_label_set_text(id(lbl_nina2_filter), x.c_str());

  - platform: homeassistant
    id: nina2_target
    entity_id: sensor.nina2_target_name
    on_value:
      - lambda: |-
          lv_label_set_text(id(lbl_nina2_target), x.c_str());

  # NINA3 Text Sensors
  - platform: homeassistant
    id: nina3_filter
    entity_id: sensor.nina3_filter_wheel_filter
    on_value:
      - lambda: |-
          lv_label_set_text(id(lbl_nina3_filter), x.c_str());

  - platform: homeassistant
    id: nina3_target
    entity_id: sensor.nina3_target_name
    on_value:
      - lambda: |-
          lv_label_set_text(id(lbl_nina3_target), x.c_str());

  - platform: homeassistant
    id: ha_heater
    entity_id: sensor.allskypi5_as_dewcontrolheater
    on_value:
      - if:
          condition:
            lambda: 'return x == "True" || x == "true";'
          then:
            - lvgl.obj.update:
                id: ind_heater_dot
                bg_color: 0xFF4500
                bg_opa: COVER
          else:
            - lvgl.obj.update:
                id: ind_heater_dot
                bg_color: 0x444444
                bg_opa: 50%

  - platform: homeassistant
    id: ha_enclosure_fan
    entity_id: sensor.allsky_fan
    on_value:
      - if:
          condition:
            lambda: 'return x == "True" || x == "true";'
          then:
            - lvgl.obj.update:
                id: ind_fan_dot
                bg_color: 0x0EA5E9
                bg_opa: COVER
          else:
            - lvgl.obj.update:
                id: ind_fan_dot
                bg_color: 0x444444
                bg_opa: 50%

# =======================================================
# LVGL UI Configuration
# =======================================================
lvgl:
  buffer_size: 100%
  byte_order: little_endian
  
  style_definitions:
    # --- Backgrounds ---
    - id: style_page_bg
      bg_color: 0x050505
      bg_opa: COVER

    - id: style_card_bg
      bg_color: 0x111111
      bg_opa: COVER
      radius: 16
      border_width: 1
      border_color: 0x333333
      pad_all: 15

    # --- Typography ---
    - id: style_header
      text_color: 0x888888
      text_font: font_header_40
      text_align: LEFT

    - id: style_value_hero
      text_font: font_roboto_hero
      text_color: 0xFFFFFF
      text_align: CENTER
      pad_top: 10
      pad_bottom: 10
    
    - id: style_label_sub
      text_font: font_roboto_28
      text_color: 0xCCCCCC
      text_align: CENTER

    - id: style_unit_small
      text_font: font_roboto_28
      text_color: 0x888888
      text_align: CENTER

    # --- Bars (Progress) ---
    - id: style_bar_bg
      bg_color: 0x222222
      radius: 6
      bg_opa: COVER

    # --- Accents (Note: These are now defaults, overridden dynamically) ---
    - id: style_bar_red
      bg_color: 0xEF4444
      radius: 6
    
    - id: style_bar_blue
      bg_color: 0x3B82F6
      radius: 6

    - id: style_bar_green
      bg_color: 0x10B981
      radius: 6

    - id: style_bar_amber
      bg_color: 0xF59E0B
      radius: 6

  pages:
    - id: main_page
      styles: style_page_bg
      scrollbar_mode: "OFF"
      widgets:
        - obj:
            id: main_container
            # Main Flex Container 720x720
            width: 720
            height: 720
            bg_color: 0x000000
            bg_opa: COVER
            border_width: 0
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: ROW_WRAP
              flex_align_main: SPACE_EVENLY
              flex_align_cross: SPACE_EVENLY
            pad_all: 5
            
            widgets:
              # =================================================
              # CARD 1: THERMAL (Top Left)
              # =================================================
              - obj:
                  id: card_thermal
                  width: 350
                  height: 350
                  styles: style_card_bg
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: COLUMN
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    # Header
                    - label:
                        text: "THERMAL"
                        styles: style_header
                    
                    # Main Value
                    - obj:
                        width: 100%
                        height: 110
                        bg_opa: TRANSP
                        border_width: 0
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: CENTER
                          flex_align_cross: CENTER
                        widgets:
                          - label:
                              id: lbl_cpu_temp_val
                              text: "--"
                              styles: style_value_hero
                          - label:
                              text: "CPU TEMP"
                              styles: style_unit_small

                    # Bar
                    - bar:
                        id: bar_cpu_temp
                        width: 100%
                        height: 12
                        min_value: 0
                        max_value: 100
                        mode: NORMAL
                        styles: style_bar_bg
                        indicator:
                          styles: style_bar_red

                    # Footer
                    - label:
                        id: lbl_ssd_temp_val
                        text: "SSD: --°C"
                        styles: style_label_sub
                        align: CENTER
                        pad_top: 10

              # =================================================
              # CARD 2: SKY INFO (Top Right)
              # =================================================
              - obj:
                  id: card_system
                  width: 350
                  height: 350
                  styles: style_card_bg
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: COLUMN
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    # Header with Indicator
                    - obj:
                        width: 100%
                        height: 50
                        bg_opa: TRANSP
                        border_width: 0
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: ROW
                          flex_align_main: SPACE_BETWEEN
                          flex_align_cross: CENTER
                        widgets:
                          - label:
                              text: "SQM"
                              styles: style_header
                    
                    # Main Value (SQM)
                    - obj:
                        width: 100%
                        height: 110
                        bg_opa: TRANSP
                        border_width: 0
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: CENTER
                          flex_align_cross: CENTER
                        widgets:
                          - label:
                              id: lbl_sqm_val
                              text: "--"
                              styles: style_value_hero
                          - label:
                              text: "SQM"
                              styles: style_unit_small
                    
                    # # DIVIDER
                    # - obj:
                    #     width: 100%
                    #     height: 2
                    #     bg_color: 0x444444
                    #     bg_opa: COVER
                    #     border_width: 0

                    # Footer Rows (Cloud Status / Star Count)
                    - obj:
                        width: 100%
                        height: 100
                        bg_opa: TRANSP
                        border_width: 0
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_EVENLY
                        widgets:
                          # Cloud Status (Using Header Font for slightly compressed width)
                          - label:
                              id: lbl_cloud_status
                              text: "--"
                              text_font: font_header_40
                              text_color: 0xFFFFFF
                              text_align: CENTER
                              align: CENTER
                          
                          # Star Count
                          - label:
                              id: lbl_star_count
                              text: "Stars: --"
                              styles: style_unit_small


              # =================================================
              # CARD 3: AMBIENT (Bottom Left)
              # =================================================
              - obj:
                  id: card_ambient
                  width: 350
                  height: 350
                  styles: style_card_bg
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: COLUMN
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    # Header with Indicator
                    - obj:
                        width: 100%
                        height: 50
                        bg_opa: TRANSP
                        border_width: 0
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: ROW
                          flex_align_main: SPACE_BETWEEN
                          flex_align_cross: CENTER
                        widgets:
                          - label:
                              text: "AMBIENT"
                              styles: style_header
                          - obj:
                              width: 70
                              height: 50
                              bg_opa: TRANSP
                              border_width: 0
                              scrollbar_mode: "OFF"
                              layout:
                                type: flex
                                flex_flow: ROW
                                flex_align_main: END
                                flex_align_cross: CENTER
                                pad_column: 10
                              widgets:
                                - obj:
                                    id: ind_heater_dot
                                    width: 24
                                    height: 24
                                    radius: 12
                                    bg_color: 0x444444
                                    scrollbar_mode: "OFF"
                                - obj:
                                    id: ind_fan_dot
                                    width: 24
                                    height: 24
                                    radius: 12
                                    bg_color: 0x444444
                                    scrollbar_mode: "OFF"

                    # Main Value
                    - obj:
                        width: 100%
                        height: 110
                        bg_opa: TRANSP
                        border_width: 0
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: CENTER
                          flex_align_cross: CENTER
                        widgets:
                          - label:
                              id: lbl_enclosure_temp_val
                              text: "--"
                              styles: style_value_hero
                          - label:
                              text: "TEMP °C"
                              styles: style_unit_small

                    # Bar
                    - bar:
                        id: bar_enclosure
                        width: 100%
                        height: 12
                        min_value: 0
                        max_value: 100
                        mode: NORMAL
                        styles: style_bar_bg
                        indicator:
                          styles: style_bar_green

                    # Footer
                    - obj:
                        width: 100%
                        height: 60
                        bg_opa: TRANSP
                        border_width: 0
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_EVENLY
                        widgets:
                          - label:
                              id: lbl_humidity_val
                              text: "H: --%"
                              styles: style_label_sub
                          - label:
                              id: lbl_dew_val
                              text: "D: --°C"
                              styles: style_label_sub

              # =================================================
              # CARD 4: POWER (Bottom Right)
              # =================================================
              - obj:
                  id: card_power
                  width: 350
                  height: 350
                  styles: style_card_bg
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: COLUMN
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    # Header
                    - label:
                        text: "POWER"
                        styles: style_header

                    # Main Value
                    - obj:
                        width: 100%
                        height: 110
                        bg_opa: TRANSP
                        border_width: 0
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: CENTER
                          flex_align_cross: CENTER
                        widgets:
                          - label:
                              id: lbl_power_val
                              text: "--"
                              styles: style_value_hero
                          - label:
                              text: "WATTS"
                              styles: style_unit_small

                    # Bar
                    - bar:
                        id: bar_power
                        width: 100%
                        height: 12
                        min_value: 0
                        max_value: 100
                        mode: NORMAL
                        styles: style_bar_bg
                        indicator:
                          styles: style_bar_amber

                    # Footer
                    - obj:
                        width: 100%
                        height: 50
                        bg_opa: TRANSP
                        border_width: 0
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: ROW
                          flex_align_main: SPACE_BETWEEN
                        widgets:
                          - label:
                              id: lbl_voltage_val
                              text: "-- V"
                              styles: style_label_sub
                          - label:
                              id: lbl_current_val
                              text: "-- A"
                              styles: style_label_sub

    # =======================================================
    # NINA2 PAGE - Astrophotography Metrics
    # =======================================================
    - id: nina2_page
      styles: style_page_bg
      scrollbar_mode: "OFF"
      widgets:
        - obj:
            id: nina2_container
            width: 720
            height: 720
            bg_color: 0x000000
            bg_opa: COVER
            border_width: 0
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: COLUMN
              flex_align_main: START
            pad_all: 15
            widgets:
              # Header
              - label:
                  text: "NINA INSTANCE 2"
                  text_font: font_header_40
                  text_color: 0x3B82F6
                  text_align: CENTER
                  width: 100%
                  pad_bottom: 10

              # Target Name Card
              - obj:
                  width: 690
                  height: 80
                  styles: style_card_bg
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: COLUMN
                    flex_align_main: CENTER
                  widgets:
                    - label:
                        text: "TARGET"
                        styles: style_unit_small
                    - label:
                        id: lbl_nina2_target
                        text: "--"
                        text_font: font_header_40
                        text_color: 0xFFFFFF
                        text_align: CENTER

              # Camera & Exposure Row
              - obj:
                  width: 690
                  height: 160
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: ROW
                    flex_align_main: SPACE_BETWEEN
                  pad_top: 10
                  widgets:
                    # Camera Temp
                    - obj:
                        width: 220
                        height: 160
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_BETWEEN
                        widgets:
                          - label:
                              text: "CAM TEMP"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina2_cam_temp
                              text: "--"
                              text_font: font_roboto_hero
                              text_color: 0x3B82F6
                              text_align: CENTER

                    # Exposure Number
                    - obj:
                        width: 220
                        height: 160
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_BETWEEN
                        widgets:
                          - label:
                              text: "EXP #"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina2_exp_num
                              text: "--"
                              text_font: font_roboto_hero
                              text_color: 0x10B981
                              text_align: CENTER

                    # Exposure Time
                    - obj:
                        width: 220
                        height: 160
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_BETWEEN
                        widgets:
                          - label:
                              text: "EXP TIME"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina2_exp_time
                              text: "--"
                              text_font: font_roboto_hero
                              text_color: 0xF59E0B
                              text_align: CENTER

              # Stars & HFR Row
              - obj:
                  width: 690
                  height: 140
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: ROW
                    flex_align_main: SPACE_BETWEEN
                  pad_top: 10
                  widgets:
                    # Detected Stars
                    - obj:
                        width: 335
                        height: 140
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_BETWEEN
                        widgets:
                          - label:
                              text: "STARS"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina2_stars
                              text: "--"
                              text_font: font_roboto_hero
                              text_color: 0xFFFFFF
                              text_align: CENTER

                    # HFR
                    - obj:
                        width: 335
                        height: 140
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_BETWEEN
                        widgets:
                          - label:
                              text: "HFR (Px)"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina2_hfr
                              text: "--"
                              text_font: font_roboto_hero
                              text_color: 0xFF6B9D
                              text_align: CENTER

              # RMS & Filter Row
              - obj:
                  width: 690
                  height: 120
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: ROW
                    flex_align_main: SPACE_BETWEEN
                  pad_top: 10
                  widgets:
                    # Total RMS
                    - obj:
                        width: 160
                        height: 120
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_EVENLY
                        widgets:
                          - label:
                              text: "RMS"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina2_rms
                              text: "--"
                              text_font: font_header_40
                              text_color: 0xFFFFFF
                              text_align: CENTER

                    # RA & DEC RMS
                    - obj:
                        width: 260
                        height: 120
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_EVENLY
                        widgets:
                          - label:
                              id: lbl_nina2_ra_rms
                              text: "RA: --"
                              styles: style_label_sub
                          - label:
                              id: lbl_nina2_dec_rms
                              text: "DEC: --"
                              styles: style_label_sub

                    # Filter
                    - obj:
                        width: 240
                        height: 120
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_EVENLY
                        widgets:
                          - label:
                              text: "FILTER"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina2_filter
                              text: "--"
                              text_font: font_header_40
                              text_color: 0xFFFFFF
                              text_align: CENTER

              # Saturated Pixels
              - obj:
                  width: 690
                  height: 80
                  styles: style_card_bg
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: ROW
                    flex_align_main: SPACE_BETWEEN
                    flex_align_cross: CENTER
                  pad_top: 10
                  widgets:
                    - label:
                        text: "Saturated Pixels:"
                        styles: style_label_sub
                    - label:
                        id: lbl_nina2_sat_px
                        text: "--"
                        styles: style_label_sub

    # =======================================================
    # NINA3 PAGE - Astrophotography Metrics
    # =======================================================
    - id: nina3_page
      styles: style_page_bg
      scrollbar_mode: "OFF"
      widgets:
        - obj:
            id: nina3_container
            width: 720
            height: 720
            bg_color: 0x000000
            bg_opa: COVER
            border_width: 0
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: COLUMN
              flex_align_main: START
            pad_all: 15
            widgets:
              # Header
              - label:
                  text: "NINA INSTANCE 3"
                  text_font: font_header_40
                  text_color: 0x10B981
                  text_align: CENTER
                  width: 100%
                  pad_bottom: 10

              # Target Name Card
              - obj:
                  width: 690
                  height: 80
                  styles: style_card_bg
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: COLUMN
                    flex_align_main: CENTER
                  widgets:
                    - label:
                        text: "TARGET"
                        styles: style_unit_small
                    - label:
                        id: lbl_nina3_target
                        text: "--"
                        text_font: font_header_40
                        text_color: 0xFFFFFF
                        text_align: CENTER

              # Camera & Exposure Row
              - obj:
                  width: 690
                  height: 160
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: ROW
                    flex_align_main: SPACE_BETWEEN
                  pad_top: 10
                  widgets:
                    # Camera Temp
                    - obj:
                        width: 220
                        height: 160
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_BETWEEN
                        widgets:
                          - label:
                              text: "CAM TEMP"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina3_cam_temp
                              text: "--"
                              text_font: font_roboto_hero
                              text_color: 0x3B82F6
                              text_align: CENTER

                    # Exposure Number
                    - obj:
                        width: 220
                        height: 160
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_BETWEEN
                        widgets:
                          - label:
                              text: "EXP #"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina3_exp_num
                              text: "--"
                              text_font: font_roboto_hero
                              text_color: 0x10B981
                              text_align: CENTER

                    # Exposure Time
                    - obj:
                        width: 220
                        height: 160
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_BETWEEN
                        widgets:
                          - label:
                              text: "EXP TIME"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina3_exp_time
                              text: "--"
                              text_font: font_roboto_hero
                              text_color: 0xF59E0B
                              text_align: CENTER

              # Stars & HFR Row
              - obj:
                  width: 690
                  height: 140
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: ROW
                    flex_align_main: SPACE_BETWEEN
                  pad_top: 10
                  widgets:
                    # Detected Stars
                    - obj:
                        width: 335
                        height: 140
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_BETWEEN
                        widgets:
                          - label:
                              text: "STARS"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina3_stars
                              text: "--"
                              text_font: font_roboto_hero
                              text_color: 0xFFFFFF
                              text_align: CENTER

                    # HFR
                    - obj:
                        width: 335
                        height: 140
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_BETWEEN
                        widgets:
                          - label:
                              text: "HFR (Px)"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina3_hfr
                              text: "--"
                              text_font: font_roboto_hero
                              text_color: 0xFF6B9D
                              text_align: CENTER

              # RMS & Filter Row
              - obj:
                  width: 690
                  height: 120
                  bg_opa: TRANSP
                  border_width: 0
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: ROW
                    flex_align_main: SPACE_BETWEEN
                  pad_top: 10
                  widgets:
                    # Total RMS
                    - obj:
                        width: 160
                        height: 120
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_EVENLY
                        widgets:
                          - label:
                              text: "RMS"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina3_rms
                              text: "--"
                              text_font: font_header_40
                              text_color: 0xFFFFFF
                              text_align: CENTER

                    # RA & DEC RMS
                    - obj:
                        width: 260
                        height: 120
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_EVENLY
                        widgets:
                          - label:
                              id: lbl_nina3_ra_rms
                              text: "RA: --"
                              styles: style_label_sub
                          - label:
                              id: lbl_nina3_dec_rms
                              text: "DEC: --"
                              styles: style_label_sub

                    # Filter
                    - obj:
                        width: 240
                        height: 120
                        styles: style_card_bg
                        scrollbar_mode: "OFF"
                        layout:
                          type: flex
                          flex_flow: COLUMN
                          flex_align_main: SPACE_EVENLY
                        widgets:
                          - label:
                              text: "FILTER"
                              styles: style_unit_small
                          - label:
                              id: lbl_nina3_filter
                              text: "--"
                              text_font: font_header_40
                              text_color: 0xFFFFFF
                              text_align: CENTER

              # Saturated Pixels
              - obj:
                  width: 690
                  height: 80
                  styles: style_card_bg
                  scrollbar_mode: "OFF"
                  layout:
                    type: flex
                    flex_flow: ROW
                    flex_align_main: SPACE_BETWEEN
                    flex_align_cross: CENTER
                  pad_top: 10
                  widgets:
                    - label:
                        text: "Saturated Pixels:"
                        styles: style_label_sub
                    - label:
                        id: lbl_nina3_sat_px
                        text: "--"
                        styles: style_label_sub
