<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NINA Display</title>
  <style>
    :root {
      --bg: #09090b;
      --card: #121217;
      --border: #27272a;
      --accent: #14b8a6;
      --accent-hover: #0d9488;
      --text: #fafafa;
      --text-dim: #a1a1aa;
      --danger: #ef4444;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 24px; line-height: 1.5; }
    .container { max-width: 1100px; margin: 0 auto; }
    header { margin-bottom: 32px; border-left: 4px solid var(--accent); padding-left: 16px; }
    header h1 { margin: 0; font-size: 1.5rem; font-weight: 700; letter-spacing: -0.025em; }
    header p { margin: 4px 0 0; color: var(--text-dim); font-size: 0.9rem; }
    .bento-grid { display: grid; gap: 20px; grid-template-columns: repeat(12, 1fr); }
    .tile { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; display: flex; flex-direction: column; transition: border-color 0.2s; }
    .tile:hover { border-color: var(--accent); }
    .tile h3 { margin: 0 0 20px 0; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent); display: flex; align-items: center; gap: 8px; }
    .group { margin-bottom: 18px; position: relative; }
    label { display: block; margin-bottom: 6px; color: var(--text-dim); font-size: 0.75rem; font-weight: 500; text-transform: uppercase; }
    input[type='text'], input[type='password'], input[type='number'], select { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 10px 14px; border-radius: 8px; width: 100%; font-size: 0.9rem; transition: all 0.2s; }
    input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(20,184,166,0.2); }
    .color-grid { display: flex; gap: 12px; width: 100%; flex-wrap: wrap; margin-top: 10px; }
    .filter-item { flex: 1 0 90px; min-width: 0; max-width: 200px; background: rgba(255,255,255,0.03); padding: 14px 10px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 10px; border: 1px solid transparent; transition: all 0.2s; }
    .filter-item:hover { background: rgba(255,255,255,0.06); border-color: var(--border); }
    .filter-item label { margin: 0; font-size: 0.7rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; text-transform: none; }
    .color-dot { width: 40px; height: 40px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; padding: 0; background: none; transition: transform 0.1s; }
    .color-dot:active { transform: scale(0.9); }
    .slider-wrapper { display: flex; align-items: center; gap: 12px; }
    input[type='range'] { flex: 1; height: 6px; appearance: none; background: var(--border); border-radius: 3px; outline: none; }
    input[type='range']::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; border: 3px solid var(--card); box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    .toggle { position: relative; display: inline-block; width: 44px; height: 24px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--border); transition: .2s; border-radius: 24px; }
    .toggle-slider:before { content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: var(--text-dim); transition: .2s; border-radius: 50%; }
    .toggle input:checked + .toggle-slider { background: var(--accent); }
    .toggle input:checked + .toggle-slider:before { transform: translateX(20px); background: var(--bg); }
    .btn { border: none; border-radius: 10px; padding: 14px 20px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--accent); color: var(--bg); width: 100%; }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-dim); flex: 1; }
    .btn-outline:hover { border-color: var(--warning); color: var(--warning); }
    .btn-danger { background: transparent; border: 1px solid var(--border); color: var(--text-dim); flex: 1; }
    .btn-danger:hover { border-color: var(--danger); color: var(--danger); }
    .color-rect { width: 48px; height: 38px; padding: 0; border: 1px solid var(--border); background: none; border-radius: 8px; cursor: pointer; }
    .area-net { grid-column: span 4; }
    .area-api { grid-column: span 4; }
    .area-appearance { grid-column: span 4; }
    .area-thresholds { grid-column: span 12; }
    .filter-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 8px; }
    .filter-grid .filter-item { flex: none; min-width: 0; padding: 8px 4px; }
    .filter-grid .filter-item label { font-size: 0.65rem; }
    .filter-grid .color-dot { width: 32px; height: 32px; border-radius: 8px; }
    .area-firmware { grid-column: span 12; }
    .firmware-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 18px; }
    .firmware-info-item { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; border: 1px solid var(--border); }
    .firmware-info-item .label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-dim); margin-bottom: 4px; }
    .firmware-info-item .value { font-size: 0.9rem; font-weight: 600; word-break: break-all; }
    .ota-controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .ota-controls input[type='file'] { display: none; }
    .ota-file-label { background: var(--bg); border: 1px dashed var(--border); color: var(--text-dim); padding: 12px 20px; border-radius: 10px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; flex: 1; text-align: center; min-width: 200px; }
    .ota-file-label:hover { border-color: var(--accent); color: var(--text); }
    .ota-file-label.has-file { border-color: var(--accent); border-style: solid; color: var(--accent); }
    .progress-wrap { width: 100%; margin-top: 12px; display: none; }
    .progress-bar { width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .progress-bar-fill { height: 100%; background: var(--accent); border-radius: 4px; width: 0%; transition: width 0.2s; }
    .ota-status { font-size: 0.8rem; color: var(--text-dim); margin-top: 8px; }
    .area-actions { grid-column: span 12; }
    .action-row { display: flex; gap: 12px; }
    .action-row .btn { flex: 1; }
    .hint { font-size: 0.75rem; color: var(--text-dim); margin: 4px 0 0 0; }
    .threshold-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    .threshold-node { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .threshold-node h4 { margin: 0 0 14px; font-size: 0.82rem; color: var(--accent); font-weight: 600; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .threshold-sub h5 { margin: 0 0 10px; font-size: 0.72rem; color: var(--text-dim); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
    .threshold-sub { margin-bottom: 16px; }
    .threshold-sub:last-child { margin-bottom: 0; }
    @media (max-width: 900px) {
      .area-net, .area-api, .area-appearance { grid-column: span 12; }
      .action-row { flex-direction: column; }
      .action-row .btn { width: 100%; }
      .filter-item { flex: 1 0 45%; }
      .threshold-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="container">
  <header style="display:flex;align-items:flex-start;justify-content:space-between"><div><h1>NINA DISPLAY</h1><p>System Configuration</p></div><a href="https://github.com/chvvkumar/ESP32-P4-NINA-Display" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:6px;color:var(--text-dim);text-decoration:none;font-size:0.8rem;padding:6px 10px;border:1px solid var(--border);border-radius:8px;transition:all 0.2s" onmouseover="this.style.color='var(--text)';this.style.borderColor='var(--accent)'" onmouseout="this.style.color='var(--text-dim)';this.style.borderColor='var(--border)'"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/></svg>GitHub</a></header>
  <div class="bento-grid">

    <div class="tile area-net">
      <h3>Connectivity</h3>
      <div class="group"><label>WiFi SSID</label><input type="text" id="ssid"></div>
      <div class="group"><label>WiFi Password</label><input type="password" id="pass" placeholder="Enter new password to change"><p class="hint">Stored in WiFi hardware. Leave blank to keep current.</p></div>
      <div class="group"><label>NTP Server</label><input type="text" id="ntp"></div>
      <div class="group"><label>Timezone</label><select id="timezone">
        <option value="">UTC (default)</option>
        <option value="GMT0">GMT</option>
        <option value="GMT0BST,M3.5.0/1,M10.5.0">UK (GMT/BST)</option>
        <option value="CET-1CEST,M3.5.0,M10.5.0/3">Central Europe (CET/CEST)</option>
        <option value="EET-2EEST,M3.5.0/3,M10.5.0/4">Eastern Europe (EET/EEST)</option>
        <option value="EST5EDT,M3.2.0,M11.1.0">US Eastern (EST/EDT)</option>
        <option value="CST6CDT,M3.2.0,M11.1.0">US Central (CST/CDT)</option>
        <option value="MST7MDT,M3.2.0,M11.1.0">US Mountain (MST/MDT)</option>
        <option value="MST7">US Arizona (MST, no DST)</option>
        <option value="PST8PDT,M3.2.0,M11.1.0">US Pacific (PST/PDT)</option>
        <option value="AKST9AKDT,M3.2.0,M11.1.0">US Alaska (AKST/AKDT)</option>
        <option value="HST10">US Hawaii (HST, no DST)</option>
        <option value="AEST-10AEDT,M10.1.0,M4.1.0/3">Australia Eastern (AEST/AEDT)</option>
        <option value="ACST-9:30ACDT,M10.1.0,M4.1.0/3">Australia Central (ACST/ACDT)</option>
        <option value="AWST-8">Australia Western (AWST, no DST)</option>
        <option value="NZST-12NZDT,M9.5.0,M4.1.0/3">New Zealand (NZST/NZDT)</option>
        <option value="JST-9">Japan (JST)</option>
        <option value="CST-8">China (CST)</option>
        <option value="IST-5:30">India (IST)</option>
        <option value="<-03>3">Argentina (ART)</option>
        <option value="<-03>3<-02>,M10.3.0/0,M2.3.0/0">Brazil (BRT/BRST)</option>
        <option value="SAST-2">South Africa (SAST)</option>
      </select></div>
      <div style="border-top:1px solid var(--border);margin:16px 0 14px"></div>
      <div class="group" style="display:flex;align-items:center;justify-content:space-between"><label style="margin:0">MQTT / Home Assistant</label><label class="toggle"><input type="checkbox" id="mqtt_enabled"><span class="toggle-slider"></span></label></div>
      <div class="group"><label>Broker Host</label><input type="text" id="mqtt_broker" placeholder="192.168.1.250"></div>
      <div class="group"><label>Port</label><input type="text" id="mqtt_port" placeholder="1883"></div>
      <div class="group"><label>Username</label><input type="text" id="mqtt_user"></div>
      <div class="group"><label>Password</label><input type="password" id="mqtt_pass"></div>
      <div class="group"><label>Topic Prefix</label><input type="text" id="mqtt_prefix" placeholder="ninadisplay"></div>
      <p class="hint">Reboot required after changing WiFi, NTP, timezone, or MQTT settings.</p>
    </div>

    <div class="tile area-api">
      <h3>NINA Endpoints</h3>
      <div class="group"><label>NINA 1</label><input type="text" id="url1" placeholder="astromele2.lan" oninput="updateNodeLabels()"></div>
      <div class="group"><label>NINA 2</label><input type="text" id="url2" placeholder="astromele3.lan" oninput="updateNodeLabels()"></div>
      <div class="group"><label>NINA 3</label><input type="text" id="url3" placeholder="astromele4.lan" oninput="updateNodeLabels()"></div>
    </div>

    <div class="tile area-appearance">
      <h3>Display</h3>
      <div class="group">
        <label>Theme</label>
        <select id="theme_select" onchange="setTheme(this.value)">
          <option value="0">Bento Default</option>
          <option value="1">OLED Black</option>
          <option value="2">Red Night</option>
          <option value="3">Monochrome</option>
          <option value="4">All Black</option>
          <option value="5">Midnight Industrial</option>
        </select>
      </div>
      <div class="group"><label>Backlight</label><div class="slider-wrapper"><input type="range" id="brightness" min="0" max="100" value="50" oninput="setBrightness(this.value)"><span id="bright_val" style="width:35px;font-size:0.8rem">50%</span></div></div>
      <div class="group"><label>Text Brightness</label><div class="slider-wrapper"><input type="range" id="color_brightness" min="0" max="100" value="100" oninput="setColorBrightness(this.value)"><span id="cbright_val" style="width:35px;font-size:0.8rem">100%</span></div></div>
      <div class="group"><label>Data Update Rate (seconds)</label><input type="number" id="update_rate" min="1" max="10" value="2"><p class="hint">How often exposure, filter, RMS and HFR update. Minimum 1 s.</p></div>
      <div style="border-top:1px solid var(--border);margin:16px 0 14px"></div>
      <div class="group"><label>Active Page</label><select id="active_page" onchange="setPage(this.value)"><option value="-1">Auto (no override)</option><option value="0">Summary</option><option value="1">NINA 1</option><option value="2">NINA 2</option><option value="3">NINA 3</option><option value="4">System Info</option></select><p class="hint">Switches immediately and persists through reboots. Set to Auto when using rotation.</p></div>
      <div class="group" style="display:flex;align-items:center;justify-content:space-between"><label style="margin:0">Auto-Rotate Pages</label><label class="toggle"><input type="checkbox" id="auto_rotate_enabled"><span class="toggle-slider"></span></label></div>
      <div class="group"><label>Rotation Interval (seconds)</label><input type="number" id="auto_rotate_interval" min="4" max="3600" value="30"><p class="hint">Pages rotate every N seconds. Minimum effective interval is ~4 s.</p></div>
      <div class="group"><label>Transition Effect</label><select id="auto_rotate_effect"><option value="0">Instant</option><option value="1">Fade</option><option value="2">Slide Left</option><option value="3">Slide Right</option></select></div>
      <div class="group" style="display:flex;align-items:center;justify-content:space-between"><label style="margin:0">Skip Disconnected Pages</label><label class="toggle"><input type="checkbox" id="auto_rotate_skip"><span class="toggle-slider"></span></label></div>
      <div class="group"><label>Pages in Rotation</label>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:6px">
          <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:0.85rem;cursor:pointer"><input type="checkbox" id="arp_summary" style="width:auto"> Summary</label>
          <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:0.85rem;cursor:pointer"><input type="checkbox" id="arp_nina1" style="width:auto"> <span id="arp_lbl1">NINA 1</span></label>
          <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:0.85rem;cursor:pointer"><input type="checkbox" id="arp_nina2" style="width:auto"> <span id="arp_lbl2">NINA 2</span></label>
          <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:0.85rem;cursor:pointer"><input type="checkbox" id="arp_nina3" style="width:auto"> <span id="arp_lbl3">NINA 3</span></label>
          <label style="display:flex;align-items:center;gap:8px;text-transform:none;font-size:0.85rem;cursor:pointer"><input type="checkbox" id="arp_sysinfo" style="width:auto"> System Info</label>
        </div>
        <p class="hint">Select which pages are included in automatic rotation.</p>
      </div>
    </div>

    <div class="tile area-thresholds">
      <h3>NINA Settings</h3>
      <div class="threshold-grid">

        <div class="threshold-node">
          <h4 id="tnode0">Node 1</h4>
          <div class="threshold-sub"><h5>Filters</h5><div id="filters_0" class="filter-grid"></div></div>
          <div class="threshold-sub"><h5>RMS</h5>
            <div class="group"><label>Target (Optimal)</label><div style="display:flex;gap:8px"><input type="text" id="rms_good_max_0"><input type="color" id="rms_good_color_0" class="color-rect"></div></div>
            <div class="group"><label>Warning (Caution)</label><div style="display:flex;gap:8px"><input type="text" id="rms_ok_max_0"><input type="color" id="rms_ok_color_0" class="color-rect"></div></div>
            <div class="group"><label>Critical Color</label><input type="color" id="rms_bad_color_0" class="color-rect" style="width:100%"></div>
          </div>
          <div class="threshold-sub"><h5>HFR</h5>
            <div class="group"><label>Target (Optimal)</label><div style="display:flex;gap:8px"><input type="text" id="hfr_good_max_0"><input type="color" id="hfr_good_color_0" class="color-rect"></div></div>
            <div class="group"><label>Warning (Caution)</label><div style="display:flex;gap:8px"><input type="text" id="hfr_ok_max_0"><input type="color" id="hfr_ok_color_0" class="color-rect"></div></div>
            <div class="group"><label>Critical Color</label><input type="color" id="hfr_bad_color_0" class="color-rect" style="width:100%"></div>
          </div>
        </div>

        <div class="threshold-node">
          <h4 id="tnode1">Node 2</h4>
          <div class="threshold-sub"><h5>Filters</h5><div id="filters_1" class="filter-grid"></div></div>
          <div class="threshold-sub"><h5>RMS</h5>
            <div class="group"><label>Target (Optimal)</label><div style="display:flex;gap:8px"><input type="text" id="rms_good_max_1"><input type="color" id="rms_good_color_1" class="color-rect"></div></div>
            <div class="group"><label>Warning (Caution)</label><div style="display:flex;gap:8px"><input type="text" id="rms_ok_max_1"><input type="color" id="rms_ok_color_1" class="color-rect"></div></div>
            <div class="group"><label>Critical Color</label><input type="color" id="rms_bad_color_1" class="color-rect" style="width:100%"></div>
          </div>
          <div class="threshold-sub"><h5>HFR</h5>
            <div class="group"><label>Target (Optimal)</label><div style="display:flex;gap:8px"><input type="text" id="hfr_good_max_1"><input type="color" id="hfr_good_color_1" class="color-rect"></div></div>
            <div class="group"><label>Warning (Caution)</label><div style="display:flex;gap:8px"><input type="text" id="hfr_ok_max_1"><input type="color" id="hfr_ok_color_1" class="color-rect"></div></div>
            <div class="group"><label>Critical Color</label><input type="color" id="hfr_bad_color_1" class="color-rect" style="width:100%"></div>
          </div>
        </div>

        <div class="threshold-node">
          <h4 id="tnode2">Node 3</h4>
          <div class="threshold-sub"><h5>Filters</h5><div id="filters_2" class="filter-grid"></div></div>
          <div class="threshold-sub"><h5>RMS</h5>
            <div class="group"><label>Target (Optimal)</label><div style="display:flex;gap:8px"><input type="text" id="rms_good_max_2"><input type="color" id="rms_good_color_2" class="color-rect"></div></div>
            <div class="group"><label>Warning (Caution)</label><div style="display:flex;gap:8px"><input type="text" id="rms_ok_max_2"><input type="color" id="rms_ok_color_2" class="color-rect"></div></div>
            <div class="group"><label>Critical Color</label><input type="color" id="rms_bad_color_2" class="color-rect" style="width:100%"></div>
          </div>
          <div class="threshold-sub"><h5>HFR</h5>
            <div class="group"><label>Target (Optimal)</label><div style="display:flex;gap:8px"><input type="text" id="hfr_good_max_2"><input type="color" id="hfr_good_color_2" class="color-rect"></div></div>
            <div class="group"><label>Warning (Caution)</label><div style="display:flex;gap:8px"><input type="text" id="hfr_ok_max_2"><input type="color" id="hfr_ok_color_2" class="color-rect"></div></div>
            <div class="group"><label>Critical Color</label><input type="color" id="hfr_bad_color_2" class="color-rect" style="width:100%"></div>
          </div>
        </div>

      </div>
    </div>

    <div class="tile area-firmware">
      <h3>Firmware Update</h3>
      <div class="firmware-info">
        <div class="firmware-info-item"><div class="label">Version</div><div class="value" id="fw_version">--</div></div>
        <div class="firmware-info-item"><div class="label">Built</div><div class="value" id="fw_date">--</div></div>
        <div class="firmware-info-item"><div class="label">IDF</div><div class="value" id="fw_idf">--</div></div>
        <div class="firmware-info-item"><div class="label">Partition</div><div class="value" id="fw_partition">--</div></div>
        <div class="firmware-info-item"><div class="label">Release</div><div class="value" id="fw_git_tag">--</div></div>
        <div class="firmware-info-item"><div class="label">Commit</div><div class="value" id="fw_git_sha">--</div></div>
      </div>
      <div class="ota-controls">
        <label class="ota-file-label" id="otaFileLabel" for="otaFile">Choose firmware .bin file</label>
        <input type="file" id="otaFile" accept=".bin" onchange="otaFileSelected(this)">
        <button class="btn btn-primary" id="otaBtn" onclick="startOta()" disabled style="flex:0 0 auto;width:auto;padding:14px 28px">UPDATE</button>
      </div>
      <div class="progress-wrap" id="otaProgress">
        <div class="progress-bar"><div class="progress-bar-fill" id="otaProgressFill"></div></div>
        <div class="ota-status" id="otaStatus"></div>
      </div>
    </div>

    <div class="tile area-actions">
      <h3>Actions</h3>
      <div class="action-row">
        <button class="btn btn-primary" id="saveBtn" onclick="save()">SAVE</button>
        <button class="btn btn-outline" onclick="saveAndReboot()">REBOOT</button>
        <button class="btn btn-danger" onclick="factoryReset()">FACTORY RESET</button>
      </div>
    </div>

  </div>
</div>
<script>
let filterColorsArr=[{},{},{}];
function renderFilterColors(i){const c=document.getElementById('filters_'+i);if(!c)return;c.innerHTML='';const obj=filterColorsArr[i];const fs=Object.keys(obj).sort();if(fs.length===0){c.innerHTML='<p style="color:var(--text-dim);font-style:italic;font-size:0.7rem">No filters</p>';return;}fs.slice(0,8).forEach(f=>{const w=document.createElement('div');w.className='filter-item';w.innerHTML=`<label>${f}</label><input type='color' class='color-dot' value='${obj[f]}' onchange='updateFilterColor(${i},"${f}",this.value)'>`;c.appendChild(w);});}
function updateFilterColor(i,n,v){filterColorsArr[i][n]=v;}
function updateNodeLabels(){['url1','url2','url3'].forEach((id,i)=>{const v=document.getElementById(id).value.trim();document.getElementById('tnode'+i).innerText=v||('Node '+(i+1));const lbl=document.getElementById('arp_lbl'+(i+1));if(lbl)lbl.innerText=v?('NINA '+(i+1)+': '+v):('NINA '+(i+1));});updatePageSelectOptions();}
function updatePageSelectOptions(){const sel=document.getElementById('active_page');if(!sel)return;['url1','url2','url3'].forEach((id,i)=>{const opt=sel.options[i+2];if(!opt)return;const v=document.getElementById(id).value.trim();opt.text=v?('NINA '+(i+1)+': '+v):('NINA '+(i+1));opt.disabled=!v;});}
function setPage(v){fetch('/api/page',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({page:parseInt(v)})});}
function setTheme(v){fetch('/api/theme',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({theme_index:parseInt(v)})});}
let brightTimer=null;function setBrightness(v){document.getElementById('bright_val').innerText=v+'%';clearTimeout(brightTimer);brightTimer=setTimeout(()=>{fetch('/api/brightness',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({brightness:parseInt(v)})});},150);}
let cbrightTimer=null;function setColorBrightness(v){document.getElementById('cbright_val').innerText=v+'%';clearTimeout(cbrightTimer);cbrightTimer=setTimeout(()=>{fetch('/api/color-brightness',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({color_brightness:parseInt(v)})});},150);}
function getRmsObj(i){return{good_max:parseFloat(document.getElementById('rms_good_max_'+i).value)||0.5,ok_max:parseFloat(document.getElementById('rms_ok_max_'+i).value)||1.0,good_color:document.getElementById('rms_good_color_'+i).value,ok_color:document.getElementById('rms_ok_color_'+i).value,bad_color:document.getElementById('rms_bad_color_'+i).value};}
function getHfrObj(i){return{good_max:parseFloat(document.getElementById('hfr_good_max_'+i).value)||2.0,ok_max:parseFloat(document.getElementById('hfr_ok_max_'+i).value)||3.5,good_color:document.getElementById('hfr_good_color_'+i).value,ok_color:document.getElementById('hfr_ok_color_'+i).value,bad_color:document.getElementById('hfr_bad_color_'+i).value};}
function getRotatePages(){let m=0;if(document.getElementById('arp_summary').checked)m|=0x01;if(document.getElementById('arp_nina1').checked)m|=0x02;if(document.getElementById('arp_nina2').checked)m|=0x04;if(document.getElementById('arp_nina3').checked)m|=0x08;if(document.getElementById('arp_sysinfo').checked)m|=0x10;return m;}
function setRotatePages(m){document.getElementById('arp_summary').checked=!!(m&0x01);document.getElementById('arp_nina1').checked=!!(m&0x02);document.getElementById('arp_nina2').checked=!!(m&0x04);document.getElementById('arp_nina3').checked=!!(m&0x08);document.getElementById('arp_sysinfo').checked=!!(m&0x10);}
function getConfigData(){const h1=document.getElementById('url1').value.trim();const h2=document.getElementById('url2').value.trim();const h3=document.getElementById('url3').value.trim();const u1=h1?'http://'+h1+':1888/v2/api/':'';const u2=h2?'http://'+h2+':1888/v2/api/':'';const u3=h3?'http://'+h3+':1888/v2/api/':'';const mb=document.getElementById('mqtt_broker').value.trim();const mu=mb?'mqtt://'+mb:'';const d={url1:u1,url2:u2,url3:u3,ntp:document.getElementById('ntp').value,timezone:document.getElementById('timezone').value,theme_index:parseInt(document.getElementById('theme_select').value),brightness:parseInt(document.getElementById('brightness').value),color_brightness:parseInt(document.getElementById('color_brightness').value),filter_colors_1:JSON.stringify(filterColorsArr[0]),filter_colors_2:JSON.stringify(filterColorsArr[1]),filter_colors_3:JSON.stringify(filterColorsArr[2]),rms_thresholds_1:JSON.stringify(getRmsObj(0)),rms_thresholds_2:JSON.stringify(getRmsObj(1)),rms_thresholds_3:JSON.stringify(getRmsObj(2)),hfr_thresholds_1:JSON.stringify(getHfrObj(0)),hfr_thresholds_2:JSON.stringify(getHfrObj(1)),hfr_thresholds_3:JSON.stringify(getHfrObj(2)),mqtt_enabled:document.getElementById('mqtt_enabled').checked,mqtt_broker_url:mu,mqtt_port:parseInt(document.getElementById('mqtt_port').value)||1883,mqtt_username:document.getElementById('mqtt_user').value,mqtt_password:document.getElementById('mqtt_pass').value,mqtt_topic_prefix:document.getElementById('mqtt_prefix').value||'ninadisplay',active_page_override:parseInt(document.getElementById('active_page').value),auto_rotate_enabled:document.getElementById('auto_rotate_enabled').checked,auto_rotate_interval_s:parseInt(document.getElementById('auto_rotate_interval').value)||30,auto_rotate_effect:parseInt(document.getElementById('auto_rotate_effect').value),auto_rotate_skip_disconnected:document.getElementById('auto_rotate_skip').checked,auto_rotate_pages:getRotatePages(),update_rate_s:parseInt(document.getElementById('update_rate').value)||2};const ss=document.getElementById('ssid').value;const pp=document.getElementById('pass').value;if(ss)d.ssid=ss;if(pp)d.pass=pp;return d;}
function loadThresholds(d,i,rkey,hkey){try{const r=JSON.parse(d[rkey]||'{}');document.getElementById('rms_good_max_'+i).value=r.good_max||0.5;document.getElementById('rms_ok_max_'+i).value=r.ok_max||1.0;document.getElementById('rms_good_color_'+i).value=r.good_color||'#10b981';document.getElementById('rms_ok_color_'+i).value=r.ok_color||'#eab308';document.getElementById('rms_bad_color_'+i).value=r.bad_color||'#ef4444';}catch(e){}try{const h=JSON.parse(d[hkey]||'{}');document.getElementById('hfr_good_max_'+i).value=h.good_max||2.0;document.getElementById('hfr_ok_max_'+i).value=h.ok_max||3.5;document.getElementById('hfr_good_color_'+i).value=h.good_color||'#10b981';document.getElementById('hfr_ok_color_'+i).value=h.ok_color||'#eab308';document.getElementById('hfr_bad_color_'+i).value=h.bad_color||'#ef4444';}catch(e){}}
function save(){const b=document.getElementById('saveBtn');const ot=b.innerText;b.innerText='SYNCING...';b.disabled=true;fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(getConfigData())}).then(r=>{if(r.ok){b.innerText='SUCCESS';setTimeout(()=>{b.innerText=ot;b.disabled=false;},2000);}else{b.innerText='ERROR';setTimeout(()=>{b.innerText=ot;b.disabled=false;},2000);}}).catch(()=>{b.innerText='FAIL';b.disabled=false;});}
function saveAndReboot(){if(!confirm('Apply changes and reboot now?'))return;fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(getConfigData())}).then(r=>{if(r.ok){fetch('/api/reboot',{method:'POST'});}else{r.json().then(j=>alert('Save failed: '+(j.error||r.statusText))).catch(()=>alert('Save failed: '+r.statusText));}}).catch(()=>alert('Save failed: network error'));}
function factoryReset(){if(confirm('Wipe all settings?')&&confirm('Confirm Reset?'))fetch('/api/factory-reset',{method:'POST'});}
function otaFileSelected(input){const lbl=document.getElementById('otaFileLabel');const btn=document.getElementById('otaBtn');if(input.files.length>0){lbl.textContent=input.files[0].name;lbl.classList.add('has-file');btn.disabled=false;}else{lbl.textContent='Choose firmware .bin file';lbl.classList.remove('has-file');btn.disabled=true;}}
function startOta(){const fileInput=document.getElementById('otaFile');if(!fileInput.files.length)return;const file=fileInput.files[0];if(!confirm('Update firmware to "'+file.name+'"?\nThe device will reboot after the update.'))return;const btn=document.getElementById('otaBtn');const wrap=document.getElementById('otaProgress');const fill=document.getElementById('otaProgressFill');const status=document.getElementById('otaStatus');btn.disabled=true;btn.textContent='UPLOADING...';wrap.style.display='block';fill.style.width='0%';status.textContent='Starting upload...';const xhr=new XMLHttpRequest();xhr.open('POST','/api/ota',true);xhr.setRequestHeader('Content-Type','application/octet-stream');xhr.upload.onprogress=function(e){if(e.lengthComputable){const pct=Math.round((e.loaded/e.total)*100);fill.style.width=pct+'%';status.textContent='Uploading: '+pct+'% ('+Math.round(e.loaded/1024)+' / '+Math.round(e.total/1024)+' KB)';}};xhr.onload=function(){if(xhr.status===200){fill.style.width='100%';status.textContent='Update complete! Rebooting device...';btn.textContent='REBOOTING';status.style.color='var(--accent)';}else{let msg='Upload failed';try{const j=JSON.parse(xhr.responseText);if(j.error)msg=j.error;}catch(e){}status.textContent='Error: '+msg;status.style.color='var(--danger)';btn.textContent='UPDATE';btn.disabled=false;}};xhr.onerror=function(){status.textContent='Network error during upload';status.style.color='var(--danger)';btn.textContent='UPDATE';btn.disabled=false;};xhr.send(file);}
fetch('/api/version').then(r=>r.json()).then(d=>{document.getElementById('fw_version').textContent=d.version||'--';document.getElementById('fw_date').textContent=(d.date||'')+' '+(d.time||'');document.getElementById('fw_idf').textContent=d.idf||'--';document.getElementById('fw_partition').textContent=d.partition||'--';const te=document.getElementById('fw_git_tag');if(d.git_tag&&d.git_tag!=='unknown'){const a=document.createElement('a');a.href='https://github.com/chvvkumar/ESP32-P4-NINA-Display/releases/tag/'+d.git_tag;a.target='_blank';a.rel='noopener';a.textContent=d.git_tag;a.style.cssText='color:var(--accent);text-decoration:none';te.textContent='';te.appendChild(a);}else{te.textContent=d.git_tag||'--';}const se=document.getElementById('fw_git_sha');if(d.git_sha&&d.git_sha!=='unknown'){const a=document.createElement('a');a.href='https://github.com/chvvkumar/ESP32-P4-NINA-Display/commit/'+d.git_sha;a.target='_blank';a.rel='noopener';a.textContent=d.git_sha;a.style.cssText='color:var(--accent);text-decoration:none;font-family:monospace';se.textContent='';se.appendChild(a);}else{se.textContent=d.git_sha||'--';}}).catch(()=>{});
fetch('/api/config').then(r=>r.json()).then(d=>{
  document.getElementById('ssid').value=d.ssid||'';
  /* Password is never returned from the API â€” leave blank */
  document.getElementById('ntp').value=d.ntp||'';
  document.getElementById('timezone').value=d.timezone||'';
  const extractHost=u=>{if(!u)return '';const m=u.match(/^https?:\/\/([^:/]+)/);return m?m[1]:u;};
  document.getElementById('url1').value=extractHost(d.url1);
  document.getElementById('url2').value=extractHost(d.url2);
  document.getElementById('url3').value=extractHost(d.url3||'');
  document.getElementById('theme_select').value=d.theme_index||0;
  var br=d.brightness!=null?d.brightness:50;document.getElementById('brightness').value=br;document.getElementById('bright_val').innerText=br+'%';
  var cb=d.color_brightness!=null?d.color_brightness:100;document.getElementById('color_brightness').value=cb;document.getElementById('cbright_val').innerText=cb+'%';
  document.getElementById('update_rate').value=d.update_rate_s||2;
  try{filterColorsArr[0]=JSON.parse(d.filter_colors_1||'{}');}catch(e){}
  try{filterColorsArr[1]=JSON.parse(d.filter_colors_2||'{}');}catch(e){}
  try{filterColorsArr[2]=JSON.parse(d.filter_colors_3||'{}');}catch(e){}
  renderFilterColors(0);renderFilterColors(1);renderFilterColors(2);
  loadThresholds(d,0,'rms_thresholds_1','hfr_thresholds_1');
  loadThresholds(d,1,'rms_thresholds_2','hfr_thresholds_2');
  loadThresholds(d,2,'rms_thresholds_3','hfr_thresholds_3');
  updateNodeLabels();
  document.getElementById('mqtt_enabled').checked=!!d.mqtt_enabled;
  const extractBrokerHost=u=>{if(!u)return '';const m=u.match(/^mqtts?:\/\/([^:/]+)/);return m?m[1]:u;};
  document.getElementById('mqtt_broker').value=extractBrokerHost(d.mqtt_broker_url);
  document.getElementById('mqtt_port').value=d.mqtt_port||1883;
  document.getElementById('mqtt_user').value=d.mqtt_username||'';
  document.getElementById('mqtt_pass').value=d.mqtt_password||'';
  document.getElementById('mqtt_prefix').value=d.mqtt_topic_prefix||'ninadisplay';
  document.getElementById('active_page').value=(d.active_page_override!=null)?d.active_page_override:-1;
  document.getElementById('auto_rotate_enabled').checked=!!d.auto_rotate_enabled;
  document.getElementById('auto_rotate_interval').value=d.auto_rotate_interval_s||30;
  document.getElementById('auto_rotate_effect').value=d.auto_rotate_effect||0;
  document.getElementById('auto_rotate_skip').checked=d.auto_rotate_skip_disconnected!==false;
  setRotatePages(d.auto_rotate_pages!=null?d.auto_rotate_pages:0x0E);
  updatePageSelectOptions();
});
</script>
</body>
</html>
