<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NINA Display</title>
  <style>
    /* === FOUNDATION === */
    :root {
      --bg: #0a0a0b;
      --surface: rgba(255, 255, 255, 0.035);
      --surface-hover: rgba(255, 255, 255, 0.06);
      --border: rgba(255, 255, 255, 0.08);
      --border-focus: rgba(var(--accent-rgb), 0.5);
      --accent: #14b8a6;
      --accent-rgb: 20, 184, 166;
      --accent-hover: #0d9488;
      --accent-glow: rgba(var(--accent-rgb), 0.15);
      --text: #f4f4f5;
      --text-muted: #a1a1aa;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --warning: #f59e0b;
      --success: #10b981;
      --radius: 16px;
      --radius-sm: 10px;
      --glass-blur: 20px;
      --glass-bg: rgba(255, 255, 255, 0.035);
      --glass-border: rgba(255, 255, 255, 0.08);
      --nav-height: 60px;
      --bottom-nav-height: 68px;
      --save-bar-height: 64px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(20, 184, 166, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(139, 92, 246, 0.04) 0%, transparent 50%),
        linear-gradient(180deg, #0d0d12 0%, #0a0a0b 100%);
      color: var(--text);
      line-height: 1.5;
      overflow-x: hidden;
      min-height: 100dvh;
    }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 20px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.04);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      border-color: rgba(255, 255, 255, 0.12);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.06);
    }

    .card-title {
      font-size: 0.7rem; font-weight: 700; color: var(--accent);
      text-transform: uppercase; letter-spacing: 0.08em;
      margin-bottom: 24px; opacity: 0.9;
      transition: color 0.4s ease;
    }

    .content { max-width: 960px; margin: 0 auto; padding: 28px 24px 100px; }

    .field { margin-bottom: 20px; }
    .field:last-child { margin-bottom: 0; }
    .field-label {
      display: block; font-size: 0.82rem; color: var(--text-muted);
      margin-bottom: 8px; font-weight: 500; letter-spacing: 0.01em;
    }
    .field-hint { font-size: 0.72rem; color: #71717a; margin-top: 6px; opacity: 0.7; }

    .divider { border: none; border-top: 1px solid rgba(255, 255, 255, 0.06); margin: 24px 0; }

    /* === NAVIGATION & LAYOUT === */
    .top-nav {
      position: sticky; top: 0; z-index: 100;
      background: rgba(10, 10, 11, 0.7);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; height: 60px;
    }
    .top-nav .brand {
      font-size: 0.95rem; font-weight: 700; letter-spacing: -0.02em;
      display: flex; align-items: center; gap: 10px;
    }
    .top-nav .brand .dot {
      width: 8px; height: 8px; border-radius: 50%; background: var(--accent);
      box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.4);
      transition: background 0.4s ease, box-shadow 0.4s ease;
    }
    .top-nav .tabs {
      display: flex; gap: 4px; background: rgba(255, 255, 255, 0.04);
      padding: 4px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.04);
    }
    .top-nav .tab-btn {
      background: none; border: none; color: #71717a; cursor: pointer;
      padding: 8px 18px; border-radius: 8px; font-size: 0.8rem; font-weight: 500;
      transition: all 0.25s ease; white-space: nowrap; position: relative;
    }
    .top-nav .tab-btn:hover { color: #f4f4f5; background: rgba(255, 255, 255, 0.04); }
    .top-nav .tab-btn.active {
      color: #f4f4f5; background: rgba(var(--accent-rgb), 0.12);
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.08);
    }
    .top-nav .github-link {
      color: #71717a; text-decoration: none; font-size: 0.75rem;
      display: flex; align-items: center; gap: 6px;
      padding: 7px 12px; border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 10px; transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.02);
    }
    .top-nav .github-link:hover { color: #f4f4f5; border-color: rgba(var(--accent-rgb), 0.3); }

    .bottom-nav {
      display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
      background: rgba(20, 20, 24, 0.85);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      height: 68px; padding: 0 8px;
    }
    .bottom-nav .nav-items {
      display: flex; height: 100%; align-items: center; justify-content: space-around;
    }
    .bottom-nav .nav-btn {
      background: none; border: none; color: #71717a; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      padding: 8px 14px; border-radius: 10px; font-size: 0.65rem;
      font-weight: 500; transition: all 0.25s ease; position: relative;
    }
    .bottom-nav .nav-btn svg { width: 20px; height: 20px; }
    .bottom-nav .nav-btn.active { color: var(--accent); }
    .bottom-nav .nav-btn.active::after {
      content: ''; position: absolute; bottom: 2px; left: 50%;
      transform: translateX(-50%); width: 20px; height: 3px; border-radius: 2px;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(var(--accent-rgb), 0.4);
      transition: background 0.4s ease, box-shadow 0.4s ease;
    }

    .tab-panel { display: none; animation: fadeIn 0.3s ease; }
    .tab-panel.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .sub-tabs { display: flex; gap: 6px; margin-bottom: 24px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .sub-tab {
      background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.06);
      color: #71717a; cursor: pointer; padding: 9px 18px; border-radius: 10px;
      font-size: 0.8rem; font-weight: 500; white-space: nowrap;
      transition: all 0.2s ease; font-family: inherit;
    }
    .sub-tab:hover { color: #f4f4f5; border-color: rgba(255, 255, 255, 0.12); }
    .sub-tab.active {
      color: #f4f4f5; background: rgba(var(--accent-rgb), 0.1);
      border-color: rgba(var(--accent-rgb), 0.3);
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.08);
    }
    .node-panel { display: none; }
    .node-panel.active { display: block; }

    .save-bar {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 90;
      background: rgba(20, 20, 24, 0.85);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(var(--accent-rgb), 0.15);
      padding: 10px 24px; display: flex; align-items: center;
      justify-content: flex-end; gap: 12px; height: 64px;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.3);
    }
    .save-bar.visible { transform: translateY(0); }
    .save-bar .changes-hint { font-size: 0.8rem; color: var(--accent); margin-right: auto; opacity: 0.8; }

    .toast {
      position: fixed; top: 76px; right: 24px; z-index: 200;
      background: rgba(20, 20, 24, 0.9);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 14px 22px; border-radius: 16px; font-size: 0.85rem;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
      transform: translateX(120%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .toast.show { transform: translateX(0); }
    .toast.success { border-left: 3px solid #10b981; box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(16, 185, 129, 0.08); }
    .toast.error { border-left: 3px solid #ef4444; box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(239, 68, 68, 0.08); }

    @media (max-width: 768px) {
      .top-nav .tabs, .top-nav .github-link { display: none; }
      .bottom-nav { display: block; }
      .content { padding: 16px 16px calc(68px + 64px + 16px); }
      .save-bar { bottom: 68px; }
      .toast { top: auto; bottom: calc(68px + 64px + 16px); right: 16px; }
    }

    /* === COMPONENTS === */
    .input {
      background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.06);
      color: #f4f4f5; padding: 11px 16px; border-radius: 10px;
      width: 100%; font-size: 0.875rem; min-height: 46px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      font-family: inherit;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    }
    .input:focus {
      outline: none; border-color: rgba(var(--accent-rgb), 0.5);
      box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.1), 0 0 20px rgba(var(--accent-rgb), 0.05);
      background: rgba(0, 0, 0, 0.4);
    }
    .input::placeholder { color: #71717a; opacity: 0.6; }
    select.input { cursor: pointer; appearance: none; -webkit-appearance: none; }

    .toggle { position: relative; display: inline-block; width: 48px; height: 26px; flex-shrink: 0; }
    .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
    .toggle-track {
      position: absolute; cursor: pointer; inset: 0;
      background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 26px; transition: all 0.3s ease;
    }
    .toggle-track::before {
      content: ''; position: absolute; height: 20px; width: 20px;
      left: 3px; bottom: 2px; background: #71717a;
      border-radius: 50%; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    .toggle input:checked + .toggle-track {
      background: rgba(var(--accent-rgb), 0.3); border-color: rgba(var(--accent-rgb), 0.4);
      box-shadow: 0 0 16px rgba(var(--accent-rgb), 0.15);
    }
    .toggle input:checked + .toggle-track::before {
      transform: translateX(22px); background: var(--accent);
      box-shadow: 0 0 8px rgba(var(--accent-rgb), 0.4);
    }

    .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; }
    .toggle-row .toggle-label { font-size: 0.875rem; }

    .slider-group { display: flex; align-items: center; gap: 14px; }
    .slider {
      flex: 1; height: 6px; appearance: none; -webkit-appearance: none;
      background: rgba(255, 255, 255, 0.08); border-radius: 3px; outline: none;
      transition: background 0.2s;
    }
    .slider::-webkit-slider-thumb {
      appearance: none; -webkit-appearance: none;
      width: 22px; height: 22px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
      border: 3px solid rgba(0, 0, 0, 0.3);
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.3), 0 2px 8px rgba(0, 0, 0, 0.4);
      transition: box-shadow 0.2s ease, transform 0.15s ease;
    }
    .slider::-webkit-slider-thumb:hover {
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.4), 0 2px 8px rgba(0, 0, 0, 0.4);
      transform: scale(1.1);
    }
    .slider::-moz-range-thumb {
      width: 22px; height: 22px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
      border: 3px solid rgba(0, 0, 0, 0.3);
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.3), 0 2px 8px rgba(0, 0, 0, 0.4);
    }
    .slider-val {
      font-size: 0.8rem; color: #a1a1aa; width: 40px; text-align: right;
      flex-shrink: 0; font-variant-numeric: tabular-nums;
    }

    .btn {
      border: none; border-radius: 10px; padding: 12px 22px; font-weight: 600;
      cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      min-height: 46px; font-family: inherit;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), rgba(var(--accent-rgb), 0.8));
      color: #0a0a0b; box-shadow: 0 4px 16px rgba(var(--accent-rgb), 0.2);
    }
    .btn-primary:hover { box-shadow: 0 4px 24px rgba(var(--accent-rgb), 0.35); transform: translateY(-1px); }
    .btn-primary:active { transform: translateY(0); }
    .btn-primary:disabled { opacity: 0.4; cursor: default; transform: none; box-shadow: none; }
    .btn-outline {
      background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.1); color: #a1a1aa;
    }
    .btn-outline:hover { border-color: rgba(255, 255, 255, 0.2); color: #f4f4f5; background: rgba(255, 255, 255, 0.06); }
    .btn-danger {
      background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.1); color: #a1a1aa;
    }
    .btn-danger:hover {
      border-color: rgba(239, 68, 68, 0.4); color: #ef4444;
      background: rgba(239, 68, 68, 0.06); box-shadow: 0 0 16px rgba(239, 68, 68, 0.1);
    }

    .color-swatch {
      width: 46px; height: 40px; padding: 0; border: 1px solid rgba(255, 255, 255, 0.1);
      background: none; border-radius: 10px; cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .color-swatch:hover { border-color: rgba(255, 255, 255, 0.2); }

    .filter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 10px; }
    .filter-chip {
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      padding: 12px 6px; border-radius: 10px;
      background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.04);
      transition: background 0.2s, border-color 0.2s;
    }
    .filter-chip:hover { background: rgba(255, 255, 255, 0.04); border-color: rgba(255, 255, 255, 0.08); }
    .filter-chip label {
      font-size: 0.65rem; color: #a1a1aa;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      max-width: 100%; text-align: center;
    }
    .filter-dot {
      width: 34px; height: 34px; border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; padding: 0;
      background: none; transition: transform 0.15s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .filter-dot:hover { transform: scale(1.08); }
    .filter-dot:active { transform: scale(0.95); }

    .row { display: flex; gap: 14px; align-items: flex-start; }
    .row > * { flex: 1; }
    @media (max-width: 768px) { .row.stack-mobile { flex-direction: column; } }

    .flex-wrap-gap { display: flex; flex-wrap: wrap; gap: 12px; }
    .flex-col-gap { display: flex; flex-direction: column; gap: 12px; }
    .arp-label {
      display: flex; align-items: center; gap: 12px; font-size: 0.875rem;
      cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: background 0.2s;
    }
    .arp-label:hover { background: rgba(255, 255, 255, 0.03); }
    .arp-cb { accent-color: var(--accent); width: 18px; height: 18px; }

    /* === PAGE MODE RADIO GROUP === */
    .page-mode-option {
      display: flex; align-items: flex-start; gap: 14px;
      padding: 16px; border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.04);
      background: rgba(255, 255, 255, 0.01);
      cursor: pointer; transition: all 0.25s ease; margin-bottom: 8px;
    }
    .page-mode-option:last-child { margin-bottom: 0; }
    .page-mode-option:hover { border-color: rgba(255, 255, 255, 0.1); background: rgba(255, 255, 255, 0.025); }
    .page-mode-option.selected {
      border-color: rgba(var(--accent-rgb), 0.4);
      background: rgba(var(--accent-rgb), 0.05);
      box-shadow: 0 0 16px rgba(var(--accent-rgb), 0.06);
    }
    .page-mode-radio {
      appearance: none; -webkit-appearance: none; width: 20px; height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.15); border-radius: 50%;
      background: transparent; cursor: pointer; flex-shrink: 0; margin-top: 2px;
      transition: all 0.2s ease; position: relative;
    }
    .page-mode-radio:checked {
      border-color: var(--accent); background: transparent;
    }
    .page-mode-radio:checked::after {
      content: ''; position: absolute; top: 3px; left: 3px;
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--accent); box-shadow: 0 0 6px rgba(var(--accent-rgb), 0.4);
    }
    .page-mode-body { flex: 1; min-width: 0; }
    .page-mode-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 2px; }
    .page-mode-desc { font-size: 0.75rem; color: var(--text-muted); line-height: 1.4; }
    .page-mode-details {
      margin-top: 16px; padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    .page-mode-details[hidden] { display: none; }

    /* === COLLAPSIBLE CARD === */
    .card-title-collapsible {
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; user-select: none; -webkit-user-select: none;
    }
    .card-title-collapsible:hover { opacity: 1; }
    .card-chevron {
      font-size: 0.65rem; transition: transform 0.3s ease;
      color: var(--text-muted); margin-left: 8px;
    }
    .card-chevron.collapsed { transform: rotate(-90deg); }
    .card-body-collapsible {
      overflow: hidden; transition: max-height 0.35s ease, opacity 0.25s ease;
      max-height: 800px; opacity: 1;
    }
    .card-body-collapsible.collapsed {
      max-height: 0; opacity: 0;
    }

    /* === FIRMWARE & OTA === */
    .fw-item {
      background: rgba(255, 255, 255, 0.02); padding: 12px 14px;
      border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.05);
      transition: border-color 0.2s;
    }
    .fw-item:hover { border-color: rgba(255, 255, 255, 0.1); }
    .fw-label { font-size: 0.65rem; color: #71717a; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 4px; }
    .fw-value { font-size: 0.85rem; font-weight: 600; word-break: break-all; }
    .fw-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 24px; }
    .ota-label {
      flex: 1; min-width: 200px; text-align: center;
      background: rgba(0, 0, 0, 0.2); border: 1px dashed rgba(255, 255, 255, 0.1);
      color: #71717a; padding: 14px 20px; border-radius: 10px; cursor: pointer;
      font-size: 0.85rem; transition: all 0.2s;
    }
    .ota-label:hover { border-color: rgba(var(--accent-rgb), 0.4); color: #f4f4f5; }
    .ota-label.has-file {
      border-color: rgba(var(--accent-rgb), 0.5); border-style: solid;
      color: var(--accent); background: rgba(var(--accent-rgb), 0.05);
    }
    .ota-bar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-top: 20px; }
    .progress-bg { background: rgba(255, 255, 255, 0.06); border-radius: 6px; height: 8px; overflow: hidden; }
    .progress-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--accent), rgba(var(--accent-rgb), 0.7));
      border-radius: 6px; transition: width 0.3s ease;
      box-shadow: 0 0 8px rgba(var(--accent-rgb), 0.3);
    }
    .progress-status { font-size: 0.8rem; color: #a1a1aa; margin-top: 10px; text-align: center; }

    /* === UTILITIES === */
    .hint-center { text-align: center; padding: 10px 0; }
    .accent-link { color: var(--accent); text-decoration: none; transition: opacity 0.2s; }
    .accent-link:hover { opacity: 0.8; }
    .mono-link { color: var(--accent); text-decoration: none; font-family: monospace; transition: opacity 0.2s; }
    .mono-link:hover { opacity: 0.8; }
  </style>
</head>
<body>

  <nav class="top-nav">
    <div class="brand"><span class="dot"></span> NINA Display</div>
    <div class="tabs" id="topTabs">
      <button class="tab-btn active" data-tab="main">Main</button>
      <button class="tab-btn" data-tab="network">Network</button>
      <button class="tab-btn" data-tab="nina">NINA</button>
      <button class="tab-btn" data-tab="system">System</button>
    </div>
    <a class="github-link" href="https://github.com/chvvkumar/ESP32-P4-NINA-Display" target="_blank" rel="noopener">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
      GitHub
    </a>
  </nav>

  <nav class="bottom-nav">
    <div class="nav-items" id="bottomTabs">
      <button class="nav-btn active" data-tab="main">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
        Main
      </button>
      <button class="nav-btn" data-tab="network">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12.55a11 11 0 0114.08 0M1.42 9a16 16 0 0121.16 0M8.53 16.11a6 6 0 016.95 0M12 20h.01"/></svg>
        Network
      </button>
      <button class="nav-btn" data-tab="nina">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
        NINA
      </button>
      <button class="nav-btn" data-tab="system">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
        System
      </button>
    </div>
  </nav>

  <main class="content">
    <div id="tab-main" class="tab-panel active">
      <div class="card">
        <div class="card-title">Appearance</div>
        <div class="field">
          <label class="field-label">Theme</label>
          <select class="input" id="theme_select" onchange="setTheme(this.value)">
            <option value="0">Bento Default</option>
            <option value="1">Red Night</option>
            <option value="2">Monochrome</option>
            <option value="3">Midnight Industrial</option>
          </select>
        </div>
        <div class="field">
          <label class="field-label">Backlight</label>
          <div class="slider-group">
            <input type="range" class="slider" id="brightness" min="0" max="100" value="80" oninput="setBrightness(this.value)">
            <span class="slider-val" id="brightness_val">80%</span>
          </div>
        </div>
        <div class="field">
          <label class="field-label">Text brightness</label>
          <div class="slider-group">
            <input type="range" class="slider" id="color_brightness" min="0" max="100" value="80" oninput="setColorBrightness(this.value)">
            <span class="slider-val" id="color_brightness_val">80%</span>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-title card-title-collapsible" onclick="togglePageMode()">
          <span>Page mode <span id="pm_summary" style="font-weight:400;text-transform:none;letter-spacing:0;color:var(--text-muted);font-size:0.7rem"></span></span>
          <span class="card-chevron collapsed" id="pm_chevron">&#9660;</span>
        </div>
        <div class="card-body-collapsible collapsed" id="pm_body">

        <label class="page-mode-option" id="pm_auto_opt" onclick="setPageMode('auto')">
          <input type="radio" name="page_mode" value="auto" class="page-mode-radio" id="pm_auto">
          <div class="page-mode-body">
            <div class="page-mode-title">Auto</div>
            <div class="page-mode-desc">Start on Summary, navigate manually via swipe or button</div>
          </div>
        </label>

        <label class="page-mode-option" id="pm_fixed_opt" onclick="setPageMode('fixed')">
          <input type="radio" name="page_mode" value="fixed" class="page-mode-radio" id="pm_fixed">
          <div class="page-mode-body">
            <div class="page-mode-title">Fixed</div>
            <div class="page-mode-desc">Pin display to a specific page on boot</div>
            <div class="page-mode-details" id="pm_fixed_details" hidden>
              <div class="field">
                <label class="field-label">Page</label>
                <select class="input" id="active_page" onchange="setPage(this.value)">
                  <option value="0">Summary</option>
                  <option value="1">NINA 1</option>
                  <option value="2">NINA 2</option>
                  <option value="3">NINA 3</option>
                  <option value="4">Settings</option>
                  <option value="5">System Info</option>
                </select>
              </div>
            </div>
          </div>
        </label>

        <label class="page-mode-option" id="pm_rotate_opt" onclick="setPageMode('rotate')">
          <input type="radio" name="page_mode" value="rotate" class="page-mode-radio" id="pm_rotate">
          <div class="page-mode-body">
            <div class="page-mode-title">Rotate</div>
            <div class="page-mode-desc">Automatically cycle through selected pages</div>
            <div class="page-mode-details" id="pm_rotate_details" hidden>
              <div class="field">
                <label class="field-label">Interval (seconds)</label>
                <input type="number" class="input" id="auto_rotate_interval" min="4" max="3600" value="30">
              </div>
              <div class="field">
                <label class="field-label">Transition</label>
                <select class="input" id="auto_rotate_effect">
                  <option value="0">Instant</option>
                  <option value="1">Fade</option>
                  <option value="2">Slide Left</option>
                  <option value="3">Slide Right</option>
                </select>
              </div>
              <div class="toggle-row">
                <span class="toggle-label">Skip disconnected nodes</span>
                <label class="toggle"><input type="checkbox" id="auto_rotate_skip"><span class="toggle-track"></span></label>
              </div>
              <div style="margin-top:16px">
                <label class="field-label">Pages in rotation</label>
                <div class="flex-col-gap" id="arp-container" style="margin-top:8px"></div>
              </div>
            </div>
          </div>
        </label>

        </div>
      </div>
      <div class="card">
        <div class="card-title">Data rates</div>
        <div class="field">
          <label class="field-label">Data update rate (seconds)</label>
          <input type="number" class="input" id="update_rate" min="1" max="10" value="2">
        </div>
        <div class="field">
          <label class="field-label">Graph update rate (seconds)</label>
          <input type="number" class="input" id="graph_interval" min="2" max="30" value="5">
        </div>
      </div>
    </div>
    <div id="tab-network" class="tab-panel">
      <div class="card">
        <div class="card-title">WiFi</div>
        <div class="field">
          <label class="field-label">SSID</label>
          <input type="text" class="input" id="ssid" placeholder="Network name">
        </div>
        <div class="field">
          <label class="field-label">Password</label>
          <input type="password" class="input" id="pass" placeholder="Enter new password to change">
          <div class="field-hint">Password is stored in WiFi hardware and not readable.</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Time</div>
        <div class="field">
          <label class="field-label">NTP server</label>
          <input type="text" class="input" id="ntp" placeholder="pool.ntp.org">
        </div>
        <div class="field">
          <label class="field-label">Timezone</label>
          <select class="input" id="timezone">
            <option value="">UTC (default)</option>
            <option value="GMT0">GMT</option>
            <option value="GMT0BST,M3.5.0/1,M10.5.0">UK (GMT/BST)</option>
            <option value="CET-1CEST,M3.5.0,M10.5.0/3">Central Europe (CET/CEST)</option>
            <option value="EET-2EEST,M3.5.0/3,M10.5.0/4">Eastern Europe (EET/EEST)</option>
            <option value="EST5EDT,M3.2.0,M11.1.0">US Eastern (EST/EDT)</option>
            <option value="CST6CDT,M3.2.0,M11.1.0">US Central (CST/CDT)</option>
            <option value="MST7MDT,M3.2.0,M11.1.0">US Mountain (MST/MDT)</option>
            <option value="MST7">US Arizona (MST, no DST)</option>
            <option value="PST8PDT,M3.2.0,M11.1.0">US Pacific (PST/PDT)</option>
            <option value="AKST9AKDT,M3.2.0,M11.1.0">US Alaska (AKST/AKDT)</option>
            <option value="HST10">US Hawaii (HST, no DST)</option>
            <option value="AEST-10AEDT,M10.1.0,M4.1.0/3">Australia Eastern (AEST/AEDT)</option>
            <option value="ACST-9:30ACDT,M10.1.0,M4.1.0/3">Australia Central (ACST/ACDT)</option>
            <option value="AWST-8">Australia Western (AWST, no DST)</option>
            <option value="NZST-12NZDT,M9.5.0,M4.1.0/3">New Zealand (NZST/NZDT)</option>
            <option value="JST-9">Japan (JST)</option>
            <option value="CST-8">China (CST)</option>
            <option value="IST-5:30">India (IST)</option>
            <option value="<-03>3">Argentina (ART)</option>
            <option value="<-03>3<-02>,M10.3.0/0,M2.3.0/0">Brazil (BRT/BRST)</option>
            <option value="SAST-2">South Africa (SAST)</option>
          </select>
        </div>
      </div>
      <div class="card">
        <div class="card-title">MQTT</div>
        <div class="toggle-row">
          <span class="toggle-label">Enable MQTT</span>
          <label class="toggle"><input type="checkbox" id="mqtt_enabled"><span class="toggle-track"></span></label>
        </div>
        <div class="field">
          <label class="field-label">Broker host</label>
          <input type="text" class="input" id="mqtt_broker" placeholder="192.168.1.250">
        </div>
        <div class="row stack-mobile">
          <div class="field">
            <label class="field-label">Port</label>
            <input type="text" class="input" id="mqtt_port" placeholder="1883">
          </div>
          <div class="field">
            <label class="field-label">Topic prefix</label>
            <input type="text" class="input" id="mqtt_prefix" placeholder="ninadisplay">
          </div>
        </div>
        <div class="row stack-mobile">
          <div class="field">
            <label class="field-label">Username</label>
            <input type="text" class="input" id="mqtt_user" placeholder="Username">
          </div>
          <div class="field">
            <label class="field-label">Password</label>
            <input type="password" class="input" id="mqtt_pass" placeholder="Password">
          </div>
        </div>
      </div>
      <div class="field-hint hint-center">Reboot required after changing WiFi, NTP, timezone, or MQTT settings.</div>
    </div>
    <div id="tab-nina" class="tab-panel">
      <div class="sub-tabs">
        <button class="sub-tab active" data-node="0">Node 1</button>
        <button class="sub-tab" data-node="1">Node 2</button>
        <button class="sub-tab" data-node="2">Node 3</button>
      </div>
      <div id="node-panels"></div>
    </div>
    <div id="tab-system" class="tab-panel">
      <div class="card">
        <div class="card-title">Firmware</div>
        <div class="fw-grid">
          <div class="fw-item"><div class="fw-label">Version</div><div class="fw-value" id="fw_version">--</div></div>
          <div class="fw-item"><div class="fw-label">Built</div><div class="fw-value" id="fw_date">--</div></div>
          <div class="fw-item"><div class="fw-label">IDF</div><div class="fw-value" id="fw_idf">--</div></div>
          <div class="fw-item"><div class="fw-label">Partition</div><div class="fw-value" id="fw_partition">--</div></div>
          <div class="fw-item"><div class="fw-label">Release</div><div class="fw-value" id="fw_git_tag">--</div></div>
          <div class="fw-item"><div class="fw-label">Commit</div><div class="fw-value" id="fw_git_sha">--</div></div>
        </div>
        <div class="divider"></div>
        <div class="ota-bar">
          <label class="ota-label" id="otaFileLabel">
            Choose firmware .bin file
            <input type="file" id="otaFile" accept=".bin" style="display:none" onchange="otaFileSelected(this)">
          </label>
          <button class="btn btn-primary" id="otaBtn" disabled onclick="startOta()">Update</button>
        </div>
        <div id="otaProgress" style="display:none;margin-top:16px">
          <div class="progress-bg">
            <div id="otaProgressFill" class="progress-fill"></div>
          </div>
          <div id="otaStatus" class="progress-status"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Device</div>
        <div class="flex-wrap-gap">
          <button class="btn btn-outline" onclick="saveAndReboot()">Reboot</button>
          <button class="btn btn-danger" onclick="factoryReset()">Factory Reset</button>
        </div>
      </div>
    </div>
  </main>

  <div class="save-bar" id="saveBar">
    <span class="changes-hint">Unsaved changes</span>
    <button class="btn btn-outline" onclick="reloadConfig()">Discard</button>
    <button class="btn btn-primary" id="saveBtn" onclick="save()">Save</button>
  </div>
  <div class="toast" id="toast"></div>

  <script>
    const $=id=>document.getElementById(id);
    const $$=s=>document.querySelectorAll(s);

    /* ---- Generate Node Panels ---- */
    (function(){
      const c=$('node-panels');
      const placeholders=['192.168.1.100','192.168.1.101','192.168.1.102'];
      for(let i=0;i<3;i++){
        const n=i,urlId='url'+(i+1);
        const active=i===0?' active':'';
        c.insertAdjacentHTML('beforeend',
          '<div class="node-panel'+active+'" data-node-panel="'+i+'">'+
          '<div class="card"><div class="card-title">Endpoint</div>'+
          '<div class="field"><label class="field-label">Hostname / IP</label>'+
          '<input type="text" class="input" id="'+urlId+'" placeholder="'+placeholders[i]+'" oninput="updateNodeLabels()">'+
          '</div></div>'+
          '<div class="card"><div class="card-title">Filter colors</div>'+
          '<div id="filters_'+i+'" class="filter-grid"></div></div>'+
          '<div class="row stack-mobile">'+
          '<div class="card"><div class="card-title">RMS thresholds</div>'+
          mkThresholdFields('rms',i,'Target (optimal)','0.5','Warning (caution)','1.0')+
          '</div>'+
          '<div class="card"><div class="card-title">HFR thresholds</div>'+
          mkThresholdFields('hfr',i,'Target (optimal)','2.0','Warning (caution)','3.5')+
          '</div></div></div>'
        );
      }
      function mkThresholdFields(pfx,i,lbl1,ph1,lbl2,ph2){
        return '<div class="field"><label class="field-label">'+lbl1+'</label>'+
          '<div class="row"><input type="text" class="input" id="'+pfx+'_good_max_'+i+'" placeholder="'+ph1+'">'+
          '<input type="color" class="color-swatch" id="'+pfx+'_good_color_'+i+'" value="#10b981"></div></div>'+
          '<div class="field"><label class="field-label">'+lbl2+'</label>'+
          '<div class="row"><input type="text" class="input" id="'+pfx+'_ok_max_'+i+'" placeholder="'+ph2+'">'+
          '<input type="color" class="color-swatch" id="'+pfx+'_ok_color_'+i+'" value="#eab308"></div></div>'+
          '<div class="field"><label class="field-label">Critical</label>'+
          '<input type="color" class="color-swatch" id="'+pfx+'_bad_color_'+i+'" value="#ef4444"></div>';
      }
    })();

    /* ---- Generate Rotation Page Checkboxes ---- */
    (function(){
      const items=[
        ['arp_summary','Summary'],
        ['arp_nina1','<span id="arp_lbl1">NINA 1</span>'],
        ['arp_nina2','<span id="arp_lbl2">NINA 2</span>'],
        ['arp_nina3','<span id="arp_lbl3">NINA 3</span>'],
        ['arp_settings','Settings'],
        ['arp_sysinfo','System Info']
      ];
      const c=$('arp-container');
      items.forEach(function(it){
        c.insertAdjacentHTML('beforeend',
          '<label class="arp-label"><input type="checkbox" id="'+it[0]+'" class="arp-cb"> '+it[1]+'</label>'
        );
      });
    })();

    /* ---- Adaptive Accent Colors ---- */
    const tabAccents={
      main:   {color:'#14b8a6', rgb:'20, 184, 166'},
      network:{color:'#3b82f6', rgb:'59, 130, 246'},
      nina:   {color:'#8b5cf6', rgb:'139, 92, 246'},
      system: {color:'#f43f5e', rgb:'244, 63, 94'}
    };

    function setAccent(name){
      const a=tabAccents[name]||tabAccents.main;
      const r=document.documentElement.style;
      r.setProperty('--accent',a.color);
      r.setProperty('--accent-rgb',a.rgb);
    }

    /* ---- Tab Navigation ---- */
    function switchTab(name) {
      $$('.tab-panel').forEach(p=>p.classList.remove('active'));
      $$('.tab-btn, .nav-btn').forEach(b=>b.classList.remove('active'));
      const panel=$('tab-'+name);
      if(panel) panel.classList.add('active');
      $$('[data-tab="'+name+'"]').forEach(b=>b.classList.add('active'));
      setAccent(name);
      try{localStorage.setItem('nina_tab',name);}catch(e){}
    }

    $$('.tab-btn, .nav-btn').forEach(btn=>{
      btn.addEventListener('click',()=>switchTab(btn.dataset.tab));
    });

    try{
      const saved=localStorage.getItem('nina_tab');
      if(saved&&$('tab-'+saved)) switchTab(saved);
      else setAccent('main');
    }catch(e){}

    /* ---- Node Sub-Tab Switching ---- */
    function switchNode(idx) {
      $$('.sub-tab').forEach(b=>b.classList.remove('active'));
      $$('.node-panel').forEach(p=>p.classList.remove('active'));
      const btn=document.querySelector('.sub-tab[data-node="'+idx+'"]');
      const panel=document.querySelector('.node-panel[data-node-panel="'+idx+'"]');
      if(btn) btn.classList.add('active');
      if(panel) panel.classList.add('active');
    }

    $$('.sub-tab').forEach(btn=>{
      btn.addEventListener('click',()=>switchNode(btn.dataset.node));
    });

    /* ---- Live API Controls ---- */
    const postJson=(url,body)=>fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});

    function setTheme(v){postJson('/api/theme',{theme_index:parseInt(v)})}

    let _brightTimer=null;
    function setBrightness(v){
      $('brightness_val').textContent=v+'%';
      clearTimeout(_brightTimer);
      _brightTimer=setTimeout(()=>postJson('/api/brightness',{brightness:parseInt(v)}),150);
    }

    let _colorTimer=null;
    function setColorBrightness(v){
      $('color_brightness_val').textContent=v+'%';
      clearTimeout(_colorTimer);
      _colorTimer=setTimeout(()=>postJson('/api/color-brightness',{color_brightness:parseInt(v)}),150);
    }

    function setPage(v){postJson('/api/page',{page:parseInt(v)})}

    /* ---- Page Mode ---- */
    function togglePageMode(){
      var body=$('pm_body'), chev=$('pm_chevron');
      body.classList.toggle('collapsed');
      chev.classList.toggle('collapsed');
    }

    function updatePageModeSummary(){
      var mode=getPageMode();
      var labels={auto:'Auto',fixed:'Fixed',rotate:'Rotate'};
      $('pm_summary').textContent='\u2014 '+labels[mode];
    }

    function setPageMode(mode){
      $('pm_auto').checked=(mode==='auto');
      $('pm_fixed').checked=(mode==='fixed');
      $('pm_rotate').checked=(mode==='rotate');

      $$('.page-mode-option').forEach(o=>o.classList.remove('selected'));
      $('pm_'+mode+'_opt').classList.add('selected');

      $('pm_fixed_details').hidden=(mode!=='fixed');
      $('pm_rotate_details').hidden=(mode!=='rotate');

      updatePageModeSummary();
      checkDirty();
    }

    function getPageMode(){
      if($('pm_rotate').checked) return 'rotate';
      if($('pm_fixed').checked) return 'fixed';
      return 'auto';
    }

    /* ---- Filter Colors ---- */
    let filterColorsArr=[{},{},{}];

    function renderFilterColors(i){
      const container=$('filters_'+i);
      if(!container) return;
      container.innerHTML='';
      const names=Object.keys(filterColorsArr[i]);
      if(!names.length){
        container.innerHTML='<i style="color:var(--text-muted);font-size:0.8rem">No filters</i>';
        return;
      }
      names.forEach(name=>{
        const chip=document.createElement('div');
        chip.className='filter-chip';
        const lbl=document.createElement('label');
        lbl.textContent=name;
        const dot=document.createElement('input');
        dot.type='color';
        dot.className='filter-dot';
        dot.value=filterColorsArr[i][name]||'#ffffff';
        dot.addEventListener('input',()=>{filterColorsArr[i][name]=dot.value;checkDirty();});
        chip.appendChild(dot);
        chip.appendChild(lbl);
        container.appendChild(chip);
      });
    }

    /* ---- Node Labels ---- */
    function updateNodeLabels(){
      const urls=[$('url1').value.trim(),$('url2').value.trim(),$('url3').value.trim()];
      $$('.sub-tab').forEach((btn,idx)=>{btn.textContent=urls[idx]||'Node '+(idx+1);});
      for(let n=1;n<=3;n++){
        const lbl=$('arp_lbl'+n);
        if(lbl) lbl.textContent=urls[n-1]||'NINA '+n;
      }
      updatePageSelectOptions();
    }

    function updatePageSelectOptions(){
      const sel=$('active_page');
      if(!sel) return;
      const urls=[$('url1').value.trim(),$('url2').value.trim(),$('url3').value.trim()];
      const cnt=urls.filter(u=>u.length>0).length||1;
      const prev=sel.value;
      sel.innerHTML='';
      sel.add(new Option('Summary','0'));
      for(let i=0;i<cnt;i++) sel.add(new Option(urls[i]||'NINA '+(i+1),''+(i+1)));
      sel.add(new Option('Settings',''+(cnt+1)));
      sel.add(new Option('System Info',''+(cnt+2)));
      if([...sel.options].some(o=>o.value===prev)) sel.value=prev;
      else sel.value='0';
    }

    /* ---- Threshold Helpers ---- */
    function getThreshObj(pfx,i,defGood,defOk){
      return {
        good_max:parseFloat($(pfx+'_good_max_'+i).value)||defGood,
        ok_max:parseFloat($(pfx+'_ok_max_'+i).value)||defOk,
        good_color:$(pfx+'_good_color_'+i).value,
        ok_color:$(pfx+'_ok_color_'+i).value,
        bad_color:$(pfx+'_bad_color_'+i).value
      };
    }
    function getRmsObj(i){return getThreshObj('rms',i,0.5,1.0)}
    function getHfrObj(i){return getThreshObj('hfr',i,2.0,3.5)}

    function loadThresholds(data,nodeIdx,rmsKey,hfrKey){
      const rmsDef={good_max:0.5,ok_max:1.0,good_color:'#10b981',ok_color:'#eab308',bad_color:'#ef4444'};
      const hfrDef={good_max:2.0,ok_max:3.5,good_color:'#10b981',ok_color:'#eab308',bad_color:'#ef4444'};
      let rms=rmsDef,hfr=hfrDef;
      try{if(data[rmsKey]) rms=Object.assign({},rmsDef,JSON.parse(data[rmsKey]));}catch(e){}
      try{if(data[hfrKey]) hfr=Object.assign({},hfrDef,JSON.parse(data[hfrKey]));}catch(e){}
      ['good_max','ok_max','good_color','ok_color','bad_color'].forEach(k=>{
        const re=$('rms_'+k+'_'+nodeIdx);
        const he=$('hfr_'+k+'_'+nodeIdx);
        if(re) re.value=rms[k];
        if(he) he.value=hfr[k];
      });
    }

    /* ---- Rotation Page Bitmask ---- */
    const arpIds=['arp_summary','arp_nina1','arp_nina2','arp_nina3','arp_sysinfo','arp_settings'];
    const arpBits=[0x01,0x02,0x04,0x08,0x10,0x20];

    function getRotatePages(){
      let mask=0;
      arpIds.forEach((id,i)=>{if($(id).checked) mask|=arpBits[i];});
      return mask;
    }

    function setRotatePages(mask){
      arpIds.forEach((id,i)=>{$(id).checked=!!(mask&arpBits[i]);});
    }

    /* ---- Config Data Assembly ---- */
    function getConfigData(){
      const host1=$('url1').value.trim();
      const host2=$('url2').value.trim();
      const host3=$('url3').value.trim();
      const mqttHost=$('mqtt_broker').value.trim();
      const mkUrl=h=>h?'http://'+h+':1888/v2/api/':'';

      const data={
        url1:mkUrl(host1),url2:mkUrl(host2),url3:mkUrl(host3),
        ntp:$('ntp').value.trim(),
        timezone:$('timezone').value,
        theme_index:parseInt($('theme_select').value),
        brightness:parseInt($('brightness').value),
        color_brightness:parseInt($('color_brightness').value),
        filter_colors_1:JSON.stringify(filterColorsArr[0]),
        filter_colors_2:JSON.stringify(filterColorsArr[1]),
        filter_colors_3:JSON.stringify(filterColorsArr[2]),
        rms_thresholds_1:JSON.stringify(getRmsObj(0)),
        rms_thresholds_2:JSON.stringify(getRmsObj(1)),
        rms_thresholds_3:JSON.stringify(getRmsObj(2)),
        hfr_thresholds_1:JSON.stringify(getHfrObj(0)),
        hfr_thresholds_2:JSON.stringify(getHfrObj(1)),
        hfr_thresholds_3:JSON.stringify(getHfrObj(2)),
        mqtt_enabled:!!$('mqtt_enabled').checked,
        mqtt_broker_url:mqttHost?'mqtt://'+mqttHost:'',
        mqtt_port:parseInt($('mqtt_port').value)||1883,
        mqtt_username:$('mqtt_user').value,
        mqtt_password:$('mqtt_pass').value,
        mqtt_topic_prefix:$('mqtt_prefix').value.trim(),
        active_page_override:getPageMode()==='fixed'?parseInt($('active_page').value):-1,
        auto_rotate_enabled:getPageMode()==='rotate',
        auto_rotate_interval_s:parseInt($('auto_rotate_interval').value)||30,
        auto_rotate_effect:parseInt($('auto_rotate_effect').value),
        auto_rotate_skip_disconnected:!!$('auto_rotate_skip').checked,
        auto_rotate_pages:getRotatePages(),
        update_rate_s:parseInt($('update_rate').value)||2,
        graph_update_interval_s:parseInt($('graph_interval').value)||5
      };

      const ssid=$('ssid').value.trim();
      const pass=$('pass').value;
      if(ssid) data.ssid=ssid;
      if(pass) data.pass=pass;

      return data;
    }

    /* ---- Config Load ---- */
    let loadedConfig='';
    let _populating=false;

    function populateConfig(data){
      _populating=true;
      $('ssid').value=data.ssid||'';
      $('ntp').value=data.ntp||'';
      $('timezone').value=data.timezone||'';

      function extractHost(url){
        if(!url) return '';
        const m=url.match(/^https?:\/\/([^:/]+)/);
        return m?m[1]:'';
      }

      $('url1').value=extractHost(data.url1);
      $('url2').value=extractHost(data.url2);
      $('url3').value=extractHost(data.url3);

      $('theme_select').value=data.theme_index||0;
      const br=data.brightness!=null?data.brightness:80;
      $('brightness').value=br;
      $('brightness_val').textContent=br+'%';
      const cb=data.color_brightness!=null?data.color_brightness:80;
      $('color_brightness').value=cb;
      $('color_brightness_val').textContent=cb+'%';
      $('update_rate').value=data.update_rate_s||2;
      $('graph_interval').value=data.graph_update_interval_s||5;

      for(let i=0;i<3;i++){
        const key='filter_colors_'+(i+1);
        try{filterColorsArr[i]=data[key]?JSON.parse(data[key]):{};}catch(e){filterColorsArr[i]={};}
        renderFilterColors(i);
      }

      loadThresholds(data,0,'rms_thresholds_1','hfr_thresholds_1');
      loadThresholds(data,1,'rms_thresholds_2','hfr_thresholds_2');
      loadThresholds(data,2,'rms_thresholds_3','hfr_thresholds_3');

      const mqttUrl=data.mqtt_broker_url||'';
      const mqttMatch=mqttUrl.match(/^mqtt:\/\/(.+)/);
      $('mqtt_broker').value=mqttMatch?mqttMatch[1]:'';
      $('mqtt_port').value=data.mqtt_port||1883;
      $('mqtt_user').value=data.mqtt_username||'';
      $('mqtt_pass').value=data.mqtt_password||'';
      $('mqtt_prefix').value=data.mqtt_topic_prefix||'';
      $('mqtt_enabled').checked=!!data.mqtt_enabled;

      /* Page mode: derive from active_page_override + auto_rotate_enabled */
      var pageMode='auto';
      if(data.auto_rotate_enabled) pageMode='rotate';
      else if(data.active_page_override!=null&&data.active_page_override>=0) pageMode='fixed';

      $('auto_rotate_interval').value=data.auto_rotate_interval_s||30;
      $('auto_rotate_effect').value=data.auto_rotate_effect||0;
      $('auto_rotate_skip').checked=!!data.auto_rotate_skip_disconnected;
      setRotatePages(data.auto_rotate_pages!=null?data.auto_rotate_pages:0x1F);

      updateNodeLabels();
      updatePageSelectOptions();
      $('active_page').value=(data.active_page_override!=null&&data.active_page_override>=0)?''+data.active_page_override:'0';
      setPageMode(pageMode);

      $('pass').value='';
      loadedConfig=JSON.stringify(getConfigData());
      _populating=false;
      checkDirty();
    }

    function loadConfig(){
      fetch('/api/config').then(r=>r.json()).then(populateConfig).catch(e=>console.error('Failed to load config',e));
    }

    /* ---- Version Load ---- */
    function loadVersion(){
      fetch('/api/version').then(r=>r.json()).then(data=>{
        $('fw_version').textContent=data.version||'--';
        $('fw_date').textContent=(data.date||'--')+' '+(data.time||'');
        $('fw_idf').textContent=data.idf_version||'--';
        $('fw_partition').textContent=data.partition||'--';

        const ghBase='https://github.com/chvvkumar/ESP32-P4-NINA-Display/';
        const tagEl=$('fw_git_tag');
        if(data.git_tag&&data.git_tag!=='unknown'){
          tagEl.innerHTML='<a href="'+ghBase+'releases/tag/'+encodeURIComponent(data.git_tag)+'" target="_blank" rel="noopener" class="accent-link">'+data.git_tag+'</a>';
        }else{
          tagEl.textContent=data.git_tag||'--';
        }

        const shaEl=$('fw_git_sha');
        if(data.git_sha&&data.git_sha!=='unknown'){
          shaEl.innerHTML='<a href="'+ghBase+'commit/'+encodeURIComponent(data.git_sha)+'" target="_blank" rel="noopener" class="mono-link">'+data.git_sha.substring(0,8)+'</a>';
        }else{
          shaEl.textContent=data.git_sha||'--';
        }
      }).catch(e=>console.error('Failed to load version',e));
    }

    /* ---- Toast ---- */
    function showToast(msg,type){
      const t=$('toast');
      t.textContent=msg;
      t.className='toast '+(type||'')+' show';
      clearTimeout(t._timer);
      t._timer=setTimeout(()=>{t.classList.remove('show');},3000);
    }

    /* ---- Save ---- */
    function save(){
      const btn=$('saveBtn');
      btn.disabled=true;
      btn.textContent='Saving...';
      postJson('/api/config',getConfigData()).then(r=>{
        if(!r.ok) throw new Error('Save failed');
        return r.text();
      }).then(()=>{
        showToast('Settings saved','success');
        loadedConfig=JSON.stringify(getConfigData());
        $('saveBar').classList.remove('visible');
      }).catch(e=>{
        showToast('Save failed: '+e.message,'error');
      }).finally(()=>{
        btn.disabled=false;
        btn.textContent='Save';
      });
    }

    function reloadConfig(){
      loadConfig();
      $('saveBar').classList.remove('visible');
    }

    /* ---- Save and Reboot ---- */
    function saveAndReboot(){
      if(!confirm('Apply changes and reboot now?')) return;
      postJson('/api/config',getConfigData()).then(r=>{
        if(!r.ok) throw new Error('Save failed');
        return fetch('/api/reboot',{method:'POST'});
      }).then(()=>{
        showToast('Rebooting...','success');
      }).catch(e=>{
        showToast('Error: '+e.message,'error');
      });
    }

    /* ---- Factory Reset ---- */
    function factoryReset(){
      if(!confirm('Wipe all settings?')) return;
      if(!confirm('Confirm Reset?')) return;
      fetch('/api/factory-reset',{method:'POST'}).then(()=>{
        showToast('Factory reset. Rebooting...','success');
      }).catch(e=>{
        showToast('Reset failed: '+e.message,'error');
      });
    }

    /* ---- OTA ---- */
    function otaFileSelected(input){
      const label=$('otaFileLabel');
      if(input.files.length>0){
        label.textContent=input.files[0].name;
        label.classList.add('has-file');
        label.appendChild(input);
        $('otaBtn').disabled=false;
      }else{
        label.textContent='Choose firmware .bin file';
        label.classList.remove('has-file');
        label.appendChild(input);
        $('otaBtn').disabled=true;
      }
    }

    function startOta(){
      const fileInput=$('otaFile');
      if(!fileInput.files.length) return;
      if(!confirm('Flash new firmware? The device will reboot after update.')) return;

      const file=fileInput.files[0];
      const progressDiv=$('otaProgress');
      const fill=$('otaProgressFill');
      const status=$('otaStatus');
      const btn=$('otaBtn');

      progressDiv.style.display='block';
      btn.disabled=true;
      fill.style.width='0%';
      status.textContent='Uploading...';

      const xhr=new XMLHttpRequest();
      xhr.open('POST','/api/ota',true);
      xhr.setRequestHeader('Content-Type','application/octet-stream');

      xhr.upload.addEventListener('progress',function(e){
        if(e.lengthComputable){
          const pct=Math.round((e.loaded/e.total)*100);
          fill.style.width=pct+'%';
          status.textContent='Uploading... '+pct+'%';
        }
      });

      xhr.addEventListener('load',function(){
        if(xhr.status>=200&&xhr.status<300){
          fill.style.width='100%';
          status.textContent='Update complete! Rebooting...';
          showToast('Firmware updated. Rebooting...','success');
        }else{
          status.textContent='Update failed (HTTP '+xhr.status+')';
          showToast('OTA failed','error');
          btn.disabled=false;
        }
      });

      xhr.addEventListener('error',function(){
        status.textContent='Upload error';
        showToast('OTA upload error','error');
        btn.disabled=false;
      });

      xhr.send(file);
    }

    /* ---- Dirty State Detection ---- */
    function checkDirty(){
      if(_populating) return;
      const dirty=JSON.stringify(getConfigData())!==loadedConfig;
      $('saveBar').classList.toggle('visible',dirty);
    }

    document.querySelector('.content').addEventListener('input',checkDirty);
    document.querySelector('.content').addEventListener('change',checkDirty);

    /* ---- Init ---- */
    loadConfig();
    loadVersion();
  </script>
</body>
</html>
