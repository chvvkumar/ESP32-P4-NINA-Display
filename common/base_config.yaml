# external_components:
#   - source:
#       type: local
#       path: waveshare-example

packages:
  ha_entities: !include ha_entity_config.yaml

esphome:
  name_add_mac_suffix: false
  on_boot:
    priority: 600  # After hardware initialization (priority 600 runs early)
    then:
      - light.turn_on:
          id: backlight_light
          brightness: 10%

esp32:
  board: esp32-p4-evboard
  flash_size: 32MB
  framework:
    components:
      - espressif/esp_hosted==2.11.3
    type: esp-idf
    version: recommended
    advanced:
      enable_idf_experimental_features: true
  cpu_frequency: 360MHz

logger:
  level: info
  logs:
    lvgl: info
  hardware_uart: UART0

web_server:
  port: 80
  version: 3
  local: true
  log: true
  include_internal: True

psram:
  speed: 200MHz

esp_ldo:
  - channel: 3
    voltage: 2.5V

wifi:
  power_save_mode: NONE
#  fast_connect: True
  post_connect_roaming: False
  output_power: 15.0dBm
  networks:
    - ssid: !secret wifi_ssid
      password: !secret wifi_password
      hidden: true

api:
  encryption:
    key: !secret api_encryption_key
  on_client_connected:
    - delay: 2s
    # Restore backlight to normal after boot tasks complete
    - light.turn_on:
        id: backlight_light
        brightness: 20%
    - script.execute: refresh_main_page

ota:
  - platform: esphome

script:
  - id: refresh_main_page
    then:
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_cpu_temp}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_ssd_temp}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_sqm}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_starcount}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_ambient_temp}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_humidity}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_dew_point}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_power}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_voltage}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_current}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_cloud_status}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_dew_heater}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_fan}" }

  - id: refresh_nina2_page
    then:
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina2_cam_temp}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina2_exp_num}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina2_exp_time}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina2_stars}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina2_hfr}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina2_sat_pixels}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina2_rms}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina2_ra_rms}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina2_dec_rms}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina2_filter}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina2_target}" }
      # Shared sensors
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_cloud_status}" }

  - id: refresh_nina3_page
    then:
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina3_cam_temp}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina3_exp_num}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina3_exp_time}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina3_stars}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina3_hfr}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina3_sat_pixels}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina3_rms}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina3_ra_rms}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina3_dec_rms}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina3_filter}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_nina3_target}" }
      # Shared sensors
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_cloud_status}" }

  - id: refresh_plants_page
    then:
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_plant_spider}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_moisture_spider}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_plant_jade}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_moisture_jade}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_plant_pothos}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_moisture_pothos}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_plant_begonia}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_moisture_begonia}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_plant_monstera}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_moisture_monstera}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_plant_nerve}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_moisture_nerve}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_plant_aglaonema}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_moisture_aglaonema}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_plant_croton}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_moisture_croton}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_plant_elephant}" }
      - homeassistant.service:
          service: homeassistant.update_entity
          data: { entity_id: "${entity_moisture_elephant}" }
