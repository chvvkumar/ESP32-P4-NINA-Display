sensor:
  - platform: homeassistant
    id: ha_cpu_temp
    entity_id: sensor.allskypi5_cpu_temp
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          float min = id(set_cpu_min).state;
          float max = id(set_cpu_max).state;
          if (max <= min) max = min + 1;
          float ratio = (x - min) / (max - min);
          if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
          lv_bar_set_value(id(bar_cpu_temp), (int32_t)(ratio * 100), LV_ANIM_OFF);
          int r = (int)(id(g_cpu_c1_r) + ratio * (id(g_cpu_c2_r) - id(g_cpu_c1_r)));
          int g = (int)(id(g_cpu_c1_g) + ratio * (id(g_cpu_c2_g) - id(g_cpu_c1_g)));
          int b = (int)(id(g_cpu_c1_b) + ratio * (id(g_cpu_c2_b) - id(g_cpu_c1_b)));
          lv_color_t c = lv_color_make(r, g, b);
          lv_obj_set_style_bg_color(id(bar_cpu_temp), c, LV_PART_INDICATOR);
          if (id(match_text_color).state) lv_obj_set_style_text_color(id(lbl_cpu_temp_val), c, LV_PART_MAIN);
          else lv_obj_set_style_text_color(id(lbl_cpu_temp_val), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_cpu_temp_val), "%s%2d.%d°", (x < 0 ? "-" : ""), val_int, val_dec);

  - platform: homeassistant
    id: ha_ssd_temp
    entity_id: sensor.allskypi5_disk_ssd_temp
    filters:
      - throttle: 10s
    on_value:
      - lambda: |- 
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_ssd_temp_val), "SSD: %s%2d.%d°C", (x < 0 ? "-" : ""), val_int, val_dec);

  - platform: homeassistant
    id: ha_sqm
    entity_id: sensor.sqm_reader_tsl2591_sqm
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          float min = id(set_sqm_min).state;
          float max = id(set_sqm_max).state;
          if (max <= min) max = min + 0.1;
          float ratio = (x - min) / (max - min);
          if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
          int r = (int)(id(g_sqm_c1_r) + ratio * (id(g_sqm_c2_r) - id(g_sqm_c1_r)));
          int g = (int)(id(g_sqm_c1_g) + ratio * (id(g_sqm_c2_g) - id(g_sqm_c1_g)));
          int b = (int)(id(g_sqm_c1_b) + ratio * (id(g_sqm_c2_b) - id(g_sqm_c1_b)));
          lv_color_t c = lv_color_make(r, g, b);
          if (id(match_text_color).state) lv_obj_set_style_text_color(id(lbl_sqm_val), c, LV_PART_MAIN);
          else lv_obj_set_style_text_color(id(lbl_sqm_val), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 100.0 + 0.5);
          if (val_dec >= 100) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_sqm_val), "%d.%02d", val_int, val_dec);

  - platform: homeassistant
    id: ha_starcount
    entity_id: sensor.allskypi5_as_starcount
    filters:
      - throttle: 10s
    on_value:
      - lambda: |- 
          lv_label_set_text_fmt(id(lbl_star_count), "Stars: %d", (int)x);

  - platform: homeassistant
    id: ha_enclosure_temp
    entity_id: sensor.allskypi5_as_dewcontrolambient
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          float min = id(set_env_min).state;
          float max = id(set_env_max).state;
          if (max <= min) max = min + 1;
          float ratio = (x - min) / (max - min);
          if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
          lv_bar_set_value(id(bar_enclosure), (int32_t)(ratio * 100), LV_ANIM_OFF);
          int r = (int)(id(g_env_c1_r) + ratio * (id(g_env_c2_r) - id(g_env_c1_r)));
          int g = (int)(id(g_env_c1_g) + ratio * (id(g_env_c2_g) - id(g_env_c1_g)));
          int b = (int)(id(g_env_c1_b) + ratio * (id(g_env_c2_b) - id(g_env_c1_b)));
          lv_color_t c = lv_color_make(r, g, b);
          lv_obj_set_style_bg_color(id(bar_enclosure), c, LV_PART_INDICATOR);
          if (id(match_text_color).state) lv_obj_set_style_text_color(id(lbl_enclosure_temp_val), c, LV_PART_MAIN);
          else lv_obj_set_style_text_color(id(lbl_enclosure_temp_val), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_enclosure_temp_val), "%s%2d.%d°", (x < 0 ? "-" : ""), val_int, val_dec);

  - platform: homeassistant
    id: ha_enclosure_humidity
    entity_id: sensor.allskypi5_as_dewcontrolhumidity
    filters:
      - throttle: 10s
    on_value:
      - lambda: |- 
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_humidity_val), "HUM: %2d.%d%%", val_int, val_dec);

  - platform: homeassistant
    id: ha_dew_point
    entity_id: sensor.allskypi5_as_dewcontroldew
    filters:
      - throttle: 10s
    on_value:
      - lambda: |- 
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_dew_val), "DEW: %s%2d.%d°C", (x < 0 ? "-" : ""), val_int, val_dec);

  - platform: homeassistant
    id: ha_power
    entity_id: sensor.sqm_reader_ina260_power
    filters:
      - throttle: 3s
    on_value:
      - lambda: |- 
          float min = id(set_pwr_min).state;
          float max = id(set_pwr_max).state;
          if (max <= min) max = min + 1;
          float ratio = (x - min) / (max - min);
          if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
          lv_bar_set_value(id(bar_power), (int32_t)(ratio * 100), LV_ANIM_OFF);
          int r = (int)(id(g_pwr_c1_r) + ratio * (id(g_pwr_c2_r) - id(g_pwr_c1_r)));
          int g = (int)(id(g_pwr_c1_g) + ratio * (id(g_pwr_c2_g) - id(g_pwr_c1_g)));
          int b = (int)(id(g_pwr_c1_b) + ratio * (id(g_pwr_c2_b) - id(g_pwr_c1_b)));
          lv_color_t c = lv_color_make(r, g, b);
          lv_obj_set_style_bg_color(id(bar_power), c, LV_PART_INDICATOR);
          if (id(match_text_color).state) lv_obj_set_style_text_color(id(lbl_power_val), c, LV_PART_MAIN);
          else lv_obj_set_style_text_color(id(lbl_power_val), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_power_val), "%2d.%d", val_int, val_dec);

  - platform: homeassistant
    id: ha_voltage
    entity_id: sensor.sqm_reader_ina260_voltage
    filters:
      - throttle: 3s
    on_value:
      - lambda: |- 
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_voltage_val), "%2d.%dV", val_int, val_dec);

  - platform: homeassistant
    id: ha_current
    entity_id: sensor.sqm_reader_ina260_current
    filters:
      - throttle: 3s
    on_value:
      - lambda: |- 
          float abs_v = fabsf(x);
          int val_int = (int)abs_v;
          int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
          if (val_dec >= 10) { val_int++; val_dec = 0; }
          lv_label_set_text_fmt(id(lbl_current_val), "%2d.%dA", val_int, val_dec);

  # --- NINA2/3 Sensors ---
  - platform: homeassistant
    id: nina2_camera_temp
    entity_id: sensor.nina2_camera_temperature
    filters:
      - throttle: 10s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_cam_temp), "%s%2d.%d°C", (x < 0 ? "-" : ""), val_int, val_dec);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina2_cam_temp_min).state;
              float max = id(set_nina2_cam_temp_max).state;
              if (max <= min) max = min + 1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina2_cam_temp_c1_r) + ratio * (id(g_nina2_cam_temp_c2_r) - id(g_nina2_cam_temp_c1_r)));
              int g = (int)(id(g_nina2_cam_temp_c1_g) + ratio * (id(g_nina2_cam_temp_c2_g) - id(g_nina2_cam_temp_c1_g)));
              int b = (int)(id(g_nina2_cam_temp_c1_b) + ratio * (id(g_nina2_cam_temp_c2_b) - id(g_nina2_cam_temp_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina2_cam_temp), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else { lv_label_set_text(id(lbl_nina2_cam_temp), "--"); }

  - platform: homeassistant
    id: nina2_exposure_num
    entity_id: sensor.nina2_exposure_number
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina2_exp_num), "%d", (int)x);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina2_exp_num_min).state;
              float max = id(set_nina2_exp_num_max).state;
              if (max <= min) max = min + 1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina2_exp_num_c1_r) + ratio * (id(g_nina2_exp_num_c2_r) - id(g_nina2_exp_num_c1_r)));
              int g = (int)(id(g_nina2_exp_num_c1_g) + ratio * (id(g_nina2_exp_num_c2_g) - id(g_nina2_exp_num_c1_g)));
              int b = (int)(id(g_nina2_exp_num_c1_b) + ratio * (id(g_nina2_exp_num_c2_b) - id(g_nina2_exp_num_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina2_exp_num), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else lv_label_set_text(id(lbl_nina2_exp_num), "--");

  - platform: homeassistant
    id: nina2_exposure_time
    entity_id: sensor.nina2_exposure_time
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_exp_time), "%d.%dS", val_int, val_dec);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina2_exp_time_min).state;
              float max = id(set_nina2_exp_time_max).state;
              if (max <= min) max = min + 1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina2_exp_time_c1_r) + ratio * (id(g_nina2_exp_time_c2_r) - id(g_nina2_exp_time_c1_r)));
              int g = (int)(id(g_nina2_exp_time_c1_g) + ratio * (id(g_nina2_exp_time_c2_g) - id(g_nina2_exp_time_c1_g)));
              int b = (int)(id(g_nina2_exp_time_c1_b) + ratio * (id(g_nina2_exp_time_c2_b) - id(g_nina2_exp_time_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina2_exp_time), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else { lv_label_set_text(id(lbl_nina2_exp_time), "--"); }

  - platform: homeassistant
    id: nina2_detected_stars
    entity_id: sensor.nina2_star_detectedstars
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina2_stars), "%d", (int)x);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina2_stars_min).state;
              float max = id(set_nina2_stars_max).state;
              if (max <= min) max = min + 1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina2_stars_c1_r) + ratio * (id(g_nina2_stars_c2_r) - id(g_nina2_stars_c1_r)));
              int g = (int)(id(g_nina2_stars_c1_g) + ratio * (id(g_nina2_stars_c2_g) - id(g_nina2_stars_c1_g)));
              int b = (int)(id(g_nina2_stars_c1_b) + ratio * (id(g_nina2_stars_c2_b) - id(g_nina2_stars_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina2_stars), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else lv_label_set_text(id(lbl_nina2_stars), "--");

  # --- UPBA Power Sensors for NINA2 ---
  - platform: homeassistant
    id: upba_current
    entity_id: sensor.upba_current
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 100.0 + 0.5);
            if (val_dec >= 100) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_current), "%d.%02dA", val_int, val_dec);
          } else lv_label_set_text(id(lbl_nina2_current), "--");

  - platform: homeassistant
    id: upba_primary_heater
    entity_id: sensor.upba_primary_heater
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_heater), "%d.%dA", val_int, val_dec);
          } else lv_label_set_text(id(lbl_nina2_heater), "--");

  - platform: homeassistant
    id: upba_power
    entity_id: sensor.upba_power
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina2_power), "%dW", (int)x);
          } else lv_label_set_text(id(lbl_nina2_power), "--");

  - platform: homeassistant
    id: nina2_hfr
    entity_id: sensor.nina2_star_hfr
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 100.0 + 0.5);
            if (val_dec >= 100) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_hfr), "%d.%02d", val_int, val_dec);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina2_hfr_min).state;
              float max = id(set_nina2_hfr_max).state;
              if (max <= min) max = min + 0.1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina2_hfr_c1_r) + ratio * (id(g_nina2_hfr_c2_r) - id(g_nina2_hfr_c1_r)));
              int g = (int)(id(g_nina2_hfr_c1_g) + ratio * (id(g_nina2_hfr_c2_g) - id(g_nina2_hfr_c1_g)));
              int b = (int)(id(g_nina2_hfr_c1_b) + ratio * (id(g_nina2_hfr_c2_b) - id(g_nina2_hfr_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina2_hfr), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else { lv_label_set_text(id(lbl_nina2_hfr), "--"); }

  - platform: homeassistant
    id: nina2_saturated_pixels
    entity_id: sensor.nina2_target_max_saturated_pixels
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina2_sat_px), "%d Px", (int)x);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina2_sat_px_min).state;
              float max = id(set_nina2_sat_px_max).state;
              if (max <= min) max = min + 1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina2_sat_px_c1_r) + ratio * (id(g_nina2_sat_px_c2_r) - id(g_nina2_sat_px_c1_r)));
              int g = (int)(id(g_nina2_sat_px_c1_g) + ratio * (id(g_nina2_sat_px_c2_g) - id(g_nina2_sat_px_c1_g)));
              int b = (int)(id(g_nina2_sat_px_c1_b) + ratio * (id(g_nina2_sat_px_c2_b) - id(g_nina2_sat_px_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina2_sat_px), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else lv_label_set_text(id(lbl_nina2_sat_px), "--");

  - platform: homeassistant
    id: nina2_total_rms
    entity_id: sensor.nina2_total_rms
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 100.0 + 0.5);
            if (val_dec >= 100) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_rms), "%d.%02d", val_int, val_dec);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina2_rms_min).state;
              float max = id(set_nina2_rms_max).state;
              if (max <= min) max = min + 0.1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina2_rms_c1_r) + ratio * (id(g_nina2_rms_c2_r) - id(g_nina2_rms_c1_r)));
              int g = (int)(id(g_nina2_rms_c1_g) + ratio * (id(g_nina2_rms_c2_g) - id(g_nina2_rms_c1_g)));
              int b = (int)(id(g_nina2_rms_c1_b) + ratio * (id(g_nina2_rms_c2_b) - id(g_nina2_rms_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina2_rms), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else { lv_label_set_text(id(lbl_nina2_rms), "--"); }

  - platform: homeassistant
    id: nina2_ra_rms
    entity_id: sensor.nina_instance_2_nina2_ra_rms
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_ra_rms), "RA:    %d.%d\"", val_int, val_dec);
          } else { lv_label_set_text(id(lbl_nina2_ra_rms), "RA:    --"); }

  - platform: homeassistant
    id: nina2_dec_rms
    entity_id: sensor.nina_instance_2_nina2_dec_rms
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina2_dec_rms), "DEC: %d.%d\"", val_int, val_dec);
          } else { lv_label_set_text(id(lbl_nina2_dec_rms), "DEC: --"); }

  - platform: homeassistant
    id: nina3_camera_temp
    entity_id: sensor.nina3_camera_temperature
    filters:
      - throttle: 10s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_cam_temp), "%s%2d.%d°C", (x < 0 ? "-" : ""), val_int, val_dec);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina3_cam_temp_min).state;
              float max = id(set_nina3_cam_temp_max).state;
              if (max <= min) max = min + 1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina3_cam_temp_c1_r) + ratio * (id(g_nina3_cam_temp_c2_r) - id(g_nina3_cam_temp_c1_r)));
              int g = (int)(id(g_nina3_cam_temp_c1_g) + ratio * (id(g_nina3_cam_temp_c2_g) - id(g_nina3_cam_temp_c1_g)));
              int b = (int)(id(g_nina3_cam_temp_c1_b) + ratio * (id(g_nina3_cam_temp_c2_b) - id(g_nina3_cam_temp_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina3_cam_temp), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else { lv_label_set_text(id(lbl_nina3_cam_temp), "--"); }

  - platform: homeassistant
    id: nina3_exposure_num
    entity_id: sensor.nina3_exposure_number
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina3_exp_num), "%d", (int)x);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina3_exp_num_min).state;
              float max = id(set_nina3_exp_num_max).state;
              if (max <= min) max = min + 1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina3_exp_num_c1_r) + ratio * (id(g_nina3_exp_num_c2_r) - id(g_nina3_exp_num_c1_r)));
              int g = (int)(id(g_nina3_exp_num_c1_g) + ratio * (id(g_nina3_exp_num_c2_g) - id(g_nina3_exp_num_c1_g)));
              int b = (int)(id(g_nina3_exp_num_c1_b) + ratio * (id(g_nina3_exp_num_c2_b) - id(g_nina3_exp_num_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina3_exp_num), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else lv_label_set_text(id(lbl_nina3_exp_num), "--");

  - platform: homeassistant
    id: nina3_exposure_time
    entity_id: sensor.nina3_exposure_time
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_exp_time), "%d.%dS", val_int, val_dec);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina3_exp_time_min).state;
              float max = id(set_nina3_exp_time_max).state;
              if (max <= min) max = min + 1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina3_exp_time_c1_r) + ratio * (id(g_nina3_exp_time_c2_r) - id(g_nina3_exp_time_c1_r)));
              int g = (int)(id(g_nina3_exp_time_c1_g) + ratio * (id(g_nina3_exp_time_c2_g) - id(g_nina3_exp_time_c1_g)));
              int b = (int)(id(g_nina3_exp_time_c1_b) + ratio * (id(g_nina3_exp_time_c2_b) - id(g_nina3_exp_time_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina3_exp_time), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else { lv_label_set_text(id(lbl_nina3_exp_time), "--"); }

  - platform: homeassistant
    id: nina3_detected_stars
    entity_id: sensor.nina3_star_detectedstars
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina3_stars), "%d", (int)x);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina3_stars_min).state;
              float max = id(set_nina3_stars_max).state;
              if (max <= min) max = min + 1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina3_stars_c1_r) + ratio * (id(g_nina3_stars_c2_r) - id(g_nina3_stars_c1_r)));
              int g = (int)(id(g_nina3_stars_c1_g) + ratio * (id(g_nina3_stars_c2_g) - id(g_nina3_stars_c1_g)));
              int b = (int)(id(g_nina3_stars_c1_b) + ratio * (id(g_nina3_stars_c2_b) - id(g_nina3_stars_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina3_stars), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else lv_label_set_text(id(lbl_nina3_stars), "--");

  - platform: homeassistant
    id: nina3_hfr
    entity_id: sensor.nina3_star_hfr
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 100.0 + 0.5);
            if (val_dec >= 100) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_hfr), "%d.%02d", val_int, val_dec);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina3_hfr_min).state;
              float max = id(set_nina3_hfr_max).state;
              if (max <= min) max = min + 0.1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina3_hfr_c1_r) + ratio * (id(g_nina3_hfr_c2_r) - id(g_nina3_hfr_c1_r)));
              int g = (int)(id(g_nina3_hfr_c1_g) + ratio * (id(g_nina3_hfr_c2_g) - id(g_nina3_hfr_c1_g)));
              int b = (int)(id(g_nina3_hfr_c1_b) + ratio * (id(g_nina3_hfr_c2_b) - id(g_nina3_hfr_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina3_hfr), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else { lv_label_set_text(id(lbl_nina3_hfr), "--"); }

  - platform: homeassistant
    id: nina3_saturated_pixels
    entity_id: sensor.nina3_target_max_saturated_pixels
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            lv_label_set_text_fmt(id(lbl_nina3_sat_px), "%d Px", (int)x);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina3_sat_px_min).state;
              float max = id(set_nina3_sat_px_max).state;
              if (max <= min) max = min + 1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina3_sat_px_c1_r) + ratio * (id(g_nina3_sat_px_c2_r) - id(g_nina3_sat_px_c1_r)));
              int g = (int)(id(g_nina3_sat_px_c1_g) + ratio * (id(g_nina3_sat_px_c2_g) - id(g_nina3_sat_px_c1_g)));
              int b = (int)(id(g_nina3_sat_px_c1_b) + ratio * (id(g_nina3_sat_px_c2_b) - id(g_nina3_sat_px_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina3_sat_px), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else lv_label_set_text(id(lbl_nina3_sat_px), "--");

  - platform: homeassistant
    id: nina3_total_rms
    entity_id: sensor.nina3_total_rms
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_rms), "%d.%d", val_int, val_dec);
            // Update color if match_text_color is enabled
            if (id(match_text_color).state) {
              float min = id(set_nina3_rms_min).state;
              float max = id(set_nina3_rms_max).state;
              if (max <= min) max = min + 0.1;
              float ratio = (x - min) / (max - min);
              if (ratio < 0.0) ratio = 0.0; else if (ratio > 1.0) ratio = 1.0;
              int r = (int)(id(g_nina3_rms_c1_r) + ratio * (id(g_nina3_rms_c2_r) - id(g_nina3_rms_c1_r)));
              int g = (int)(id(g_nina3_rms_c1_g) + ratio * (id(g_nina3_rms_c2_g) - id(g_nina3_rms_c1_g)));
              int b = (int)(id(g_nina3_rms_c1_b) + ratio * (id(g_nina3_rms_c2_b) - id(g_nina3_rms_c1_b)));
              lv_obj_set_style_text_color(id(lbl_nina3_rms), lv_color_make(r, g, b), LV_PART_MAIN);
            }
          } else { lv_label_set_text(id(lbl_nina3_rms), "--"); }

  - platform: homeassistant
    id: nina3_ra_rms
    entity_id: sensor.nina_instance_3_nina3_ra_rms
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_ra_rms), "RA:   %d.%d\"", val_int, val_dec);
          } else { lv_label_set_text(id(lbl_nina3_ra_rms), "RA:   --"); }

  - platform: homeassistant
    id: nina3_dec_rms
    entity_id: sensor.nina_instance_3_nina3_dec_rms
    filters:
      - throttle: 5s
    on_value:
      - lambda: |- 
          if (!isnan(x)) {
            float abs_v = fabsf(x);
            int val_int = (int)abs_v;
            int val_dec = (int)((abs_v - val_int) * 10.0 + 0.5);
            if (val_dec >= 10) { val_int++; val_dec = 0; }
            lv_label_set_text_fmt(id(lbl_nina3_dec_rms), "DEC: %d.%d\"", val_int, val_dec);
          } else { lv_label_set_text(id(lbl_nina3_dec_rms), "DEC: --"); }

text_sensor:
  - platform: homeassistant
    id: ha_cloud_status
    entity_id: sensor.allskypi5_cloud_detector_status
    filters:
      - lambda: |-
          static uint32_t last_update = 0;
          if (last_update != 0 && millis() - last_update < 10000) return {};
          last_update = millis();
          return x;
    on_value:
      - lambda: |- 
          lv_label_set_text(id(lbl_cloud_status), x.c_str());
          lv_label_set_text(id(lbl_nina2_cloud_detector), x.c_str());
          lv_label_set_text(id(lbl_nina3_cloud_detector), x.c_str());

  - platform: homeassistant
    id: nina2_filter
    entity_id: sensor.nina2_filter_wheel_filter
    filters:
      - lambda: |-
          static uint32_t last_update = 0;
          if (last_update != 0 && millis() - last_update < 2000) return {};
          last_update = millis();
          return x;
    on_value:
      - lambda: |- 
          // Reset all filters to muted
          lv_obj_remove_style(id(lbl_nina2_filter_l), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_l), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_l), (lv_style_t *)id(style_clr_l), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina2_filter_r), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_r), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_r), (lv_style_t *)id(style_clr_r), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina2_filter_g), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_g), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_g), (lv_style_t *)id(style_clr_g), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina2_filter_b), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_b), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_b), (lv_style_t *)id(style_clr_b), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina2_filter_sii), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_sii), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_sii), (lv_style_t *)id(style_clr_sii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina2_filter_ha), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_ha), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_ha), (lv_style_t *)id(style_clr_ha), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina2_filter_oiii), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_oiii), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina2_filter_oiii), (lv_style_t *)id(style_clr_oiii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          // Activate the current filter
          std::string filter = x.c_str();
          if (filter == "L" || filter == "Lum" || filter == "Luminance") {
            lv_obj_remove_style(id(lbl_nina2_filter_l), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_l), (lv_style_t *)id(style_filter_active_l), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_l), (lv_style_t *)id(style_clr_l), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "R" || filter == "Red") {
            lv_obj_remove_style(id(lbl_nina2_filter_r), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_r), (lv_style_t *)id(style_filter_active_r), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_r), (lv_style_t *)id(style_clr_r), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "G" || filter == "Green") {
            lv_obj_remove_style(id(lbl_nina2_filter_g), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_g), (lv_style_t *)id(style_filter_active_g), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_g), (lv_style_t *)id(style_clr_g), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "B" || filter == "Blue") {
            lv_obj_remove_style(id(lbl_nina2_filter_b), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_b), (lv_style_t *)id(style_filter_active_b), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_b), (lv_style_t *)id(style_clr_b), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "Ha" || filter == "H-Alpha" || filter == "Halpha") {
            lv_obj_remove_style(id(lbl_nina2_filter_ha), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_ha), (lv_style_t *)id(style_filter_active_ha), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_ha), (lv_style_t *)id(style_clr_ha), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "Oiii" || filter == "OIII" || filter == "O-III") {
            lv_obj_remove_style(id(lbl_nina2_filter_oiii), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_oiii), (lv_style_t *)id(style_filter_active_oiii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_oiii), (lv_style_t *)id(style_clr_oiii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "Sii" || filter == "SII" || filter.find("ii") != std::string::npos) {
            lv_obj_remove_style(id(lbl_nina2_filter_sii), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_sii), (lv_style_t *)id(style_filter_active_sii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina2_filter_sii), (lv_style_t *)id(style_clr_sii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          }
  - platform: homeassistant
    id: nina2_target
    entity_id: sensor.nina2_target_name
    filters:
      - lambda: |-
          static uint32_t last_update = 0;
          if (last_update != 0 && millis() - last_update < 30000) return {};
          last_update = millis();
          return x;
    on_value:
      - lambda: |- 
          lv_label_set_text(id(lbl_nina2_target), x.c_str());

  - platform: homeassistant
    id: nina3_filter
    entity_id: sensor.nina3_filter_wheel_filter
    filters:
      - lambda: |-
          static uint32_t last_update = 0;
          if (last_update != 0 && millis() - last_update < 2000) return {};
          last_update = millis();
          return x;
    on_value:
      - lambda: |- 
          // Reset all filters to muted
          lv_obj_remove_style(id(lbl_nina3_filter_l), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_l), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_l), (lv_style_t *)id(style_clr_l), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina3_filter_r), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_r), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_r), (lv_style_t *)id(style_clr_r), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina3_filter_g), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_g), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_g), (lv_style_t *)id(style_clr_g), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina3_filter_b), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_b), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_b), (lv_style_t *)id(style_clr_b), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina3_filter_sii), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_sii), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_sii), (lv_style_t *)id(style_clr_sii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina3_filter_ha), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_ha), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_ha), (lv_style_t *)id(style_clr_ha), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          lv_obj_remove_style(id(lbl_nina3_filter_oiii), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_oiii), (lv_style_t *)id(style_filter_muted), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          lv_obj_add_style(id(lbl_nina3_filter_oiii), (lv_style_t *)id(style_clr_oiii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          
          // Activate the current filter
          std::string filter = x.c_str();
          if (filter == "L" || filter == "Lum" || filter == "Luminance") {
            lv_obj_remove_style(id(lbl_nina3_filter_l), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_l), (lv_style_t *)id(style_filter_active_l), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_l), (lv_style_t *)id(style_clr_l), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "R" || filter == "Red") {
            lv_obj_remove_style(id(lbl_nina3_filter_r), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_r), (lv_style_t *)id(style_filter_active_r), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_r), (lv_style_t *)id(style_clr_r), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "G" || filter == "Green") {
            lv_obj_remove_style(id(lbl_nina3_filter_g), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_g), (lv_style_t *)id(style_filter_active_g), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_g), (lv_style_t *)id(style_clr_g), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "B" || filter == "Blue") {
            lv_obj_remove_style(id(lbl_nina3_filter_b), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_b), (lv_style_t *)id(style_filter_active_b), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_b), (lv_style_t *)id(style_clr_b), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "Ha" || filter == "H-Alpha" || filter == "Halpha") {
            lv_obj_remove_style(id(lbl_nina3_filter_ha), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_ha), (lv_style_t *)id(style_filter_active_ha), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_ha), (lv_style_t *)id(style_clr_ha), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "Oiii" || filter == "OIII" || filter == "O-III") {
            lv_obj_remove_style(id(lbl_nina3_filter_oiii), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_oiii), (lv_style_t *)id(style_filter_active_oiii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_oiii), (lv_style_t *)id(style_clr_oiii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          } else if (filter == "Sii" || filter == "SII" || filter.find("ii") != std::string::npos) {
            lv_obj_remove_style(id(lbl_nina3_filter_sii), NULL, (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_sii), (lv_style_t *)id(style_filter_active_sii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
            lv_obj_add_style(id(lbl_nina3_filter_sii), (lv_style_t *)id(style_clr_sii), (lv_part_t)(LV_PART_MAIN | LV_STATE_DEFAULT));
          }
  - platform: homeassistant
    id: nina3_target
    entity_id: sensor.nina3_target_name
    on_value:
      - lambda: |- 
          lv_label_set_text(id(lbl_nina3_target), x.c_str());

  # ==================== PLANT NAME TEXT SENSORS ====================
  # Plant 1: Spider Plant
  - platform: homeassistant
    id: plant_spider_name
    entity_id: plant.spider_plant
    attribute: friendly_name
    on_value:
      - lambda: lv_label_set_text(id(lbl_name_spider), x.c_str());

  # Plant 2: Jade Plant
  - platform: homeassistant
    id: plant_jade_name
    entity_id: plant.jade_plant
    attribute: friendly_name
    on_value:
      - lambda: lv_label_set_text(id(lbl_name_jade), x.c_str());

  # Plant 3: Elephant Ears
  - platform: homeassistant
    id: plant_elephant_name
    entity_id: plant.elephant_ears
    attribute: friendly_name
    on_value:
      - lambda: lv_label_set_text(id(lbl_name_elephant), x.c_str());

  # Plant 4: Begonia
  - platform: homeassistant
    id: plant_begonia_name
    entity_id: plant.begonia
    attribute: friendly_name
    on_value:
      - lambda: lv_label_set_text(id(lbl_name_begonia), x.c_str());

  # Plant 5: Nerve Plant
  - platform: homeassistant
    id: plant_nerve_name
    entity_id: plant.nerve_plant
    attribute: friendly_name
    on_value:
      - lambda: lv_label_set_text(id(lbl_name_nerve), x.c_str());

  # Plant 6: Pothos
  - platform: homeassistant
    id: plant_pothos_name
    entity_id: plant.pothos
    attribute: friendly_name
    on_value:
      - lambda: lv_label_set_text(id(lbl_name_pothos), x.c_str());

  # Plant 7: Croton
  - platform: homeassistant
    id: plant_croton_name
    entity_id: plant.croton
    attribute: friendly_name
    on_value:
      - lambda: lv_label_set_text(id(lbl_name_croton), x.c_str());

  # Plant 8: Aglaonema
  - platform: homeassistant
    id: plant_aglaonema_name
    entity_id: plant.aglaonema
    attribute: friendly_name
    on_value:
      - lambda: lv_label_set_text(id(lbl_name_aglaonema), x.c_str());

  # Plant 9: Monstera
  - platform: homeassistant
    id: plant_monstera_name
    entity_id: plant.monstera
    attribute: friendly_name
    on_value:
      - lambda: lv_label_set_text(id(lbl_name_monstera), x.c_str());

  - platform: homeassistant
    id: ha_heater
    entity_id: sensor.allskypi5_as_dewcontrolheater
    on_value:
      - if:
          condition: { lambda: 'return x == "True" || x == "true";' }
          then: [ lvgl.obj.update: { id: ind_heater_dot, bg_color: 0xFF4500, bg_opa: COVER } ]
          else: [ lvgl.obj.update: { id: ind_heater_dot, bg_color: 0x444444, bg_opa: 50% } ]

  - platform: homeassistant
    id: ha_enclosure_fan
    entity_id: sensor.allsky_fan
    on_value:
      - if:
          condition: { lambda: 'return x == "True" || x == "true";' }
          then: [ lvgl.obj.update: { id: ind_fan_dot, bg_color: 0x0EA5E9, bg_opa: COVER } ]
          else: [ lvgl.obj.update: { id: ind_fan_dot, bg_color: 0x444444, bg_opa: 50% } ]

  # ==================== PLANT SENSORS - MOISTURE STATUS ====================
  # Plant 1: Spider Plant
  - platform: homeassistant
    id: plant_spider_state
    entity_id: plant.spider_plant
    attribute: moisture_status
    on_value:
      - lambda: |-
          std::string moisture = x;
          lv_color_t accent_color, text_color;
          
          if (moisture == "High") {
            accent_color = lv_color_hex(0xF59E0B);  // Amber
            text_color = lv_color_hex(0xF59E0B);
          } else if (moisture == "Low") {
            accent_color = lv_color_hex(0xEF4444);  // Red
            text_color = lv_color_hex(0xEF4444);
          } else {
            accent_color = lv_color_hex(0x3B82F6);  // Blue
            text_color = lv_color_hex(0x3B82F6);
          }
          
          lv_obj_set_style_bg_color(id(accent_spider), accent_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_status_spider), text_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_icon_spider), text_color, LV_PART_MAIN);
          lv_label_set_text(id(lbl_status_spider), moisture.c_str());

  # Plant 2: Jade Plant
  - platform: homeassistant
    id: plant_jade_state
    entity_id: plant.jade_plant
    attribute: moisture_status
    on_value:
      - lambda: |-
          std::string moisture = x;
          lv_color_t accent_color, text_color;
          
          if (moisture == "High") {
            accent_color = lv_color_hex(0xF59E0B);
            text_color = lv_color_hex(0xF59E0B);
          } else if (moisture == "Low") {
            accent_color = lv_color_hex(0xEF4444);
            text_color = lv_color_hex(0xEF4444);
          } else {
            accent_color = lv_color_hex(0x3B82F6);
            text_color = lv_color_hex(0x3B82F6);
          }
          
          lv_obj_set_style_bg_color(id(accent_jade), accent_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_status_jade), text_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_icon_jade), text_color, LV_PART_MAIN);
          lv_label_set_text(id(lbl_status_jade), moisture.c_str());

  # Plant 3: Elephant Ears
  - platform: homeassistant
    id: plant_elephant_state
    entity_id: plant.elephant_ears
    attribute: moisture_status
    on_value:
      - lambda: |-
          std::string moisture = x;
          lv_color_t accent_color, text_color;
          
          if (moisture == "High") {
            accent_color = lv_color_hex(0xF59E0B);
            text_color = lv_color_hex(0xF59E0B);
          } else if (moisture == "Low") {
            accent_color = lv_color_hex(0xEF4444);
            text_color = lv_color_hex(0xEF4444);
          } else {
            accent_color = lv_color_hex(0x3B82F6);
            text_color = lv_color_hex(0x3B82F6);
          }
          
          lv_obj_set_style_bg_color(id(accent_elephant), accent_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_status_elephant), text_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_icon_elephant), text_color, LV_PART_MAIN);
          lv_label_set_text(id(lbl_status_elephant), moisture.c_str());

  # Plant 4: Begonia
  - platform: homeassistant
    id: plant_begonia_state
    entity_id: plant.begonia
    attribute: moisture_status
    on_value:
      - lambda: |-
          std::string moisture = x;
          lv_color_t accent_color, text_color;
          
          if (moisture == "High") {
            accent_color = lv_color_hex(0xF59E0B);
            text_color = lv_color_hex(0xF59E0B);
          } else if (moisture == "Low") {
            accent_color = lv_color_hex(0xEF4444);
            text_color = lv_color_hex(0xEF4444);
          } else {
            accent_color = lv_color_hex(0x3B82F6);
            text_color = lv_color_hex(0x3B82F6);
          }
          
          lv_obj_set_style_bg_color(id(accent_begonia), accent_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_status_begonia), text_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_icon_begonia), text_color, LV_PART_MAIN);
          lv_label_set_text(id(lbl_status_begonia), moisture.c_str());

  # Plant 5: Nerve Plant
  - platform: homeassistant
    id: plant_nerve_state
    entity_id: plant.nerve_plant
    attribute: moisture_status
    on_value:
      - lambda: |-
          std::string moisture = x;
          lv_color_t accent_color, text_color;
          
          if (moisture == "High") {
            accent_color = lv_color_hex(0xF59E0B);
            text_color = lv_color_hex(0xF59E0B);
          } else if (moisture == "Low") {
            accent_color = lv_color_hex(0xEF4444);
            text_color = lv_color_hex(0xEF4444);
          } else {
            accent_color = lv_color_hex(0x3B82F6);
            text_color = lv_color_hex(0x3B82F6);
          }
          
          lv_obj_set_style_bg_color(id(accent_nerve), accent_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_status_nerve), text_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_icon_nerve), text_color, LV_PART_MAIN);
          lv_label_set_text(id(lbl_status_nerve), moisture.c_str());

  # Plant 6: Pothos
  - platform: homeassistant
    id: plant_pothos_state
    entity_id: plant.pothos
    attribute: moisture_status
    on_value:
      - lambda: |-
          std::string moisture = x;
          lv_color_t accent_color, text_color;
          
          if (moisture == "High") {
            accent_color = lv_color_hex(0xF59E0B);
            text_color = lv_color_hex(0xF59E0B);
          } else if (moisture == "Low") {
            accent_color = lv_color_hex(0xEF4444);
            text_color = lv_color_hex(0xEF4444);
          } else {
            accent_color = lv_color_hex(0x3B82F6);
            text_color = lv_color_hex(0x3B82F6);
          }
          
          lv_obj_set_style_bg_color(id(accent_pothos), accent_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_status_pothos), text_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_icon_pothos), text_color, LV_PART_MAIN);
          lv_label_set_text(id(lbl_status_pothos), moisture.c_str());

  # Plant 7: Croton
  - platform: homeassistant
    id: plant_croton_state
    entity_id: plant.croton
    attribute: moisture_status
    on_value:
      - lambda: |-
          std::string moisture = x;
          lv_color_t accent_color, text_color;
          
          if (moisture == "High") {
            accent_color = lv_color_hex(0xF59E0B);
            text_color = lv_color_hex(0xF59E0B);
          } else if (moisture == "Low") {
            accent_color = lv_color_hex(0xEF4444);
            text_color = lv_color_hex(0xEF4444);
          } else {
            accent_color = lv_color_hex(0x3B82F6);
            text_color = lv_color_hex(0x3B82F6);
          }
          
          lv_obj_set_style_bg_color(id(accent_croton), accent_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_status_croton), text_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_icon_croton), text_color, LV_PART_MAIN);
          lv_label_set_text(id(lbl_status_croton), moisture.c_str());

  # Plant 8: Aglaonema
  - platform: homeassistant
    id: plant_aglaonema_state
    entity_id: plant.aglaonema
    attribute: moisture_status
    on_value:
      - lambda: |-
          std::string moisture = x;
          lv_color_t accent_color, text_color;
          
          if (moisture == "High") {
            accent_color = lv_color_hex(0xF59E0B);
            text_color = lv_color_hex(0xF59E0B);
          } else if (moisture == "Low") {
            accent_color = lv_color_hex(0xEF4444);
            text_color = lv_color_hex(0xEF4444);
          } else {
            accent_color = lv_color_hex(0x3B82F6);
            text_color = lv_color_hex(0x3B82F6);
          }
          
          lv_obj_set_style_bg_color(id(accent_aglaonema), accent_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_status_aglaonema), text_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_icon_aglaonema), text_color, LV_PART_MAIN);
          lv_label_set_text(id(lbl_status_aglaonema), moisture.c_str());

  # Plant 9: Monstera
  - platform: homeassistant
    id: plant_monstera_state
    entity_id: plant.monstera
    attribute: moisture_status
    on_value:
      - lambda: |-
          std::string moisture = x;
          lv_color_t accent_color, text_color;
          
          if (moisture == "High") {
            accent_color = lv_color_hex(0xF59E0B);
            text_color = lv_color_hex(0xF59E0B);
          } else if (moisture == "Low") {
            accent_color = lv_color_hex(0xEF4444);
            text_color = lv_color_hex(0xEF4444);
          } else {
            accent_color = lv_color_hex(0x3B82F6);
            text_color = lv_color_hex(0x3B82F6);
          }
          
          lv_obj_set_style_bg_color(id(accent_monstera), accent_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_status_monstera), text_color, LV_PART_MAIN);
          lv_obj_set_style_text_color(id(lbl_icon_monstera), text_color, LV_PART_MAIN);
          lv_label_set_text(id(lbl_status_monstera), moisture.c_str());
  # ==================== PLANT SENSORS - DETAILED METRICS ====================
  # Monstera - Moisture, Temperature, Humidity, Battery
  - platform: homeassistant
    id: monstera_moisture
    entity_id: plant.monstera
    attribute: moisture
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_moist_monstera), "M:%d%%", val);'
  
  - platform: homeassistant
    id: monstera_temp
    entity_id: plant.monstera
    attribute: temperature
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_temp_monstera), "%d°", val);'
  
  - platform: homeassistant
    id: monstera_battery
    entity_id: sensor.monstera_battery
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_batt_monstera), "B:%d%%", val);'

  # Pothos - Moisture, Temperature, Humidity (no battery sensor listed)
  - platform: homeassistant
    id: pothos_moisture
    entity_id: plant.pothos
    attribute: moisture
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_moist_pothos), "M:%d%%", val);'
  
  - platform: homeassistant
    id: pothos_temp
    entity_id: plant.pothos
    attribute: temperature
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_temp_pothos), "%d°", val);'

  # Begonia - Moisture, Temperature, Humidity, Battery
  - platform: homeassistant
    id: begonia_moisture
    entity_id: plant.begonia
    attribute: moisture
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_moist_begonia), "M:%d%%", val);'
  
  - platform: homeassistant
    id: begonia_temp
    entity_id: plant.begonia
    attribute: temperature
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_temp_begonia), "%d°", val);'
  
  - platform: homeassistant
    id: begonia_battery
    entity_id: sensor.fuchsia_right_battery
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_batt_begonia), "B:%d%%", val);'

  # Jade Plant - Moisture, Temperature, Humidity, Battery
  - platform: homeassistant
    id: jade_moisture
    entity_id: plant.jade_plant
    attribute: moisture
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_moist_jade), "M:%d%%", val);'
  
  - platform: homeassistant
    id: jade_temp
    entity_id: plant.jade_plant
    attribute: temperature
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_temp_jade), "%d°", val);'
  
  - platform: homeassistant
    id: jade_battery
    entity_id: sensor.cactus_battery
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_batt_jade), "B:%d%%", val);'

  # Nerve Plant - Moisture, Temperature, Humidity, Battery
  - platform: homeassistant
    id: nerve_moisture
    entity_id: plant.nerve_plant
    attribute: moisture
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_moist_nerve), "M:%d%%", val);'
  
  - platform: homeassistant
    id: nerve_temp
    entity_id: plant.nerve_plant
    attribute: temperature
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_temp_nerve), "%d°", val);'
  
  - platform: homeassistant
    id: nerve_battery
    entity_id: sensor.fuchsia_left_battery
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_batt_nerve), "B:%d%%", val);'

  # Elephant Ears - Moisture, Temperature, Humidity, Battery
  - platform: homeassistant
    id: elephant_moisture
    entity_id: plant.elephant_ears
    attribute: moisture
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_moist_elephant), "M:%d%%", val);'
  
  - platform: homeassistant
    id: elephant_temp
    entity_id: plant.elephant_ears
    attribute: temperature
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_temp_elephant), "%d°", val);'
  
  - platform: homeassistant
    id: elephant_battery
    entity_id: sensor.elephant_ears_battery
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_batt_elephant), "B:%d%%", val);'

  # Aglaonema - Moisture, Temperature, Humidity, Battery
  - platform: homeassistant
    id: aglaonema_moisture
    entity_id: plant.aglaonema
    attribute: moisture
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_moist_aglaonema), "M:%d%%", val);'
  
  - platform: homeassistant
    id: aglaonema_temp
    entity_id: plant.aglaonema
    attribute: temperature
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_temp_aglaonema), "%d°", val);'
  
  - platform: homeassistant
    id: aglaonema_battery
    entity_id: sensor.aglaonema_battery
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_batt_aglaonema), "B:%d%%", val);'

  # Croton - Moisture, Temperature, Humidity, Battery
  - platform: homeassistant
    id: croton_moisture
    entity_id: plant.croton
    attribute: moisture
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_moist_croton), "M:%d%%", val);'
  
  - platform: homeassistant
    id: croton_temp
    entity_id: plant.croton
    attribute: temperature
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_temp_croton), "%d°", val);'
  
  - platform: homeassistant
    id: croton_battery
    entity_id: sensor.croton_battery
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_batt_croton), "B:%d%%", val);'

  # Spider Plant - Moisture, Temperature, Humidity (no battery sensor listed)
  - platform: homeassistant
    id: spider_moisture
    entity_id: plant.spider_plant
    attribute: moisture
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_moist_spider), "M:%d%%", val);'
  
  - platform: homeassistant
    id: spider_temp
    entity_id: plant.spider_plant
    attribute: temperature
    on_value:
      - lambda: 'int val = atoi(x.c_str()); lv_label_set_text_fmt(id(lbl_temp_spider), "%d°", val);'