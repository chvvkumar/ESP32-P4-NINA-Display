Here are the precise instructions for an AI agent (or a human developer) to implement the "Modern Bento XL" layout in LVGL, followed by the actual C code implementation.

Agent Implementation Instructions
Project Context:

Platform: ESP32-P4 with LVGL v8.3/v9.

Display: 720x720 resolution (Square).

Theme: "Modern Bento XL" (Dark Mode, High Contrast, Large Typography).

Data Source: nina_client_t structure (populated from JSON API).

Visual Specification:

Color Palette:

Background: #050505 (Almost Black).

Card Background: #18181b (Zinc-900) with LV_OPA_90 opacity.

Accent (Imaging): #10b981 (Emerald-500).

Accent (Text): #ffffff (White) and #a1a1aa (Zinc-400) for labels.

Typography:

Use the largest available fonts (LV_FONT_MONTSERRAT_48 or 28 scaled up) for primary metrics (Progress, RMS, Temp).

Use smaller, uppercase, tracked-out fonts for labels (e.g., "SEQUENCE PROGRESS").

Layout Grid (Bento):

Use LV_LAYOUT_GRID.

Columns: 2 Equal columns (LV_GRID_FR(1)).

Rows: Header (Content), Imaging Card (Flex), Lower Cards (Equal Flex).

Gap: 20px padding between elements.

Component Requirements:

Header: Display "Active Target" label and the Target Name (e.g., "M31") in large, bold emerald text.

Imaging Card (Span 2): Must span the full width. Include a visual "Progress Bar" at the bottom of the card using a nested lv_obj with partial width.

Metrics Cards:

Guiding: Show Total RMS (Large) and RA/DEC breakdown (Small).

Camera: Show Temperature (Large) and Cooler Power (Small).

Moon: Show Illumination %.

Focuser: Show Position count.

Constraint Checklist:

Do NOT use external image assets (PNG/JPG). Use lv_draw or lv_obj styling (circles/rectangles) to simulate icons to ensure code portability.

Code must be contained in nina_dashboard.c.

Ensure thread safety if updating LVGL from a separate task (use a mutex or dispatcher if applicable, though standard LVGL is not thread-safe without locks).


main/ui/nina_dashboard.c:
/**
 * @file nina_dashboard.c
 * @brief "Modern Bento XL" Layout implementation for 720x720 Displays
 * @version 2.0 (Reimagine)
 */

#include "nina_dashboard.h"
#include "nina_client.h"
#include "lvgl.h"
#include <stdio.h>

/*********************
 * DEFINES
 *********************/
#define COLOR_BG        lv_color_hex(0x050505)
#define COLOR_CARD      lv_color_hex(0x18181b) // Zinc 900
#define COLOR_ACCENT    lv_color_hex(0x10b981) // Emerald 500
#define COLOR_TEXT_MAIN lv_color_hex(0xFFFFFF)
#define COLOR_TEXT_SUB  lv_color_hex(0xa1a1aa) // Zinc 400
#define COLOR_GUIDE     lv_color_hex(0x60a5fa) // Blue 400
#define COLOR_WARN      lv_color_hex(0xfbbf24) // Amber 400
#define COLOR_ERR       lv_color_hex(0xf87171) // Red 400

#define DASH_PAD 20

/*********************
 * OBJECTS
 *********************/
static lv_obj_t * scr_dashboard = NULL;

// Data Labels
static lv_obj_t * lbl_target_name;
static lv_obj_t * lbl_progress_main;
static lv_obj_t * lbl_progress_sub; // Time remaining
static lv_obj_t * lbl_filter;
static lv_obj_t * bar_progress;
static lv_obj_t * lbl_rms_total;
static lv_obj_t * lbl_rms_detail;   // RA / DEC
static lv_obj_t * lbl_cam_temp;
static lv_obj_t * lbl_cam_cooler;
static lv_obj_t * lbl_moon_illum;
static lv_obj_t * lbl_focuser_pos;
static lv_obj_t * lbl_status_pill;

/*********************
 * STYLES
 *********************/
static lv_style_t style_card;
static lv_style_t style_label_sm;
static lv_style_t style_label_xl;
static lv_style_t style_label_xxl;

static void init_styles(void) {
    lv_style_init(&style_card);
    lv_style_set_bg_color(&style_card, COLOR_CARD);
    lv_style_set_bg_opa(&style_card, LV_OPA_90); // Slight transparency
    lv_style_set_radius(&style_card, 30);        // Large rounded corners
    lv_style_set_border_width(&style_card, 1);
    lv_style_set_border_color(&style_card, lv_color_hex(0x27272a)); // Zinc 800
    lv_style_set_pad_all(&style_card, 24);

    lv_style_init(&style_label_sm);
    lv_style_set_text_color(&style_label_sm, COLOR_TEXT_SUB);
    lv_style_set_text_font(&style_label_sm, &lv_font_montserrat_14);
    lv_style_set_text_letter_space(&style_label_sm, 2); // Tracking

    lv_style_init(&style_label_xl);
    lv_style_set_text_color(&style_label_xl, COLOR_TEXT_MAIN);
    // Use largest available font, fallback to 14 scaled if needed, but assuming 28+ is avail
#ifdef LV_FONT_MONTSERRAT_28
    lv_style_set_text_font(&style_label_xl, &lv_font_montserrat_28);
#else
    lv_style_set_text_font(&style_label_xl, &lv_font_montserrat_14);
#endif

    lv_style_init(&style_label_xxl);
    lv_style_set_text_color(&style_label_xxl, COLOR_TEXT_MAIN);
    // Ideally use Montserrat 48 if enabled in menuconfig
#ifdef LV_FONT_MONTSERRAT_48
    lv_style_set_text_font(&style_label_xxl, &lv_font_montserrat_48);
#elif defined(LV_FONT_MONTSERRAT_28)
    lv_style_set_text_font(&style_label_xxl, &lv_font_montserrat_28);
    // We will simulate larger text by scaling in the object if needed, 
    // but styles don't support transform_zoom directly in v8 without flag
#else
    lv_style_set_text_font(&style_label_xxl, &lv_font_montserrat_14);
#endif
}

/**
 * @brief Helper to create a standard "Pod" container
 */
static lv_obj_t* create_pod(lv_obj_t * parent) {
    lv_obj_t * pod = lv_obj_create(parent);
    lv_obj_remove_style_all(pod);
    lv_obj_add_style(pod, &style_card, 0);
    lv_obj_set_size(pod, LV_PCT(100), LV_PCT(100)); // Fill grid cell
    return pod;
}

/**
 * @brief Helper to create a label with specific text and style
 */
static lv_obj_t* create_header_label(lv_obj_t * parent, const char * text) {
    lv_obj_t * label = lv_label_create(parent);
    lv_obj_add_style(label, &style_label_sm, 0);
    lv_label_set_text(label, text);
    return label;
}

void create_nina_dashboard(lv_obj_t * parent) {
    init_styles();
    scr_dashboard = parent;
    
    // Main Container
    lv_obj_t * main_cont = lv_obj_create(scr_dashboard);
    lv_obj_remove_style_all(main_cont);
    lv_obj_set_size(main_cont, LV_PCT(100), LV_PCT(100));
    lv_obj_set_style_bg_color(main_cont, COLOR_BG, 0);
    lv_obj_set_style_bg_opa(main_cont, LV_OPA_COVER, 0);
    lv_obj_set_style_pad_all(main_cont, DASH_PAD * 1.5, 0);

    // Setup Grid
    static lv_coord_t col_dsc[] = {LV_GRID_FR(1), LV_GRID_FR(1), LV_GRID_TEMPLATE_LAST};
    static lv_coord_t row_dsc[] = {
        LV_GRID_CONTENT, /* Header */
        LV_GRID_FR(2),   /* Imaging Card (Tall) */
        LV_GRID_FR(1.5), /* Info Cards Row 1 */
        LV_GRID_FR(1.5), /* Info Cards Row 2 */
        LV_GRID_TEMPLATE_LAST
    };
    lv_obj_set_layout(main_cont, LV_LAYOUT_GRID);
    lv_obj_set_grid_dsc_array(main_cont, col_dsc, row_dsc);

    /* ---------------- HEADER ---------------- */
    lv_obj_t * header_cont = lv_obj_create(main_cont);
    lv_obj_remove_style_all(header_cont);
    lv_obj_set_grid_cell(header_cont, LV_GRID_ALIGN_STRETCH, 0, 2, LV_GRID_ALIGN_START, 0, 1);
    lv_obj_set_height(header_cont, LV_SIZE_CONTENT);
    lv_obj_set_flex_flow(header_cont, LV_FLEX_FLOW_COLUMN);
    
    lv_obj_t * lbl_h_title = lv_label_create(header_cont);
    lv_obj_add_style(lbl_h_title, &style_label_sm, 0);
    lv_label_set_text(lbl_h_title, "ACTIVE TARGET");

    lbl_target_name = lv_label_create(header_cont);
    lv_obj_add_style(lbl_target_name, &style_label_xxl, 0);
    lv_obj_set_style_text_color(lbl_target_name, COLOR_ACCENT, 0);
    lv_label_set_text(lbl_target_name, "N/A"); // Default

    /* ---------------- IMAGING POD (Span 2) ---------------- */
    lv_obj_t * pod_imaging = create_pod(main_cont);
    lv_obj_set_grid_cell(pod_imaging, LV_GRID_ALIGN_STRETCH, 0, 2, LV_GRID_ALIGN_STRETCH, 1, 1);
    // Specific styling for imaging pod
    lv_obj_set_style_bg_grad_color(pod_imaging, lv_color_hex(0x064e3b), 0); // Dark Emerald
    lv_obj_set_style_bg_grad_dir(pod_imaging, LV_GRAD_DIR_VER, 0);
    lv_obj_set_style_border_color(pod_imaging, lv_color_hex(0x065f46), 0);

    // Pill Status Top Right
    lbl_status_pill = lv_label_create(pod_imaging);
    lv_obj_set_style_bg_color(lbl_status_pill, COLOR_ACCENT, 0);
    lv_obj_set_style_bg_opa(lbl_status_pill, LV_OPA_20, 0);
    lv_obj_set_style_pad_hor(lbl_status_pill, 12, 0);
    lv_obj_set_style_pad_ver(lbl_status_pill, 4, 0);
    lv_obj_set_style_radius(lbl_status_pill, 8, 0);
    lv_obj_set_style_text_color(lbl_status_pill, COLOR_ACCENT, 0);
    lv_obj_set_style_text_font(lbl_status_pill, &lv_font_montserrat_14, 0);
    lv_obj_align(lbl_status_pill, LV_ALIGN_TOP_RIGHT, 0, 0);
    lv_label_set_text(lbl_status_pill, "IDLE");

    // Main Progress Center
    lv_obj_t * cont_prog = lv_obj_create(pod_imaging);
    lv_obj_remove_style_all(cont_prog);
    lv_obj_set_size(cont_prog, LV_SIZE_CONTENT, LV_SIZE_CONTENT);
    lv_obj_align(cont_prog, LV_ALIGN_LEFT_MID, 0, -10);
    lv_obj_set_flex_flow(cont_prog, LV_FLEX_FLOW_COLUMN);
    
    lv_obj_t * lbl_seq = create_header_label(cont_prog, "SEQUENCE PROGRESS");
    lv_obj_set_style_text_color(lbl_seq, COLOR_ACCENT, 0);

    lbl_progress_main = lv_label_create(cont_prog);
    lv_obj_add_style(lbl_progress_main, &style_label_xxl, 0);
    // Fake larger font if needed by zooming
    // lv_obj_set_style_transform_zoom(lbl_progress_main, 512, 0); // 2x zoom
    lv_label_set_text(lbl_progress_main, "-- / --");
    
    lbl_progress_sub = lv_label_create(cont_prog);
    lv_obj_add_style(lbl_progress_sub, &style_label_xl, 0);
    lv_obj_set_style_text_color(lbl_progress_sub, COLOR_TEXT_SUB, 0);
    lv_label_set_text(lbl_progress_sub, "--:-- Remaining");

    // Filter Info Bottom Right
    lbl_filter = lv_label_create(pod_imaging);
    lv_obj_add_style(lbl_filter, &style_label_sm, 0);
    lv_obj_align(lbl_filter, LV_ALIGN_BOTTOM_RIGHT, 0, 0);
    lv_label_set_text(lbl_filter, "No Filter");

    // Progress Bar (Bottom Edge)
    bar_progress = lv_obj_create(pod_imaging);
    lv_obj_remove_style_all(bar_progress);
    lv_obj_set_size(bar_progress, 0, 6); // Width set dynamically
    lv_obj_set_style_bg_color(bar_progress, COLOR_ACCENT, 0);
    lv_obj_set_style_bg_opa(bar_progress, LV_OPA_COVER, 0);
    lv_obj_align(bar_progress, LV_ALIGN_BOTTOM_LEFT, -24, 24); // Account for pad

    /* ---------------- GUIDING POD ---------------- */
    lv_obj_t * pod_guide = create_pod(main_cont);
    lv_obj_set_grid_cell(pod_guide, LV_GRID_ALIGN_STRETCH, 0, 1, LV_GRID_ALIGN_STRETCH, 2, 1);
    
    create_header_label(pod_guide, "PHD2 RMS");
    
    lbl_rms_total = lv_label_create(pod_guide);
    lv_obj_add_style(lbl_rms_total, &style_label_xl, 0); // Should be larger
    lv_obj_set_style_text_color(lbl_rms_total, COLOR_GUIDE, 0);
    lv_obj_align(lbl_rms_total, LV_ALIGN_CENTER, 0, -10);
    lv_label_set_text(lbl_rms_total, "--.--\"");

    lbl_rms_detail = lv_label_create(pod_guide);
    lv_obj_add_style(lbl_rms_detail, &style_label_sm, 0);
    lv_obj_align(lbl_rms_detail, LV_ALIGN_BOTTOM_MID, 0, 0);
    lv_label_set_text(lbl_rms_detail, "RA: -- DEC: --");

    /* ---------------- CAMERA POD ---------------- */
    lv_obj_t * pod_cam = create_pod(main_cont);
    lv_obj_set_grid_cell(pod_cam, LV_GRID_ALIGN_STRETCH, 1, 1, LV_GRID_ALIGN_STRETCH, 2, 1);

    create_header_label(pod_cam, "SENSOR");

    lbl_cam_temp = lv_label_create(pod_cam);
    lv_obj_add_style(lbl_cam_temp, &style_label_xl, 0);
    lv_obj_set_style_text_color(lbl_cam_temp, lv_color_hex(0x818cf8), 0); // Indigo
    lv_obj_align(lbl_cam_temp, LV_ALIGN_CENTER, 0, -10);
    lv_label_set_text(lbl_cam_temp, "-- C");

    lbl_cam_cooler = lv_label_create(pod_cam);
    lv_obj_add_style(lbl_cam_cooler, &style_label_sm, 0);
    lv_obj_align(lbl_cam_cooler, LV_ALIGN_BOTTOM_MID, 0, 0);
    lv_label_set_text(lbl_cam_cooler, "Pwr: --%");

    /* ---------------- MOON POD ---------------- */
    lv_obj_t * pod_moon = create_pod(main_cont);
    lv_obj_set_grid_cell(pod_moon, LV_GRID_ALIGN_STRETCH, 0, 1, LV_GRID_ALIGN_STRETCH, 3, 1);
    
    create_header_label(pod_moon, "MOON ILLUM");

    lbl_moon_illum = lv_label_create(pod_moon);
    lv_obj_add_style(lbl_moon_illum, &style_label_xl, 0);
    lv_obj_align(lbl_moon_illum, LV_ALIGN_CENTER, 0, 0);
    lv_label_set_text(lbl_moon_illum, "--%");

    /* ---------------- FOCUSER POD ---------------- */
    lv_obj_t * pod_focus = create_pod(main_cont);
    lv_obj_set_grid_cell(pod_focus, LV_GRID_ALIGN_STRETCH, 1, 1, LV_GRID_ALIGN_STRETCH, 3, 1);

    create_header_label(pod_focus, "FOCUSER");

    lbl_focuser_pos = lv_label_create(pod_focus);
    lv_obj_add_style(lbl_focuser_pos, &style_label_xl, 0);
    lv_obj_set_style_text_color(lbl_focuser_pos, lv_color_hex(0xfb923c), 0); // Orange
    lv_obj_align(lbl_focuser_pos, LV_ALIGN_CENTER, 0, 0);
    lv_label_set_text(lbl_focuser_pos, "-----");

}

/**
 * @brief Update the Dashboard with new data from NINA client
 */
void update_nina_dashboard_ui(const nina_client_t *data) {
    if (!scr_dashboard || !data) return;

    // 1. Target & Status
    if (data->status) {
        lv_label_set_text(lbl_status_pill, data->status);
        if (strcmp(data->status, "IMAGING") == 0) {
            lv_obj_set_style_text_color(lbl_status_pill, COLOR_ACCENT, 0);
        } else {
            lv_obj_set_style_text_color(lbl_status_pill, COLOR_WARN, 0);
        }
    }
    
    // We assume data has a target field (add to struct if missing, for now use status/placeholder)
    // Note: nina_client_t struct definition might need expansion based on JSON
    // Mapping available fields based on provided files:
    
    // 2. Camera
    if (data->camera.temp > -273) // clear logic check
        lv_label_set_text_fmt(lbl_cam_temp, "%.1f C", data->camera.temp);
    
    lv_label_set_text_fmt(lbl_cam_cooler, "Pwr: %.0f%%", data->camera.cooler_power);

    // 3. Guider
    lv_label_set_text_fmt(lbl_rms_total, "%.2f\"", data->guider.rms_total);
    // Detail not in basic struct, assume placeholders or expand struct
    // lv_label_set_text_fmt(lbl_rms_detail, "RA: %.2f DEC: %.2f", data->guider.rms_ra, data->guider.rms_dec);

    // 4. Focuser
    lv_label_set_text_fmt(lbl_focuser_pos, "%d", data->focuser.position);

    // 5. Imaging / Sequence (Assuming struct expansion for full layout)
    // If these fields aren't in `nina_client_t`, you must add them or they won't update.
    // Simulating mapping:
    // lv_label_set_text(lbl_target_name, data->imaging.target_name);
    // lv_label_set_text_fmt(lbl_progress_main, "%d / %d", data->imaging.current, data->imaging.total);
    
    // Update Progress Bar Width
    // int pct = (data->imaging.current * 100) / data->imaging.total;
    // lv_obj_set_width(bar_progress, LV_PCT(pct));
}

main/ui/nina_dashboard.h:
#ifndef NINA_DASHBOARD_H
#define NINA_DASHBOARD_H

#ifdef __cplusplus
extern "C" {
#endif

#include "lvgl.h"
#include "nina_client.h"

/**
 * @brief Initialize the Modern Bento XL Dashboard
 * @param parent The parent LVGL object (usually the screen)
 */
void create_nina_dashboard(lv_obj_t * parent);

/**
 * @brief Update the dashboard metrics
 * @param data Pointer to the latest NINA client data
 */
void update_nina_dashboard_ui(const nina_client_t *data);

#ifdef __cplusplus
}
#endif

#endif // NINA_DASHBOARD_H